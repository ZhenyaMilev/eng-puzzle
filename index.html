<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8">
  <title>Мій словник</title>
  <!-- Мета-теги для адаптивності та заборона масштабування -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <!-- Підключення шрифтів Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Стилизування додатку -->
  <style>
    /* Прелоадер */
    #page-preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(139, 198, 236, 1), rgba(139, 198, 236, 1));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    #page-preloader.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .preloader-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .preloader-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .preloader-text {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    /* Загальні стилі */
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      background-color: #fafafa;
      color: #333;
      overflow-x: hidden;
      background: linear-gradient(90deg, rgba(139, 198, 236, 1), rgba(139, 198, 236, 1));
    }

    /* Адаптивный попап на весь экран */
    #progressPopup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .hidden {
      display: none;
    }

    .training-title-desc {
      font-weight: 600;
      margin-bottom: 10px;
      margin-top: 0;
    }

    .training-title-desc + .description {
      text-align: left;
      margin-top: 0;
      margin-bottom: 30px;
      line-height: 130%;
    }

    #progressPopup .title-and-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    #progressPopup .title-and-btn h2 {
      position: static;
      transform: none;
      font-size: 22px;
      font-weight: 600;
      color: #333;
      flex: 1;
      text-align: center;
      margin: 0;
    }

    .date-range {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .tile-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 15px 0;
    }

    .tile {
      border-radius: 16px;
      padding: 18px 15px;
      position: relative;
      text-align: center;
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .tile:active {
      transform: scale(0.95);
    }

    .tile-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .tile p {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      opacity: 0.9;
    }

    .tile span {
      display: block;
      font-size: 32px;
      font-weight: bold;
      margin-top: 5px;
    }

    .tile-new {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .tile-new .tile-icon { color: #FFD700; }

    .tile-good {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .tile-good .tile-icon { color: #FFD700; }

    .tile-average {
      background: linear-gradient(135deg, #F2994A 0%, #F2C94C 100%);
      color: white;
    }

    .tile-average .tile-icon { color: white; }

    .tile-poor {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }

    .tile-poor .tile-icon { color: white; }

    .info-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
    }


    .algorithm-block ol {
      line-height: 130%;
      text-align: left;
      margin-bottom: 0;
    }

    .algorithm-block ol li {
      margin-bottom: 6px;
    }

    .fas.fa-info-circle {
      font-size: 34px;
    }

    .algorithm-block {
      background-color: #E0F7FA;
      border-left: 6px solid #37474F;
      padding: 10px;
      border-radius: 8px;
      margin-top: 0;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .algorithm-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .algorithm-header p {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
    }

    .algorithm-chevron {
      transition: transform 0.3s ease;
      font-size: 14px;
      color: #37474F;
    }

    .algorithm-block.open .algorithm-chevron {
      transform: rotate(180deg);
    }

    .algorithm-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      margin: 0;
      padding-left: 20px;
    }

    .algorithm-block.open .algorithm-content {
      max-height: 300px;
      margin-top: 10px;
    }

    .algorithm-block p {
      margin-bottom: 10px;
      font-size: 16px;
      margin-top: 0;
      font-weight: bold;
    }

    /* Стилі для попапу з поділеними словами */
    #sharedWordsPopup .popup-content {
      max-width: 500px;
      width: 90%;
      margin: 0 auto;
    }

    #sharedWordsPopup h3 {
      margin-bottom: 20px;
      text-align: center;
    }

    #shared-words-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .shared-word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }

    .shared-word-item strong {
      font-size: 1rem;
    }

    .shared-word-item button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .shared-word-item button:hover {
      background-color: #218838;
    }

    .popup-buttons {
      display: flex;
      justify-content: space-between;
    }

    .popup-buttons button {
      flex: 1;
      margin: 0 5px;
    }

    .popup-buttons .close-button {
      background-color: #dc3545;
    }

    .popup-buttons .close-button:hover {
      background-color: #c82333;
    }


    .option-menu {
      position: absolute;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background-color: #fff;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 1000;
    }

    .option-menu.show {
      right: 0;
    }

    .option-menu-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .option-menu .close-button {
      font-size: 20px;
      background: none;
      border: none;
      cursor: pointer;
      background: gainsboro;
    }

    .option-menu-list li {
      list-style: none;
      margin-bottom: 10px;
    }

    #option-menu-list {
      list-style-type: none;
      padding: 0;
    }

    .option-menu-list button {
      width: 100%;
      padding: 10px;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
    }


    #quiz-emoji.fa-grin-stars {
      color: #FFC107;
    }

    .check-word {
      position: relative;
      font-weight: bold;
      background-color: #D7E9F7;
      border-radius: 12px;
      font-size: 24px;
      color: #324855;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #ukr-to-eng-button,
    #eng-to-ukr-button,
    .generate {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #37474F;
      /* Тёмно-серый текст для хорошей читаемости */
      background-color: #E0F7FA;
      /* Светло-голубой фон */
      border: 2px solid #B2EBF2;
      /* Голубая рамка */
      border-radius: 12px;
      /* Закруглённые углы для мягкости */
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease-in-out, box-shadow 0.2s;
      margin: 10px 0;
      /* Пространство между кнопками */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      /* Лёгкая тень для объёма */
    }

    #ukr-to-eng-button:hover,
    #eng-to-ukr-button:hover,
    .generate:hover {
      background-color: #B2EBF2;
      /* Насыщенный голубой при наведении */
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      /* Увеличенная тень */
      transform: scale(1.02);
      /* Лёгкое увеличение */
    }

    /* Состояние при нажатии */
    #ukr-to-eng-button:active,
    #eng-to-ukr-button:active {
      background-color: #80DEEA;
      /* Более насыщенный голубой при нажатии */
      transform: scale(0.98);
      /* Лёгкое сжатие */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      /* Снижение тени */
    }

    .check-button {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #37474F;
      /* Тёмный текст */
      background-color: #FFFFFF;
      /* Белый фон */
      border: 2px solid #B0BEC5;
      /* Светлая рамка */
      border-radius: 12px;
      /* Закруглённые углы */
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease-in-out, box-shadow 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      /* Лёгкая тень для объёма */
      margin: 10px auto;
      /* Центрируем */
    }

    /* Состояние при наведении */
    .check-button:hover {
      background-color: #F0F4C3;
      /* Нежный светло-зелёный при наведении */
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
      /* Увеличенная тень */
    }

    /* Состояние при нажатии */
    .check-button:active {
      background-color: #DCE775;
      /* Более насыщенный зелёный при нажатии */
      transform: scale(0.98);
      /* Лёгкое уменьшение */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      /* Снижение тени */
    }

    .tal {
      text-align: left;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
        /* Лёгкое увеличение */
      }

      100% {
        transform: scale(1);
      }
    }

    #constructor-feedback.correct-label,
    #constructor-feedback.not-correct-label {
      font-size: 16px;
      /* Читаемый размер текста */
      font-weight: bold;
      /* Мягкий зелёный цвет для позитивной обратной связи */
      text-align: center;
      animation: fadeIn 0.5s ease-in-out, pulse 1s infinite ease-in-out;
      animation: none;
    }

    #constructor-feedback.not-correct-label {
      color: #FF6B6B;
    }

    #constructor-feedback.correct-label {
      color: #4CAF50;
    }

    /* Стиль для виділення слів */
    .highlight {
      font-weight: bold;
      border-bottom: 1px solid;
    }

    #constructor-answer {
      width: 90%;
      margin: 0;
      padding: 18px 0 18px 18px;
      font-size: 18px;
      color: #37474F;
      /* Тёмный серый текст */
      background-color: #F9F9F9;
      /* Лёгкий фон */
      border: 2px solid #B0BEC5;
      /* Светлая рамка */
      border-top-right-radius: 0px;
      border-bottom-right-radius: 0px;
      border-top-left-radius: 10px;
      border-bottom-left-radius: 10px;
      outline: none;
      transition: all 0.3s ease-in-out;
      border-right: none;
    }

    .add-icon {
      background-image: url('https://img.icons8.com/ios-glyphs/30/ffffff/plus.png');
      background-size: contain;
      background-repeat: no-repeat;
      width: 24px;
      height: 24px;
      margin-left: auto;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .add-icon:hover {
      opacity: 0.7;
    }

    .added-word {
      animation: addedWordAnimation 0.5s forwards;
    }

    @keyframes addedWordAnimation {
      0% {
        background-color: #fff;
      }

      50% {
        background-color: #2ecc71;
      }

      100% {
        background-color: #fff;
      }
    }

    /* Стиль для таймера */
    #speed-training-timer {
      font-size: 24px;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Стиль для вопроса и вариантов ответа */
    #speed-training-question button {
      position: relative;
      font-weight: bold;
      background-color: #D7E9F7;
      border-radius: 12px;
      font-size: 24px;
      color: #324855;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #speed-training-question h3 {
      font-size: 26px;
    }

    /* Стили для кнопки озвучивания */
    #speed-training-question .listening-sound-icon {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #37474F;
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px auto;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(55, 71, 79, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #speed-training-question .listening-sound-icon:active {
      transform: scale(0.95);
    }

    #speed-training-question .listening-sound-icon .fa-volume-up {
      font-size: 28px;
      margin: 0;
    }

    /* Підсвітка правильної/неправильної відповіді */
    #speed-training-question button.speed-correct {
      background-color: #c8e6c9 !important;
      border: 2px solid #4CAF50 !important;
      color: #2e7d32 !important;
    }

    #speed-training-question button.speed-incorrect {
      background-color: #ffcdd2 !important;
      border: 2px solid #ef5350 !important;
      color: #c62828 !important;
    }

    /* Фідбек часу +1/-2 сек */
    #speed-training-timer {
      position: relative;
      display: inline-block;
    }

    .speed-time-feedback {
      display: inline-block;
      margin-left: 10px;
      font-size: 18px;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 8px;
      animation: feedbackFade 1.2s ease forwards;
      vertical-align: middle;
    }

    .speed-time-feedback.positive {
      background: #c8e6c9;
      color: #2e7d32;
    }

    .speed-time-feedback.negative {
      background: #ffcdd2;
      color: #c62828;
    }

    @keyframes feedbackFade {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      20% {
        opacity: 1;
        transform: scale(1.1);
      }
      80% {
        opacity: 1;
        transform: scale(1);
      }
      100% {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    /* Стиль для результатов тренировки */
    #speed-training-result {
      text-align: center;
    }

    #speed-training-result img {
      width: 100px;
      height: 100px;
    }

    #speed-training-result p {
      font-size: 18px;
      margin-top: 10px;
    }

    /* Стили для кнопок, у которых data-count не равно 1 */
    /* Применяем стили только для data-count больше 1 */
    .unique-letter-button[data-count]:not([data-count="1"]):not([data-count="0"])::after {
      content: attr(data-count);
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #324855;
      /* Пастельный зелёный */
      color: #fffdfd;
      /* Тёмно-зелёный текст */
      font-size: 14px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      /* Круглый элемент */
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      /* Лёгкая тень */
    }

    .overlay {
      width: 100vw;
      height: 100vh;
      background: #00000096;
      position: absolute;
      z-index: 2;
      backdrop-filter: blur(5px);
    }

    .unique-letter-button {
      position: relative;
      font-weight: bold;
      width: 44px;
      height: 44px;
      background-color: #D7E9F7;
      /* Пастельный голубой */
      border-radius: 12px;
      /* Единые скруглённые углы */
      font-size: 24px;
      color: #324855;
      /* Спокойный зелёный текст */
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      /* Пространство между кнопками */
    }

    .unique-letter-button:hover {
      background-color: #B0D6E5;
      /* Тонкий эффект затемнения */
      transform: scale(1.05);
      /* Лёгкое увеличение */
    }

    .unique-letter-button:active {
      /* Цвет при нажатии */
      transform: scale(0.95);
      /* Эффект нажатия */
      box-shadow: 0 2px 6px rgba(255, 180, 162, 0.4);
      /* Уменьшенная тень */
    }

    /* Стили для disabled состояния */
    .unique-letter-button:disabled {
      opacity: 0.4;
    }

    #word-list #words i {
      margin-right: 10px;
    }

    #listening-quiz-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #quiz-container h3,
    #repetition-quiz-container h3 {
      font-size: 30px;
      margin-top: 30px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      padding-top: 40px;
    }

    h1,
    h2,
    h3 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
    }

    button {
      background-color: #fffdfd;
      color: #000000;
      padding: 14px 10px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 24px;
      cursor: pointer;
      border-radius: 14px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      font-family: 'Montserrat';
      border: none;
      width: 100%;
    }

    button:active {
      transform: translateY(0);
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      padding: 12px;
      margin: 5px 0 15px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
      outline: none;
    }

    .link-button {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      margin-top: 10px;
      font-size: 14px;
      transition: color 0.3s;
    }

    .link-button.register-link {
      font-size: 16px;
      display: block;
      box-shadow: none;
    }

    .link-button:hover {
      color: #2980b9;
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: -10px;
      margin-bottom: 10px;
    }

    .hidden {
      display: none !important;
    }

    /* Стилі для основного екрану облікового запису */
    .menu {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .menu button {
      margin: 5px 0;
      width: 80%;
      max-width: 300px;
      color: #324855;
    }

    @media only screen and (max-width: 768px) {
      .menu button {
        width: 100%;
        max-width: none;
      }
    }

    /* Стилі для списку слів */
    #word-list ul {
      list-style-type: none;
      padding: 0;
    }

    #word-list li {
      background-color: #fff;
      padding: 15px 22px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, opacity 0.3s;
      position: relative;
    }

    #word-list .fa-trash {
      position: absolute;
      top: 50%;
      right: 10px;
      color: coral;
      transform: translate(0, -50%);
    }

    .word-thumbnail {
      width: 45px;
      height: 45px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
      flex-shrink: 0;
    }

    #word-list li.removed {
      opacity: 0;
      transform: scale(0);
      height: 0;
      margin: 0;
      padding: 0;
    }

    #word-list li button {
      width: auto;
      margin-left: auto;
      padding: 5px 10px;
      font-size: 14px;
      background: none;
      border: none;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    #word-list li button:hover {
      opacity: 0.7;
    }

    /* Іконки */
    .delete-icon {
      background-image: url('https://img.icons8.com/ios-glyphs/30/ffffff/trash--v1.png');
      /* Білий колір */
      background-size: contain;
      background-repeat: no-repeat;
      width: 24px;
      height: 24px;
    }

    .sound-icon {
      background-image: url('https://img.icons8.com/ios-glyphs/30/ffffff/speaker.png');
      /* Білий колір */
      background-size: contain;
      background-repeat: no-repeat;
      width: 24px;
      height: 24px;
      margin-right: 10px;
      cursor: pointer;
    }

    /* Кнопка "Назад" */
    .back-button {
      background-color: white;
      box-shadow: none;
      padding: 10px 12px;
      margin: 0;
      width: auto;
      border-radius: 8px;
    }

    .back-button h2 {
      margin: 0;
      font-size: 22px;
      font-weight: normal;
    }

    .back-button span {
      display: none;
    }

    /* Більша кнопка назад в тренуваннях */
    #quiz-section .back-button,
    #picture-quiz-section .back-button,
    #listening-training-section .back-button,
    #word-constructor-training-section .back-button,
    #speed-training-section .back-button,
    #repetition-training-section .back-button,
    #definition-quiz-section .back-button,
    #fill-blanks-section .back-button {
      padding: 14px 16px;
    }

    #quiz-section .back-button i,
    #picture-quiz-section .back-button i,
    #listening-training-section .back-button i,
    #word-constructor-training-section .back-button i,
    #speed-training-section .back-button i,
    #repetition-training-section .back-button i,
    #definition-quiz-section .back-button i,
    #fill-blanks-section .back-button i {
      font-size: 26px;
    }

    .buttons-right-corner {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .buttons-right-corner .fa-star:before {
      color: #FFC107;
    }

    .buttons-right-corner button {
      margin: 0;
      padding: 12px;
    }

    /* Стилі для поля введення на мобільних пристроях */
    @media (max-width: 600px) {
      .container {
        padding: 15px;
        padding-top: 40px;
      }

      button {
        font-size: 20px;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"] {
        padding: 15px;
        font-size: 18px;
      }

      .back-button {
        padding: 10px 12px;
      }

      .back-button i {
        font-size: 22px;
      }

      .title-main {
        flex-wrap: wrap;
      }

      .title-main h1 {
        font-size: 22px;
      }

      .listening-sound-icon {
        width: 80px;
        height: 80px;
      }

      .listening-sound-icon i {
        font-size: 32px;
      }

      .round-btn {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: scale(0);
        height: 0;
        margin: 0;
        padding: 0;
      }
    }

    /* Стиль для сумного котика */
    .add-word-from-my-vocabulary {
      max-width: 100%;
      display: block;
      margin: 20px auto;
      border-radius: 8px;
    }

    .long-button {
      padding: 15px;
      font-size: 14px;
      font-weight: bold;
      color: #37474F;
      background-color: #FFFFFF;
      border: 2px solid #B0BEC5;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease-in-out, box-shadow 0.2s;
      margin: 10px auto;
      width: 100%;
    }

    .user-email:hover {
      color: #2980b9;
    }

    /* Стиль для лічильника слів */
    #word-count {
      text-align: left;
      color: #2c3e50;
    }

    .word-count-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .info-btn-small {
      background: #37474F;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      min-width: 28px;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      margin: 0;
    }

    .info-btn-small i {
      font-size: 14px;
    }

    /* Стиль для привітання */
    #account-screen h2 {
      font-size: 18px;
      text-align: left;
      font-weight: 500;
      margin: 10px 0;
    }

    /* Стиль для повідомлення про підписку */
    .subscription-info {
      text-align: left;
      margin-bottom: 10px;
      font-weight: bold;
      color: #2c3e50;
    }

    /* Кнопка "Оплатити" */
    .pay-button {
      padding: 12px 20px;
      margin-top: 10px;
      width: 100%;
      background-color: #27ae60;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .pay-button:hover {
      background-color: #1e8449;
      transform: translateY(-2px);
    }

    .pay-button:active {
      transform: translateY(0);
    }

    /* Стиль для кнопки купити преміум */
    .premium-button {
      background-color: #FF9800;
      color: #000000;
      padding: 14px 10px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 24px;
      cursor: pointer;
      border-radius: 14px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      font-family: 'Montserrat';
      border: none;
      width: 100%;
    }

    .premium-button:active {
      transform: translateY(0);
    }

    /* Стилі для сторінки тарифів */
    #tariffs-section {
      text-align: center;
    }

    .tariff {
      background-color: #fff;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tariff h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .tariff p {
      font-size: 14px;
      color: #7f8c8d;
    }

    .tariff-price {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: black;
    }

    .asset-link {
      text-decoration: none;
    }

    .tariff button {
      background-color: #3498db;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    .finishSpeedButton {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #37474F;
      background-color: #E0F7FA;
      border: 2px solid #B2EBF2;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease-in-out, box-shadow 0.2s;
      margin: 10px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tariff button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    #speed-training-section,
    #listening-training-section {
      background: #fffdfd;
      padding: 20px;
      border-radius: 10px;
    }

    .tariff button:active {
      transform: translateY(0);
    }

    /* Стилі для карток слів */
    .word-card {
      background-color: #fff;
      padding: 15px 22px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .word-card:hover {
      transform: translateY(-2px);
    }

    .word-card .add-icon {
      background-image: url('https://img.icons8.com/ios-glyphs/30/ffffff/plus.png');
      /* Білий колір */
      background-size: contain;
      background-repeat: no-repeat;
      width: 24px;
      height: 24px;
      margin-left: auto;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .word-card .add-icon:hover {
      opacity: 0.7;
    }

    /* Стилі для кнопок букв у конструкторі слова */
    .letter-button {
      padding: 10px 15px;
      margin: 5px;
      background-color: #bdc3c7;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s, transform 0.2s;
    }

    #quiz-emoji {
      font-size: 60px;
      color: #32708f;
    }

    .letter-button:hover {
      background-color: #95a5a6;
      transform: translateY(-2px);
    }

    .letter-button:disabled {
      background-color: #7f8c8d;
      cursor: not-allowed;
    }

    /* Стиль для повідомлення про успішне додавання */
    .success-message {
      color: #27ae60;
      font-size: 16px;
      text-align: center;
      margin-top: 10px;
    }

    .small-button {
      padding: 8px 12px;
      font-size: 14px;
      width: auto;
      margin-bottom: 10px;
    }

    /* Оверлей завантаження */
    #loading-overlay {
      display: none !important;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      /* Полупрозрачный белый фон */
      z-index: 10000;
      /* Высокий z-index, чтобы перекрыть весь контент */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      border: 4px solid #000000;
    border-top: 4px solid white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Стилі для рекомендацій перекладу */
    #translation-suggestions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .suggestion {
      background-color: #ecf0f1;
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
      flex: 1 1 calc(33% - 20px);
      text-align: center;
      transition: background-color 0.3s, transform 0.2s;
    }

    .suggestion:hover {
      background-color: #bdc3c7;
      transform: translateY(-2px);
    }

    /* Секції тренувань */
    #listening-training-section,
    #word-constructor-training-section,
    #quiz-section,
    #picture-quiz-section,
    #add-word-section,
    #word-base-section,
    #my-words-section,
    #account-screen,
    #payment-section,
    #tariffs-section {
      animation: fadeIn 0.5s ease-in-out;
    }

    #quiz-section {
      background: #fffdfd;
      padding: 20px;
      border-radius: 10px;
    }

    #quiz-section p,
    #quiz-section ul {
      margin-left: auto;
      margin-right: auto;
    }

    /* Стилі для тренування по картинках */
    #picture-quiz-section {
      background: #fffdfd;
      padding: 20px;
      border-radius: 10px;
    }

    #picture-quiz-container {
      text-align: center;
    }

    #picture-quiz-image-container {
      margin: 20px auto;
      max-width: 280px;
    }

    #picture-quiz-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #picture-quiz-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      max-width: 400px;
      margin: 20px auto;
    }

    #picture-quiz-options button {
      padding: 15px 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      background-color: #D7E9F7;
      color: #324855;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
    }

    #picture-quiz-options button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    #picture-quiz-options button.correct {
      background-color: #4CAF50;
      color: white;
    }

    #picture-quiz-options button.incorrect {
      background-color: #f44336;
      color: white;
    }

    #picture-quiz-progress {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      height: 25px;
    }

    #picture-quiz-progress-bar {
      height: 100%;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.3s ease;
    }

    #picture-quiz-question-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }

    /* Стилі для кросворда - оптимізовано для мобільних */
    #crossword-section {
      background: #fffdfd;
      padding: 15px 10px;
      border-radius: 10px;
    }

    #crossword-section .title-and-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #crossword-section .title-and-btn h2 {
      position: static !important;
      transform: none !important;
      font-size: 28px !important;
      font-weight: bold;
      margin: 0;
      flex: 1;
      text-align: center;
    }

    #add-word-section .title-and-btn {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 15px;
    }

    #add-word-section .title-and-btn h2 {
      position: static !important;
      transform: none !important;
      font-size: 28px !important;
      font-weight: bold;
      margin: 0;
    }

    .crossword-note {
      text-align: center;
      color: #78909C;
      font-size: 12px;
      margin: 5px 0 15px 0;
    }

    /* СІТКА КРОСВОРДА - СПОЧАТКУ! */
    #crossword-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      margin-bottom: 20px;
    }

    #crossword-grid-wrapper {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 15px 5px;
      display: flex;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    #crossword-grid {
      display: inline-block;
    }

    #crossword-grid table {
      border-collapse: separate;
      border-spacing: 3px;
      background: transparent;
    }

    .crossword-cell {
      width: 36px;
      height: 36px;
      padding: 0;
      position: relative;
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .crossword-cell.empty {
      background: transparent;
      box-shadow: none;
    }

    .crossword-cell input {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      background: transparent;
      color: #1a1a2e;
      caret-color: #667eea;
      padding: 0;
      border-radius: 6px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .crossword-cell input:focus {
      background: #fff9c4;
      color: #1a1a2e;
      box-shadow: 0 0 0 3px rgba(255, 235, 59, 0.5);
    }

    .crossword-cell input.correct {
      background: linear-gradient(145deg, #4ade80, #22c55e);
      color: white;
    }

    .crossword-cell input.incorrect {
      background: linear-gradient(145deg, #f87171, #ef4444);
      color: white;
      animation: shake 0.3s ease;
    }

    .cell-number {
      position: absolute;
      top: 1px;
      left: 3px;
      font-size: 8px;
      font-weight: 700;
      color: #667eea;
      pointer-events: none;
      z-index: 1;
    }

    /* Підказки - ПІСЛЯ сітки */
    #crossword-clues {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
      width: 100%;
    }

    @media (max-width: 500px) {
      #crossword-clues {
        grid-template-columns: 1fr;
      }
    }

    .clues-section {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .clues-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .clues-header h4 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
    }

    .clues-header i {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .clues-header i.rotated {
      transform: rotate(180deg);
    }

    .clues-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .clues-list.collapsed {
      display: none;
    }

    .clues-list li {
      padding: 8px 12px;
      font-size: 13px;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .clues-list li:hover {
      background: #f8f9ff;
    }

    .clues-list li:last-child {
      border-bottom: none;
    }

    .clues-list li strong {
      color: #667eea;
      min-width: 18px;
      font-weight: 700;
    }

    /* Кнопки дій */
    #crossword-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
      padding: 0 10px;
    }

    #crossword-section .check-button,
    #crossword-section .new-crossword-button {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #fffdfd;
      background-color: #90A4AE;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease-in-out;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    #crossword-section .check-button:hover,
    #crossword-section .new-crossword-button:hover {
      background-color: #78909C;
      transform: scale(1.02);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    #crossword-section .check-button:active,
    #crossword-section .new-crossword-button:active {
      background-color: #607D8B;
      transform: scale(0.98);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Попап з результатом */
    .crossword-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .crossword-popup-content {
      background: white;
      border-radius: 20px;
      padding: 30px 25px;
      max-width: 320px;
      width: 100%;
      text-align: center;
      animation: popIn 0.4s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .crossword-popup-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: bounceIn 0.5s ease 0.2s both;
    }

    .crossword-popup-icon.success {
      background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
    }

    .crossword-popup-icon.error {
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
    }

    .crossword-popup-icon.warning {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    }

    .crossword-popup-icon i {
      font-size: 36px;
      color: white;
    }

    .crossword-popup-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
    }

    .crossword-popup-content p {
      margin: 0 0 25px 0;
      font-size: 16px;
      color: #666;
      line-height: 1.5;
    }

    .crossword-popup-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .popup-btn {
      padding: 14px 25px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .popup-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .popup-btn-primary:active {
      transform: scale(0.95);
    }

    .popup-btn-secondary {
      background: #f5f5f5;
      color: #333;
    }

    .popup-btn-secondary:active {
      transform: scale(0.95);
      background: #e0e0e0;
    }

    /* Адаптивність для маленьких екранів */
    @media (max-width: 380px) {
      .crossword-cell {
        width: 32px;
        height: 32px;
      }

      .crossword-cell input {
        font-size: 16px;
      }

      .cell-number {
        font-size: 8px;
      }

      .check-button, .new-crossword-button {
        padding: 12px 15px;
        font-size: 14px;
      }
    }

    /* Центрування іконки всередині кнопки */
    .button-with-icon {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      color: #324855;
      text-align: left;
      box-shadow: none;
      margin-bottom: 0;
    }

    .button-with-icon i {
      font-size: 18px;
    }

    .button-with-icon .icon {
      margin-right: 8px;
      /* Відступ між іконкою та текстом, якщо є */
    }

    /* Стиль для email користувача всередині заголовка */
    .user-email {
      font-weight: bold;
      color: #2c3e50;
      cursor: pointer;
      transition: color 0.3s;
    }

    .user-email:hover {
      color: #2980b9;
    }

    .correct {
      background-color: #8bc34a;
      /* Приглушенный зеленый */
      color: #fff;
    }

    .add-word-from-my-vocabulary.hidden {
      display: none;
    }

    .incorrect {
      background-color: #e57373;
      /* Приглушенный красный */
      color: #fff;
    }

    #quiz-question-number,
    #repetition-question-number {
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      color: #333;
      font-weight: bold;
      font-size: 12px;
      line-height: 16px;
      background: white;
      padding: 0 8px;
      border-radius: 8px;
    }

    /* 9) Стилі для емодзі результатів */
    .quiz-result {
      text-align: center;
      margin-top: 20px;
    }

    .quiz-result img {
      width: 100px;
      height: 100px;
    }

    .quiz-result p {
      font-size: 18px;
    }

    .skip-button {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #fffdfd;
      /* Белый текст для контраста */
      background-color: #90A4AE;
      /* Спокойный серо-голубой оттенок */
      border: none;
      border-radius: 12px;
      /* Закруглённые углы */
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease-in-out;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      /* Лёгкая тень для объёма */
    }

    /* Состояние при наведении */
    .skip-button:hover {
      background-color: #78909C;
      /* Немного темнее при наведении */
      transform: scale(1.02);
      /* Лёгкое увеличение */
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      /* Увеличенная тень */
    }

    /* Состояние при нажатии */
    .skip-button:active {
      background-color: #607D8B;
      /* Ещё темнее при нажатии */
      transform: scale(0.98);
      /* Лёгкое уменьшение */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      /* Снижение тени */
    }

    /* Styles for the topics grid and tiles */
    .topics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 0 10px;
    }

    .topic-tile {
      background-color: #fff;
      height: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 15px 10px;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      font-weight: bold;
      color: #37474F;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s ease-in-out;
      gap: 8px;
    }

    .topic-icon {
      font-size: 32px;
      line-height: 1;
    }

    .topic-name {
      font-size: 14px;
      line-height: 1.2;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 100%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 1;
        transform: translate(-50%, 0);
      }

      to {
        opacity: 0;
        transform: translate(-50%, 100%);
      }
    }

    #topic-words-list {
      padding: 0;
    }

    .topic-tile:hover {
      transform: translateY(-5px);
    }

    /* 12) Стилі для зворотного зв'язку після слухання */
    .listening-feedback {
      text-align: center;
      font-size: 16px;
    }

    .word-constructor-quiz-container .letter-button {
      flex: 1 0 auto;
      max-width: 45px;
      text-align: center;
      margin: 5px;
    }

    #constructor-progress,
    #quiz-progress,
    #repetition-progress {
      width: 100%;
      /* Занимает почти всю ширину */
      height: 12px;
      /* Высота прогресс-бара */
      background-color: #E0E0E0;
      /* Светлый серый фон */
      border-radius: 6px;
      /* Закруглённые углы */
      overflow: hidden;
      /* Скрываем содержимое, выходящее за границы */
      margin: 10px auto;
      /* Центрируем по горизонтали */
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      /* Внутренняя тень для объёма */
      position: relative;
    }

    #constructor-progress-bar,
    #quiz-progress-bar,
    #repetition-progress-bar {
      height: 100%;
      width: 0%;
      /* Начальное значение прогресса */
      background-color: #4FC3F7;
      /* Голубой цвет заполнения */
      border-radius: 6px;
      /* Закругляем углы */
      transition: width 0.5s ease-in-out;
      /* Плавный переход при изменении ширины */
      height: 12px;
    }

    .finish-button {
      /* Кнопка почти на всю ширину */
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #37474F;
      /* Тёмно-серый текст */
      background-color: #E0F7FA;
      /* Светло-голубой пастельный фон */
      border: 2px solid #B2EBF2;
      /* Голубая рамка */
      border-radius: 12px;
      /* Закруглённые углы */
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.2s ease-in-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      /* Лёгкая тень для объёма */
      margin-top: 15px;
    }

    /* Ховер эффект */
    .finish-button:hover {
      background-color: #B2EBF2;
      /* Насыщенный голубой при наведении */
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      /* Увеличение тени */
    }

    /* Эффект при нажатии */
    .finish-button:active {
      background-color: #80DEEA;
      /* Ещё более насыщенный голубой */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      /* Снижение тени */
      transform: scale(0.98);
      /* Лёгкое уменьшение */
    }

    .title-wrapper {
      display: flex;
      align-items: left;
      justify-content: left;
      gap: 10px;
    }

    .copy-animation {
  animation: copyPulse 0.5s ease-in-out;
}

@keyframes copyPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

    /* Стилі для кнопки "Стерти" */
    /* Стилі для прогрес бару у конструкторі слова */
    #constructor-progress {
      width: 100%;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }

    /* Стилі для результатів тренування конструктору слова */
    .constructor-quiz-result {
      text-align: center;
      margin-top: 20px;
    }

    .constructor-quiz-result img {
      width: 100px;
      height: 100px;
    }

    html {
      scroll-behavior: smooth;
    }

    .notification.warning {
      background-color: #FFC107;
      /* Желтый фон */
      color: #000;
      /* Черный текст для лучшей читаемости */
      border-radius: 10px;
      text-align: center;
    }

    .constructor-quiz-result p {
      font-size: 18px;
      margin-top: 10px;
    }

    .fade-out {
      animation: fadeOut 0.5s ease-in-out;
    }

    .popup {
      background-color: #fffdfd;
      padding: 20px;
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
      position: fixed;
      top: 50%;
      left: 50%;
      z-index: 1000;
      transform: translate(-50%, -50%);
    }

    .popup h3 {
      margin-top: 0;
    }

    .popup button {
      background-color: #000;
      /* Черный фон */
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0;
    }

    .topic-tile:hover {
      transform: translateY(-5px);
    }

    #popupMessage {
      margin-top: 20px;
      text-align: center;
    }

    /* Стили для всплывающего уведомления */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #2ecc71;
      /* Зеленый фон */
      color: #fffdfd;
      padding: 10px 20px;
      border-radius: 4px;
      z-index: 1001;
      animation: slideUp 0.5s, slideDown 0.5s 2.5s;
      text-align: center;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 100%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 1;
        transform: translate(-50%, 0);
      }

      to {
        opacity: 0;
        transform: translate(-50%, 100%);
      }
    }

    /* Анимации появления и исчезновения */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    .fade-out {
      animation: fadeOut 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #word-constructor-training-section {
      background: #fffdfd;
      padding: 20px;
      border-radius: 10px;
    }

    .constructor-letter-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px;
      gap: 10px;
    }

    /* Центрирование иконки звука */
    .sound-icon-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    /* Стили для всплывающего окна информации */
    #popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    /* Стиль для уведомления об успешном добавлении слова */
    .add-word-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #2ecc71;
      /* Зеленый фон */
      color: #fffdfd;
      padding: 10px 20px;
      border-radius: 4px;
      z-index: 1001;
      animation: slideUp 0.5s, slideDown 0.5s 2.5s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 100%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 1;
        transform: translate(-50%, 0);
      }

      to {
        opacity: 0;
        transform: translate(-50%, 100%);
      }
    }

    /* Позиционирование иконки плюса в словах темы */
    .word-card {
      position: relative;
    }

    .word-card .fa-plus {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    #quiz-container .check-word:last-child {
      margin-bottom: 40px;
    }

    .popup h3 {
      margin-top: 0;
    }

    .popup button:hover {
      background-color: #333;
    }

    #search-input {
      margin-top: 15px;
    }

    .title-and-btn {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .title-and-btn h2 {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
      font-size: 16px;
      color: #324855;
      font-weight: 300;
    }

    /* Меню плитки */
    .menu-tiles {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      margin-top: 20px;
    }

    .menu-tiles button {
      flex: 0 0 calc(50% - 5px);
      /* Две плитки в ряд */
      height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .menu-tiles button i {
      font-size: 24px;
      margin-bottom: 5px;
    }

    /* Настройка иконок звука в карточках слов */
    .word-card .fa-volume-up,
    .word-card .fa-plus {
      cursor: pointer;
      margin-right: 10px;
    }

    .fas.fa-backspace {
      color: #e74c3c;
    }

    /* Стили для прогресс-бара в тренировке на слух */
    #listening-quiz-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .listening-sound-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      background: #324855;
      margin: 0;
    }

    .listening-sound-icon i {
      color: #fffdfd;
    }

    #generated-story {
      position: relative;
      padding-top: 60px;
      /* Added padding to accommodate controls */
      background-color: #fffdfd;
      padding: 20px;
      line-height: 1.6;
      /* Відступ між рядками для зручності читання */
      margin-bottom: 20px;
      border-radius: 10px;
      position: relative;
      /* Для позиціонування іконки озвучення */
      margin: 20px -20px -20px;
    }

    /* Стили для обратной связи в тренировке на слух */
    .listening-feedback {
      text-align: center;
      margin-top: 10px;
      font-size: 16px;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    .skip-button:hover {
      background-color: #7f8c8d;
    }

    /* Настройка кнопки удаления в конструкторе слова */
    .delete-constructor-button {
      width: 10%;
      min-height: 100%;
      margin: 0;
      padding: 0;
      background-color: #FFCDD2;
      /* Лёгкий розовый фон */
      color: #37474F;
      /* Тёмный текст */
      border: 1px solid #FF8A80;
      /* Красноватая рамка */
      border-radius: 0 10px 10px 0;
      /* Скруглённые правые углы */
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
    }

    .delete-constructor-button:hover {
      background-color: #ffc0c7;
    }

    .title-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .title-main h1 {
      font-size: 26px;
      margin: 0;
    }

    /* ========== Стилі для генеративного тексту ========== */
    #generative-text-section {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
    }

    #repetition-training-section {
      background: #fffdfd;
      padding: 20px;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    #generative-text-section > p:first-of-type {
      text-align: center;
      font-size: 15px;
      color: #666;
      margin-bottom: 25px;
    }

    #generative-text-section .title-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      width: 100%;
      margin-bottom: 0;
      padding: 16px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    #generative-text-section .title-wrapper:last-of-type {
      border-bottom: none;
    }

    #generative-text-section .title-wrapper label {
      font-size: 15px;
      color: #333;
      font-weight: 500;
      margin: 0;
    }

    #generative-text-section .option-button {
      background: #f0f4ff;
      border: none;
      border-radius: 10px;
      padding: 12px 15px;
      font-size: 16px;
      font-weight: 500;
      color: #667eea;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      min-height: 44px;
      width: 100%;
    }

    #generative-text-section .option-button::after {
      content: '\f054';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      font-size: 10px;
      color: #ccc;
    }

    .story-word {
      transition: background-color 0.2s ease;
    }

    .highlight-word {
      background-color: #FFE082;
      border-radius: 3px;
      padding: 0 2px;
    }

    .highlight-sentence {
      background-color: #E3F2FD;
      border-radius: 4px;
      padding: 2px 0;
    }

    #generative-text-section .generate {
      width: 100%;
      margin-top: 25px;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 600;
      color: white;
      background: #333;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #generative-text-section .generate:hover {
      background: #444;
    }

    #generative-text-section .generate:active {
      transform: scale(0.98);
    }

    #generative-text-section .generate .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Згенерована історія */
    #generated-story {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    #generated-story h4 {
      font-size: 18px;
      color: #333;
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    #generated-story p {
      font-size: 15px;
      line-height: 1.7;
      color: #555;
      margin: 0;
    }

    #generated-story .highlight {
      background: #fff3cd;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 600;
      color: #856404;
    }

    /* Кнопки дій */
    #story-actions {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    #story-actions .large-btn {
      width: 100%;
      margin-top: 0;
    }

    #story-actions .round-btn {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 1px solid #e0e0e0;
      background: white;
      color: #666;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #story-actions .round-btn:hover {
      border-color: #333;
      color: #333;
    }

    #story-actions .large-btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: #333;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #story-actions .large-btn:hover {
      background: #444;
    }

    #generative-loading {
      display: flex;
      justify-self: center;
      align-items: center;
    }

    /* Предотвращение выделения текста на всех кнопках */
    button {
      user-select: none;
      /* Основное свойство */
      -webkit-user-select: none;
      /* Для Safari */
      -moz-user-select: none;
      /* Для Firefox */
      -ms-user-select: none;
      /* Для Internet Explorer и Edge */
      cursor: pointer;
      /* Указатель курсора при наведении */
    }

    /* Удаление стандартного фокусного контура */
    button:focus {
      outline: none;
    }

    /* Альтернативный фокусный стиль для доступности (рекомендуется) */
    button:focus-visible {
      outline: none;
      /* Кастомный контур при фокусе */
      outline-offset: 2px;
    }

    /* Popup Styles */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background-color: #fff;
      padding: 20px;
      width: 80%;
      max-width: 500px;
      max-height: 80%;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      border-radius: 8px;
      z-index: 1001;
    }

    .popup.popup-animate {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .popup-content-analitic {
      background: linear-gradient(90deg, rgba(139, 198, 236, 1), rgba(139, 198, 236, 1));
      padding: 0;
      text-align: center;
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }

    .popup-content-wrapper {
      width: 90%;
      margin: 0 auto;
      padding-top: 40px;
    }

    @media only screen and (max-width: 768px) {
        .popup-content {
        width: 100%;
      }
    }

    .popup-content h3 {
      margin-top: 0;
      font-size: 1.5em;
      /* Increased title size */
    }

    .popup-message {
      margin-top: 10px;
      margin-bottom: 10px;
      color: #2ecc71;
      /* Green color */
      text-align: center;
      font-size: 1.1em;
    }

    .popup-message.warning {
      color: #e74c3c;
      /* Red color */
    }

    .words-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .word-card {
      display: flex;
      align-items: center;
      padding: 15px;
      /* Increased padding */
      border-bottom: 1px solid #ccc;
      font-size: 1.1em;
      /* Increased text size */
    }

    .word-card:last-child {
      border-bottom: none;
    }

    .word-card i {
      cursor: pointer;
      margin-right: 15px;
      font-size: 1.2em;
      color: #324855;
      /* Icon color */
    }

    .word-card .fa-volume-up {
      /* Icon color already set above */
    }

    .word-card .fa-plus {
      margin-left: auto;
      /* Icon color already set above */
    }

    .button-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-direction: column;
      gap: 20px;
      margin-top: 30px;
    }

    .button-container button {
      flex: 1;
      /* Reduced spacing between buttons */
    }

    .button-container button:first-child {
      margin-left: 0;
    }

    .button-container button:last-child {
      margin-right: 0;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .hidden {
      display: none;
    }

    /* Bottom sheet стиль для всіх info попапів */
    #speedInfoPopup,
    #constructorInfoPopup,
    #infoPopup,
    #listeningInfoPopup,
    #repetitionInfoPopup,
    #generatorInfoPopup,
    #pictureQuizInfoPopup,
    #fillBlanksInfoPopup {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      top: auto !important;
      width: 100% !important;
      max-width: 100% !important;
      max-height: 80%;
      transform: translateY(100%);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-top: 10px;
      background: #fff;
      z-index: 1001;
      transition: transform 0.3s ease, visibility 0.3s ease;
      overflow: auto;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      box-sizing: border-box;
      visibility: hidden;
      pointer-events: none;
    }

    #speedInfoPopup::before,
    #constructorInfoPopup::before,
    #infoPopup::before,
    #listeningInfoPopup::before,
    #repetitionInfoPopup::before,
    #generatorInfoPopup::before,
    #pictureQuizInfoPopup::before,
    #fillBlanksInfoPopup::before {
      content: '';
      display: block;
      width: 40px;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
      margin: 0 auto 15px auto;
    }

    #speedInfoPopup.show,
    #constructorInfoPopup.show,
    #infoPopup.show,
    #listeningInfoPopup.show,
    #repetitionInfoPopup.show,
    #generatorInfoPopup.show,
    #pictureQuizInfoPopup.show,
    #fillBlanksInfoPopup.show {
      transform: translateY(0);
      visibility: visible;
      pointer-events: auto;
    }

    #speedInfoPopup .close-button,
    #constructorInfoPopup .close-button,
    #infoPopup .close-button,
    #listeningInfoPopup .close-button,
    #repetitionInfoPopup .close-button,
    #generatorInfoPopup .close-button,
    #pictureQuizInfoPopup .close-button,
    #fillBlanksInfoPopup .close-button {
      width: 100%;
      padding: 15px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
      cursor: pointer;
    }

    /* Bottom sheet стиль для wordInfoPopup */
    #wordInfoPopup {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      width: 100%;
      max-width: 100%;
      max-height: 80%;
      transform: translateY(100%);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-top: 10px;
      background: #fff;
      z-index: 1001;
      transition: transform 0.3s ease;
      overflow: auto;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      box-sizing: border-box;
    }

    #wordInfoPopup h3 {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    #wordInfoPopup::before {
      content: '';
      display: block;
      width: 40px;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
      margin: 0 auto 15px auto;
    }

    #wordInfoPopup.show {
      transform: translateY(0);
    }

    #wordInfoPopup .popup-content {
      align-items: baseline;
    }

    #wordInfoPopup .popup-content p {
     margin-top: 0;
     margin-bottom: 10px;
    }

    #infoPopup {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      width: 100%;
      max-width: 100%;
      max-height: 80%;
      transform: translateY(100%);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-top: 10px;
      background: #fff;
      z-index: 1001;
      transition: transform 0.3s ease;
      overflow: auto;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      box-sizing: border-box;
    }

    #infoPopup::before {
      content: '';
      display: block;
      width: 40px;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
      margin: 0 auto 15px auto;
    }

    #infoPopup.show {
      transform: translateY(0);
    }

    #infoPopup .training-title-desc {
      font-weight: bold;
      margin-bottom: 5px;
    }

    #infoPopup .description {
      margin-bottom: 15px;
    }

    #infoPopup .algorithm-block {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    #infoPopup .algorithm-block p {
      font-weight: bold;
      margin-bottom: 10px;
    }

    #infoPopup .algorithm-block ol {
      margin: 0;
      padding-left: 20px;
    }

    #infoPopup .close-button {
      width: 100%;
      padding: 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }

/* Стилізація кнопки, що відкриває меню опцій */
.option-button {
  background: linear-gradient(145deg, #4DD0E1, #26C6DA); /* Градієнт бірюзових відтінків */
  color: #fff;                   /* Білий текст */
  font-size: 18px;
  font-weight: bold;
  padding: 12px 16px;
  border: none;
  border-radius: 12px;
  box-shadow:  4px 4px 8px rgba(0, 0, 0, 0.15), 
              -4px -4px 8px rgba(255, 255, 255, 0.7);
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  margin: 8px 0;
  text-align: center;
}

.option-button:hover {
  transform: scale(1.03);
  box-shadow:  2px 2px 4px rgba(0, 0, 0, 0.2), 
              -2px -2px 4px rgba(255, 255, 255, 0.8);
}

.option-button:active {
  transform: scale(0.98);
}

/* Стилізація кнопок, що знаходяться в опційному меню */
#option-menu-list {
  list-style: none;
  padding: 0;
  margin: 0;
  margin-top: 20px;
}

#option-menu-list li {
  margin-bottom: 10px;
}

#option-menu-list li button {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background-color: #fff;
  color: #333;
  font-size: 16px;
  font-weight: 500;
  padding: 14px 16px;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s ease;
}

#option-menu-list li button:hover {
  background-color: #f5f5f5;
  border-color: #ccc;
}

#option-menu-list li button:active {
  background-color: #eee;
  transform: scale(0.98);
}

#option-menu-list li button i {
  width: 20px;
  text-align: center;
  color: #666;
}

.copy-animation {
  animation: copyPulse 0.5s ease-in-out;
}

@keyframes copyPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

/* Клас для круглих кнопок з іконками */
.round-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: #000;
  border: none;
  color: #fff;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s;
  z-index: 1;
}

#story-actions {
  justify-content: center;
}
.round-btn:hover {
  background-color: #333;
}

/* Клас для кнопки "Прочитано" (залишається великою) */
.large-btn {
  padding: 15px 20px;
  font-size: 18px;
  border-radius: 12px;
  background-color: #E0F7FA;
  border: 2px solid #B2EBF2;
  color: #37474F;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.2s;
}

/* Анімація спіралі навколо кнопки "Прочитано" */
@keyframes spiral {
  0% {
    box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
  }
  100% {
    box-shadow: 0 0 0 20px rgba(0, 0, 0, 0);
  }
}
.spiral-animation {
  animation: spiral 1s forwards;
}

/* ========== Стилі для "Вставте пропущене слово" ========== */
#fill-blanks-section {
  padding-bottom: 20px;
}

#fillBlanksInfoPopup:not(.hidden) {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

#fill-blanks-mode-selection {
  text-align: center;
  padding: 20px 0;
}

#fill-blanks-mode-selection p {
  font-size: 18px;
  margin-bottom: 20px;
}

#fill-blanks-mode-selection button {
  display: block;
  width: 100%;
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  color: #37474F;
  background-color: #E0F7FA;
  border: 2px solid #B2EBF2;
  border-radius: 12px;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.2s ease-in-out, box-shadow 0.2s;
  margin: 10px 0;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#fill-blanks-mode-selection button:hover {
  background-color: #B2EBF2;
  box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
  transform: scale(1.02);
}

#fill-blanks-mode-selection button i {
  margin-right: 10px;
}

/* Банк слів */
#fill-blanks-word-bank {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  margin-bottom: 20px;
  min-height: 60px;
  justify-content: center;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.fill-blanks-word {
  background: white;
  color: #37474F;
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  user-select: none;
  border: 2px solid transparent;
}

.fill-blanks-word:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
}

.fill-blanks-word.selected {
  background: #FFD700;
  border-color: #FFA500;
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
}

.fill-blanks-word.used {
  opacity: 0.4;
  pointer-events: none;
  transform: scale(0.9);
}

/* Речення */
#fill-blanks-sentences {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.fill-blanks-sentence {
  background: white;
  padding: 20px;
  border-radius: 12px;
  font-size: 17px;
  line-height: 1.8;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-left: 4px solid #667eea;
}

.fill-blanks-sentence .sentence-number {
  display: inline-block;
  background: #667eea;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  text-align: center;
  line-height: 28px;
  font-weight: bold;
  margin-right: 12px;
  font-size: 14px;
}

/* Пропуск (blank) */
.fill-blank {
  display: inline-block;
  min-width: 100px;
  height: 32px;
  background: #f0f0f0;
  border: 2px dashed #667eea;
  border-radius: 8px;
  margin: 0 5px;
  vertical-align: middle;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.fill-blank:hover {
  background: #e0e7ff;
  border-color: #4f46e5;
}

.fill-blank.active {
  background: #dbeafe;
  border-style: solid;
  border-color: #3b82f6;
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

.fill-blank.filled {
  background: #d1fae5;
  border-style: solid;
  border-color: #10b981;
  padding: 4px 12px;
  min-width: auto;
  height: auto;
  line-height: 24px;
}

.fill-blank.filled .blank-word {
  font-weight: 600;
  color: #065f46;
}

.fill-blank.filled .remove-word {
  margin-left: 8px;
  color: #ef4444;
  cursor: pointer;
  font-weight: bold;
}

.fill-blank.correct {
  background: #d1fae5;
  border-color: #10b981;
  animation: correctPulse 0.5s ease;
}

.fill-blank.incorrect {
  background: #fee2e2;
  border-color: #ef4444;
  animation: shake 0.5s ease;
}

@keyframes correctPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-5px); }
  40%, 80% { transform: translateX(5px); }
}

/* Анімація вставки слова */
@keyframes wordInsert {
  0% {
    opacity: 0;
    transform: scale(0.5) translateY(-20px);
  }
  50% {
    transform: scale(1.1) translateY(0);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.fill-blank.animating {
  animation: wordInsert 0.4s ease forwards;
}

/* Прелоадер */
#fill-blanks-loader {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
}

#fill-blanks-loader .spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#fill-blanks-loader p {
  margin-top: 20px;
  font-size: 18px;
  color: #37474F;
}

/* Кнопка перевірки */
#fill-blanks-check-btn {
  display: block;
  width: 100%;
  margin-top: 20px;
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

#fill-blanks-check-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

#fill-blanks-check-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Результат */
#fill-blanks-result {
  text-align: center;
  padding: 40px 20px;
}

#fill-blanks-result #fill-blanks-emoji {
  font-size: 80px;
  margin-bottom: 20px;
}

#fill-blanks-result #fill-blanks-result-text {
  font-size: 18px;
  line-height: 1.6;
  margin-bottom: 30px;
}

#fill-blanks-result .finish-button {
  padding: 15px 30px;
  font-size: 18px;
  font-weight: bold;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
}

/* ========== Стилі для "Вгадай слово" ========== */
#definition-quiz-section {
  padding-bottom: 20px;
}

#definition-quiz-mode-selection {
  text-align: center;
  padding: 20px 0;
}

#definition-quiz-mode-selection p {
  font-size: 18px;
  margin-bottom: 20px;
}

#definition-quiz-mode-selection button {
  display: block;
  width: 100%;
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  color: #37474F;
  background-color: #E0F7FA;
  border: none;
  border-radius: 12px;
  margin-bottom: 15px;
  cursor: pointer;
}

.definition-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 16px;
  font-size: 20px;
  line-height: 1.5;
  text-align: center;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

#definition-quiz-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#definition-quiz-options button {
  padding: 16px 20px;
  font-size: 18px;
  font-weight: 500;
  background-color: #D7E9F7;
  color: #37474F;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

#definition-quiz-options button:active {
  transform: scale(0.98);
}

#definition-quiz-options button.correct {
  background-color: #4CAF50;
  color: white;
}

#definition-quiz-options button.wrong {
  background-color: #F44336;
  color: white;
}

#definition-quiz-progress {
  margin-top: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  height: 8px;
  position: relative;
}

#definition-quiz-progress-bar {
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 10px;
  transition: width 0.3s ease;
}

#definition-quiz-question-number {
  text-align: center;
  margin-top: 8px;
  font-size: 14px;
  color: #666;
}

#definition-quiz-loader {
  text-align: center;
  padding: 40px;
}

#definition-quiz-loader .spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #e0e0e0;
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
  </style>

</head>

<body>
  <!-- Прелоадер -->
  <div id="page-preloader">
    <div class="preloader-content">
      <div class="preloader-spinner"></div>
      <div class="preloader-text">Мій словник</div>
    </div>
  </div>

  <div id="wordInfoPopup"></div>
  <div id="infoPopup"></div>
  <div id="progressPopup" class="hidden">
    <div class="popup-content-analitic">
      <div class="popup-content-wrapper">
        <div class="title-and-btn">
          <button class="button-with-icon back-button" onclick="closeProgressPopup()">
            <i class="fas fa-arrow-left"></i>
            <span>Назад</span>
          </button>
          <h2>Мій прогрес</h2>
          <button class="info-btn-small" onclick="showProgressInfo()">
            <i class="fas fa-info-circle"></i>
          </button>
        </div>
        <p id="dateRange" class="date-range"></p>
        <div id="progressData" class="tile-container">
          <div class="tile tile-new" onclick="showInfo('newWords')">
            <div class="tile-icon"><i class="fas fa-star"></i></div>
            <p>Нові слова</p>
            <span id="newWords">0</span>
          </div>
          <div class="tile tile-good" onclick="showInfo('goodKnowledge')">
            <div class="tile-icon"><i class="fas fa-trophy"></i></div>
            <p>Гарні знання</p>
            <span id="goodKnowledge">0</span>
          </div>
          <div class="tile tile-average" onclick="showInfo('averageKnowledge')">
            <div class="tile-icon"><i class="fas fa-book-open"></i></div>
            <p>Середні знання</p>
            <span id="averageKnowledge">0</span>
          </div>
          <div class="tile tile-poor" onclick="showInfo('poorKnowledge')">
            <div class="tile-icon"><i class="fas fa-redo"></i></div>
            <p>Погані знання</p>
            <span id="poorKnowledge">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="sharedWordsPopup" class="hidden popup">
    <div class="popup-content">
      <h3>Додати слова до словника</h3>
      <p id="sharedWordsMessage"></p>
      <div id="shared-words-container" class="words-container">
        <!-- Word cards will be added here -->
      </div>
      <div class="button-container">
        <button onclick="addAllSharedWords()" class="add-all-button">Додати всі слова</button>
        <button onclick="closeSharedWordsPopup()" class="close-popup-button">Закрити</button>
      </div>
      <div id="popupMessage" class="popup-message"></div>
    </div>
  </div>
  <!-- Overlay -->
  <div class="overlay hidden" onclick="closeAllPopups()"></div>

  <!-- Оверлей завантаження -->
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>
  <!-- Контейнер для всього контенту -->
  <div class="container fade-in">
    <!-- Заголовок додатку -->
    <div class="title-main">
      <h1>Мій словник</h1>
      <div class="buttons-right-corner hidden">
        <button class="button-with-icon premium-icon" onclick="showTariffs()">
          <i class="fas fa-star"></i>
        </button>
        <button class="button-with-icon logout-button" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
        </button>
        <a href="https://t.me/shopify_evgene" target="_blank" class="asset-link">
          <button class="button-with-icon question-button">
            <i class="fas fa-headset"></i>
          </button>
        </a>
      </div>

    </div>
    <!-- Форма входу -->
    <div id="login-form">
      <h2>Вхід</h2>
      <input type="email" id="login-email" placeholder="Email">
      <div id="login-email-error" class="error-message"></div>
      <input type="password" id="login-password" placeholder="Пароль">
      <div id="login-password-error" class="error-message"></div>
      <button onclick="login()">Увійти</button>
      <button class="button-with-icon link-button register-link" onclick="showRegister()">Зареєструватися</button>
    </div>
    <!-- Форма реєстрації -->
    <div id="register-form" class="hidden">
      <h2>Реєстрація</h2>
      <input type="email" id="register-email" placeholder="Email">
      <div id="register-email-error" class="error-message"></div>
      <input type="password" id="register-password" placeholder="Пароль">
      <div id="register-password-error" class="error-message"></div>
      <button onclick="register()">Зареєструватися</button>
      <button class="button-with-icon link-button register-link" onclick="showLogin()">Вже є акаунт?
        Увійти</button>
    </div>
    <!-- Головний екран облікового запису -->
    <div id="account-screen" class="hidden">
      <h2>Вітаємо, <span class="user-email"></span>!</h2>
      <div class="subscription-info" id="subscription-info"></div>
      <div class="menu">
        <button onclick="showMyWords()"><i class="fas fa-book"></i> Мої слова</button>
        <button onclick="showAddWord()"><i class="fas fa-plus"></i> Додати слово</button>
        <button onclick="showWordBase()"><i class="fas fa-database"></i> База слів</button>
        <button onclick="loadUserProgress()"><i class="fa-solid fa-chart-line"></i> Мій прогрес </button>
        <div class="menu-tiles">
          <button onclick="startQuiz()"><i class="fas fa-pen"></i> Тестування</button>
          <button onclick="startPictureQuiz()"><i class="fas fa-image"></i> Картинки</button>
          <button onclick="startSpeedTraining()"><i class="fas fa-stopwatch"></i> Тестування на
            швидкість</button>
          <button onclick="startListeningTraining()"><i class="fas fa-headphones"></i> Тестування на
            слух</button>
          <button onclick="startWordConstructorTraining()"><i class="fas fa-puzzle-piece"></i>
            Конструктор</button>
          <!-- Нова кнопка для Генеративного тексту -->
          <button onclick="startGenerativeTextTraining()"><i class="fas fa-scroll"></i> Генеративний
            текст</button>
          <button onclick="startRepetitionTraining()"><i class="fas fa-repeat"></i> Повторення</button>
          <button onclick="startCrossword()"><i class="fas fa-th"></i> Кросворд</button>
          <button onclick="startFillBlanksTraining()"><i class="fas fa-pen-fancy"></i> Вставте слово</button>
          <button onclick="startDefinitionQuiz()"><i class="fas fa-lightbulb"></i> Вгадай слово</button>
        </div>
      </div>
    </div>
    <!-- Попап для поділених слів -->
    <div id="sharedWordsPopup" class="popup hidden">
      <div class="popup-content">
        <h3>Додані слова</h3>
        <div id="shared-words-list">
          <!-- Слова будуть додані динамічно -->
        </div>
        <div class="popup-buttons">
          <button onclick="addAllSharedWords()">Додати всі слова</button>
          <button class="close-button" onclick="closeSharedWordsPopup()">Закрити</button>
        </div>
      </div>
    </div>

    <!-- Секція "Мої слова" -->
    <div id="my-words-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <h2 style="font-size: 28px;">Мої слова</h2>
      </div>
      <input type="text" id="search-input" placeholder="Пошук слова...">
      <div class="word-count-row">
        <div id="word-count"></div>
        <button class="info-btn-small" onclick="showMyWordsInfo()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <div id="word-list">
        <ul id="words"></ul>
      </div>
      <button onclick="hideMyVocabulatyAndOpenAddWords()" id="add-word-from-my-vocabulary"
        class="add-word-from-my-vocabulary hidden" id="add-word-from-my-vocabulary">
        <i class="fas fa-database"></i>
        База слів
      </button>
    </div>
    <!-- Секція "Генеративний текст" -->
    <div id="generative-text-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openGeneratorInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>

      <!-- Кнопки вместо селектов -->
      <div class="title-wrapper">
        <label for="text-style">Cтиль тексту:</label>
        <button class="option-button" onclick="openOptionMenu('text-style', this)">-- Виберіть стиль --</button>
      </div>
      <div class="title-wrapper">
        <label for="text-difficulty">Cкладність тексту:</label>
        <button class="option-button" onclick="openOptionMenu('text-difficulty', this)">-- Виберіть складність
          --</button>
      </div>
      <div class="title-wrapper">
        <label for="text-length">Довжина тексту:</label>
        <button class="option-button" onclick="openOptionMenu('text-length', this)">-- Виберіть довжину --</button>
      </div>
      <button class="generate" onclick="generateStory()">
        <div class="spinner hidden"></div>
        <span>Сгенерувати</span>
      </button>
<!-- Область для відображення згенерованого тексту -->
<div id="generated-story" class="hidden">
  <h4 id="story-title"></h4>
  <p id="story-text"></p>
</div>

<!-- Блок для кнопок дій після генерації -->
<div id="story-actions" class="hidden">
  <!-- Кругла кнопка для копіювання (іконка fa-copy) -->
  <button id="copy-story-btn" class="round-btn" onclick="copyStory()">
    <i class="fas fa-copy"></i>
  </button>
  <!-- Кругла кнопка для озвучування (іконка fa-volume-up) -->
  <button id="play-story-btn" class="round-btn" onclick="playStory()">
    <i class="fas fa-volume-up"></i>
  </button>
  <!-- Кругла кнопка для перекладу (іконка fa-language) -->
  <button id="translate-story-btn" class="round-btn" onclick="translateStory()">
    <i class="fas fa-language"></i>
  </button>
  <!-- Більша кнопка для підтвердження "Прочитано" (залишаємо як є) -->
  <button id="read-story-btn" class="large-btn" onclick="markStoryAsRead()">Прочитано</button>
</div>
      <!-- Боковое меню -->
      <div id="option-menu" class="option-menu hidden">
        <div class="option-menu-content">
          <button class="button-with-icon back-button" onclick="closeOptionMenu()">
            <i class="fas fa-arrow-left"></i>
            <span>Назад</span>
          </button>
          <ul id="option-menu-list">
            <!-- Опції будуть додані динамічно -->
          </ul>
        </div>
      </div>
    </div>


    <!-- Секция "Повторення" -->
    <div id="repetition-training-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openRepetitionInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <div id="repetition-quiz-container"></div>
      <div id="repetition-progress">
        <div id="repetition-progress-bar"></div>
        <div id="repetition-question-number"></div>
      </div>
      <div id="repetition-result" class="quiz-result hidden">
        <i id="repetition-emoji" class=""></i>
        <p id="repetition-result-text"></p>
        <button class="finish-button" onclick="finishRepetition()">Завершити тренування</button>
      </div>
    </div>
    <!-- Секція "База слів" -->
    <div id="word-base-section" class="hidden">
      <div class="title-and-btn">
        <button id="word-base-back-button" class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <h2 style="font-size: 28px;">База слів</h2>
      </div>
      <!-- Список тем -->
      <div id="topics-list" class="topics-grid"></div>
      <!-- Список слів обраної теми -->
      <div id="topic-words" class="hidden">
        <button id="back-to-topics-button" class="button-with-icon back-button" onclick="backToTopics()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад до тем</span>
        </button>
        <!-- Доданий заголовок для назви теми -->
        <h2 id="topic-title" style="text-align: center; margin: 10px 0;"></h2>
        <!-- Кнопка для додавання всіх слів з поточної теми -->
        <button id="addAllButton" class="long-button" onclick="addAllWordsFromTopic(document.getElementById('topic-title').textContent)">
          Додати всі слова з теми
        </button>
        <ul id="topic-words-list"></ul>
      </div>
      <!-- Повідомлення про успішне додавання -->
      <div id="success-message" class="success-message"></div>
    </div>
    <!-- Секція "Додати слово" -->
    <div id="add-word-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <h2>Додати слово</h2>
      </div>
      <input type="text" id="english-word" placeholder="Англійське слово"
        onblur="getTranslationSuggestions(this.value)">
      <div id="english-word-error" class="error-message"></div>
      <input type="text" id="translation" placeholder="Переклад">
      <div id="translation-error" class="error-message"></div>
      <div id="translation-suggestions"></div>
      <input type="text" id="example" placeholder="Приклад використання (необов'язково)">
      <div id="example-error" class="error-message"></div>
      <button onclick="addWord()">Додати</button>
    </div>
    <!-- Секція "Тренування знань" -->
    <div id="quiz-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <div id="quiz-container"></div>
      <div id="quiz-progress">
        <div id="quiz-progress-bar"></div>
        <div id="quiz-question-number"></div> <!-- Новый элемент -->
      </div>
      <div id="quiz-result" class="quiz-result hidden">
        <i id="quiz-emoji" class=""></i>
        <p id="quiz-result-text"></p>
        <button class="finish-button" onclick="finishQuiz()">Завершити тест</button>
      </div>
    </div>

    <!-- Секція "Тренування по картинках" -->
    <div id="picture-quiz-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openPictureQuizInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <!-- Попап з інформацією -->
      <div id="picture-quiz-container">
        <div id="picture-quiz-image-container">
          <img id="picture-quiz-image" src="" alt="Word image">
        </div>
        <div id="picture-quiz-options"></div>
      </div>
      <div id="picture-quiz-progress">
        <div id="picture-quiz-progress-bar"></div>
        <div id="picture-quiz-question-number"></div>
      </div>
      <button class="skip-button" onclick="skipPictureQuestion()">Пропустити</button>
      <div id="picture-quiz-result" class="quiz-result hidden">
        <i id="picture-quiz-emoji" class=""></i>
        <p id="picture-quiz-result-text"></p>
        <button class="finish-button" onclick="finishPictureQuiz()">Завершити тест</button>
      </div>
    </div>

    <!-- Секція "Кросворд" -->
    <div id="crossword-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
      </div>
      <p class="crossword-note">* Не впливає на статистику слів</p>

      <!-- Сітка кросворда зверху -->
      <div id="crossword-container">
        <div id="crossword-grid-wrapper">
          <div id="crossword-grid"></div>
        </div>
      </div>

      <!-- Підказки знизу -->
      <div id="crossword-clues">
        <div class="clues-section">
          <div class="clues-header" onclick="toggleClues('across')">
            <h4>→ По горизонталі</h4>
            <i class="fas fa-chevron-down" id="across-chevron"></i>
          </div>
          <ul id="across-clues" class="clues-list"></ul>
        </div>
        <div class="clues-section">
          <div class="clues-header" onclick="toggleClues('down')">
            <h4>↓ По вертикалі</h4>
            <i class="fas fa-chevron-down" id="down-chevron"></i>
          </div>
          <ul id="down-clues" class="clues-list"></ul>
        </div>
      </div>

      <div id="crossword-actions">
        <button class="check-button" onclick="checkCrossword()">
          <i class="fas fa-check"></i> Перевірити
        </button>
        <button class="new-crossword-button" onclick="generateNewCrossword()">
          <i class="fas fa-sync-alt"></i> Новий
        </button>
      </div>

      <!-- Попап з результатом -->
      <div id="crossword-popup" class="crossword-popup hidden">
        <div class="crossword-popup-content">
          <div class="crossword-popup-icon" id="crossword-popup-icon">
            <i class="fas fa-trophy"></i>
          </div>
          <h3 id="crossword-popup-title">Вітаємо!</h3>
          <p id="crossword-popup-text">Кросворд розгадано правильно!</p>
          <div class="crossword-popup-buttons">
            <button class="popup-btn popup-btn-primary" onclick="closeCrosswordPopup()">OK</button>
            <button class="popup-btn popup-btn-secondary" id="popup-new-btn" onclick="closeCrosswordPopup(); generateNewCrossword();">
              <i class="fas fa-sync-alt"></i> Новий кросворд
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Секция "Тренування на слух" -->
    <div id="listening-training-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openListeningInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <!-- Попап для информации -->
      <div id="listening-quiz-container">
        <!-- Контент тренування буде динамічно додаватися тут -->
      </div>

      <div id="listening-progress">
        <div id="listening-progress-bar"></div>
      </div>
      <div id="listening-result" class="quiz-result hidden">
        <img src="" alt="Результат емодзі" id="listening-emoji">
        <p id="listening-result-text"></p>
        <button onclick="finishListening()">Завершити тренування</button>
      </div>
    </div>


    <!-- Секция "Тренування конструктор слова" -->
    <div id="word-constructor-training-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openConstructorInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <div id="word-constructor-quiz-container">
        <!-- Контент тренування буде динамічно додаватися тут -->
      </div>
      <div id="constructor-progress">
        <div id="constructor-progress-bar"></div>
      </div>
      <div id="constructor-quiz-result" class="constructor-quiz-result hidden">
        <img src="" alt="Результат емодзі" id="constructor-emoji">
        <p id="constructor-result-text"></p>
        <button onclick="finishConstructor()">Завершити тренування</button>
      </div>
    </div>

    <!-- Секція "Тренування на швидкість" -->
    <div id="speed-training-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openSpeedInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
      <div id="speed-training-info">
        <!-- Контент для выбора режима тренировки -->
        <p>Оберіть режим тренування:</p>
        <button id="ukr-to-eng-button" onclick="selectSpeedTrainingMode('ukr_to_eng')">З української на
          англійську</button>
        <button id="eng-to-ukr-button" onclick="selectSpeedTrainingMode('eng_to_ukr')">З англійської на
          українську</button>
      </div>
      <div id="speed-training-quiz" class="hidden">
        <div id="speed-training-timer">Час: 60 сек</div>
        <div id="speed-training-question"></div>
      </div>
      <div id="speed-training-result" class="hidden">
        <!-- Тут будуть результати тренування -->
      </div>
    </div>

    <!-- Секція "Оплата" -->
    <div id="payment-section" class="hidden">
      <h2>Термін підписки закінчився</h2>
      <p>Для подальшого використання додатку, будь ласка, оформіть підписку.</p>
      <button class="button-with-icon pay-button" onclick="showTariffs()">Оплатити</button>
    </div>
    <!-- Секція "Тарифи" -->
    <div id="tariffs-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <h2>Виберіть тариф</h2>
      </div>
      <div class="tariff">
        <h3>1 місяць</h3>
        <p>Повний доступ до всіх функцій на 1 місяць.</p>
        <div class="tariff-price">₴99</div>
        <button onclick="purchaseSubscription(30)">Купити</button>
      </div>
      <div class="tariff">
        <h3>3 місяці</h3>
        <p>Повний доступ до всіх функцій на 3 місяці.</p>
        <div class="tariff-price">₴249</div>
        <button onclick="purchaseSubscription(90)">Купити</button>
      </div>
      <div class="tariff">
        <h3>1 рік</h3>
        <p>Повний доступ до всіх функцій на 1 рік.</p>
        <div class="tariff-price">₴899</div>
        <button onclick="purchaseSubscription(365)">Купити</button>
      </div>
      <p>З Преміум підпискою ви зможете покращити свій рівень англійської швидше та ефективніше!</p>
    </div>

    <!-- Секція "Вставте пропущене слово" -->
    <div id="fill-blanks-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openFillBlanksInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>

      <!-- Вибір режиму -->
      <div id="fill-blanks-mode-selection">
        <p>Оберіть мову основного тексту:</p>
        <button id="fill-blanks-ukr-btn" onclick="selectFillBlanksMode('ukrainian')">
          <i class="fas fa-flag"></i> Українська
        </button>
        <button id="fill-blanks-eng-btn" onclick="selectFillBlanksMode('english')">
          <i class="fas fa-globe"></i> Англійська
        </button>
      </div>

      <!-- Контейнер тренування -->
      <div id="fill-blanks-training" class="hidden">
        <!-- Банк слів (зверху) -->
        <div id="fill-blanks-word-bank">
          <!-- Слова будуть додані динамічно -->
        </div>

        <!-- Речення з пропусками -->
        <div id="fill-blanks-sentences">
          <!-- Речення будуть додані динамічно -->
        </div>

        <!-- Кнопка перевірки -->
        <button id="fill-blanks-check-btn" class="check-button" onclick="checkFillBlanksAnswers()">
          Перевірити
        </button>
      </div>

      <!-- Прелоадер -->
      <div id="fill-blanks-loader" class="hidden">
        <div class="spinner"></div>
        <p>Генеруємо речення...</p>
      </div>

      <!-- Результат -->
      <div id="fill-blanks-result" class="hidden">
        <i id="fill-blanks-emoji" class=""></i>
        <p id="fill-blanks-result-text"></p>
        <button class="finish-button" onclick="finishFillBlanks()">Завершити тренування</button>
      </div>
    </div>

    <!-- Секція "Вгадай слово" -->
    <div id="definition-quiz-section" class="hidden">
      <div class="title-and-btn">
        <button class="button-with-icon back-button" onclick="backToAccount()">
          <i class="fas fa-arrow-left"></i>
          <span>Назад</span>
        </button>
        <button class="button-with-icon small-button info-button" onclick="openDefinitionQuizInfoPopup()">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>

      <!-- Вибір мови пояснень -->
      <div id="definition-quiz-mode-selection">
        <p>Оберіть мову пояснень:</p>
        <button onclick="selectDefinitionQuizMode('english')">
          <i class="fas fa-globe"></i> Англійська
        </button>
        <button onclick="selectDefinitionQuizMode('ukrainian')">
          <i class="fas fa-flag"></i> Українська
        </button>
      </div>

      <!-- Контейнер тренування -->
      <div id="definition-quiz-training" class="hidden">
        <div id="definition-quiz-definition" class="definition-box"></div>
        <div id="definition-quiz-options"></div>
      </div>

      <!-- Прогрес -->
      <div id="definition-quiz-progress" class="hidden">
        <div id="definition-quiz-progress-bar"></div>
        <div id="definition-quiz-question-number"></div>
      </div>

      <!-- Прелоадер -->
      <div id="definition-quiz-loader" class="hidden">
        <div class="spinner"></div>
        <p>Генеруємо пояснення...</p>
      </div>

      <!-- Результат -->
      <div id="definition-quiz-result" class="quiz-result hidden">
        <i id="definition-quiz-emoji"></i>
        <p id="definition-quiz-result-text"></p>
        <button class="finish-button" onclick="finishDefinitionQuiz()">Завершити тренування</button>
      </div>
    </div>

  </div>
  <!-- Підключення Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- Підключення бібліотеки для озвучки -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=Gq7zTuY8"></script>
  <!-- Підключення бібліотеки для HTTP-запитів -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // Ваші налаштування Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDGv20PKPYdPAQ_j5lX-UgmckSMb3M-3sk",
      authDomain: "engpuzzle-2d723.firebaseapp.com",
      projectId: "engpuzzle-2d723",
      storageBucket: "engpuzzle-2d723.appspot.com",
      messagingSenderId: "598252940695",
      appId: "1:598252940695:web:af908a6912218b3c8d68d2",
      measurementId: "G-67BCSGB7MN"
    };

    // Глобальна змінна для OpenAI API ключа
    let openaiApiKey = null;

    // Функція для отримання API ключа з Firestore
    async function loadOpenAIKey() {
      try {
        console.log('Loading API key from Firestore...');
        const snapshot = await db.collection('config').limit(1).get();
        console.log('Snapshot empty:', snapshot.empty);
        if (!snapshot.empty) {
          const data = snapshot.docs[0].data();
          console.log('Document data fields:', Object.keys(data));
          console.log('Document data:', data);
          // Підтримуємо різні назви полів
          openaiApiKey = data.openaiKey || data.api || data.key || data.apiKey;
          // Видаляємо можливі зайві пробіли, лапки, переноси рядків
          if (openaiApiKey) {
            openaiApiKey = openaiApiKey
              .trim()
              .replace(/^["']|["']$/g, '')
              .replace(/[\r\n\t]/g, '')
              .replace(/\s+/g, '');
            console.log('OpenAI API key loaded, length:', openaiApiKey.length);
          } else {
            console.error('API key field not found. Available fields:', Object.keys(data));
          }
        } else {
          console.error('No documents found in config collection');
        }
      } catch (error) {
        console.error('Error loading API key:', error);
      }
    }

    let speedTrainingWords = [];
    let currentSpeedQuestion = 0;
    let speedCorrectAnswers = 0;
    let speedTotalAnswers = 0;
    let speedTimer = 60; // 60 секунд
    let speedTrainingMode = ''; // 'ukr_to_eng' або 'eng_to_ukr'
    let speedTimerInterval;
    let repetitionWords = [];
    let currentRepetitionQuestion = 0;
    let repetitionCorrectAnswers = 0;

    checkForSharedWordsOnLoad();

    function startRepetitionTraining() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('repetition-training-section').classList.remove('hidden');
      initializeRepetitionTraining();
    }

    function initializeRepetitionTraining() {
      showLoading();
      const userId = auth.currentUser.uid;
      db.collection('users').doc(userId).collection('words').get()
        .then(querySnapshot => {
          let wordsArray = [];
          querySnapshot.forEach(doc => {
            const wordData = doc.data();
            if (wordData.interactions > 0 && wordData.lastInteractionDate) {
              wordsArray.push({
                english: doc.id,
                translation: wordData.translation,
                interactions: wordData.interactions || 0,
                correctAnswers: wordData.correctAnswers || 0,
                lastInteractionDate: wordData.lastInteractionDate.toDate()
              });
            }
          });

          console.log(wordsArray.length)

          if (wordsArray.length < 10) {
            document.getElementById('repetition-quiz-container').innerHTML =
              '<p>У вас недостатньо слів для тренування. Додайте більше слів до словника.</p>';
            hideLoading();
            return;
          }

          // Сортируем слова от давнего взаимодействия к недавнему
          wordsArray.sort((a, b) => a.lastInteractionDate - b.lastInteractionDate);
          repetitionWords = wordsArray.slice(0, 10);
          currentRepetitionQuestion = 0;
          repetitionCorrectAnswers = 0;
          showRepetitionQuestion();
          hideLoading();
        })
        .catch(error => {
          console.error('Помилка ініціалізації повторення:', error);
          hideLoading();
        });
    }

    function showRepetitionQuestion() {
      if (currentRepetitionQuestion >= repetitionWords.length) {
        showRepetitionResult();
        return;
      }

      function showRepetitionResult() {
        const repetitionContainer = document.getElementById('repetition-quiz-container');
        const repetitionProgress = document.getElementById('repetition-progress');
        const repetitionResult = document.getElementById('repetition-result');
        const repetitionEmoji = document.getElementById('repetition-emoji');
        const repetitionResultText = document.getElementById('repetition-result-text');

        // Скрываем контейнер и прогресс
        repetitionContainer.classList.add('hidden');
        repetitionProgress.classList.add('hidden');

        // Показываем результат
        repetitionResult.classList.remove('hidden');

        let iconClasses = '';
        let resultText = '';
        if (repetitionCorrectAnswers <= 4) {
          iconClasses = 'fas fa-sad-tear text-red-500';
          resultText = 'Не погано, але є місце для покращення.';
        } else if (repetitionCorrectAnswers <= 7) {
          iconClasses = 'fas fa-meh text-yellow-500';
          resultText = 'Добре! Але можна краще.';
        } else {
          iconClasses = 'fas fa-grin-stars text-green-500';
          resultText = 'Відмінно! Ви чудово знаєте ці слова!';
        }

        repetitionEmoji.className = '';
        repetitionEmoji.classList.add(...iconClasses.split(' '));
        repetitionResultText.textContent =
          `Правильних відповідей: ${repetitionCorrectAnswers} з ${repetitionWords.length}`;
      }


      const questionWord = repetitionWords[currentRepetitionQuestion];
      const options = [questionWord.translation];

      // Добавляем случайные переводы
      while (options.length < 4) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        if (!options.includes(randomWord.translation)) {
          options.push(randomWord.translation);
        }
      }

      // Перемешиваем варианты
      options.sort(() => 0.5 - Math.random());

      // Обновляем прогресс-бар и номер вопроса
      const progressPercent = ((currentRepetitionQuestion) / repetitionWords.length) * 100;
      document.getElementById('repetition-progress-bar').style.width = `${progressPercent}%`;
      document.getElementById('repetition-question-number').textContent =
        `${currentRepetitionQuestion + 1}/${repetitionWords.length}`;

      // Отображаем вопрос
      document.getElementById('repetition-quiz-container').innerHTML = `
    <h3>${questionWord.english}</h3>
    ${options.map(option => `<button class="check-word" onclick="checkRepetitionAnswer('${option.replace(/'/g, "\\'")}')">${option}</button>`).join('')}
  `;
    }

    function checkRepetitionAnswer(selectedOption) {
      const questionWord = repetitionWords[currentRepetitionQuestion];
      const buttons = document.querySelectorAll('#repetition-quiz-container button');
      buttons.forEach(button => {
        if (button.textContent === questionWord.translation) {
          button.classList.add('correct');
        } else if (button.textContent === selectedOption) {
          button.classList.add('incorrect');
        }
        button.disabled = true;
      });

      const correct = selectedOption === questionWord.translation;
      if (correct) {
        repetitionCorrectAnswers++;
      }

      // Обновляем статистику слова и дату последнего взаимодействия
      updateWordStats(questionWord.english, correct);

      // Обновляем прогресс-бар
      const progressPercent = ((currentRepetitionQuestion + 1) / repetitionWords.length) * 100;
      document.getElementById('repetition-progress-bar').style.width = `${progressPercent}%`;

      // Переходим к следующему вопросу через 1 секунду
      setTimeout(() => {
        currentRepetitionQuestion++;
        showRepetitionQuestion();
      }, 1000);
    }


    function startSpeedTraining() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('speed-training-section').classList.remove('hidden');

      const speedTrainingInfo = document.getElementById('speed-training-info');
      const errorClass = 'training-error'; // Класс для ошибки

      // Перевірка, чи достатньо слів для тренування
      if (allWords.length < 60) {
        // Отключаем кнопки
        document.getElementById('ukr-to-eng-button').disabled = true;
        document.getElementById('eng-to-ukr-button').disabled = true;

        // Проверяем, есть ли уже параграф с классом 'training-error'
        if (!speedTrainingInfo.querySelector(`.${errorClass}`)) {
          const errorParagraph = document.createElement('p');
          errorParagraph.classList.add(errorClass);
          errorParagraph.textContent = 'У вас недостатньо слів для тренування.';
          speedTrainingInfo.appendChild(errorParagraph);
        }
      } else {
        // Включаем кнопки
        document.getElementById('ukr-to-eng-button').disabled = false;
        document.getElementById('eng-to-ukr-button').disabled = false;

        // Удаляем сообщение об ошибке, если оно существует
        const existingError = speedTrainingInfo.querySelector(`.${errorClass}`);
        if (existingError) {
          existingError.remove();
        }
      }
    }


    function selectSpeedTrainingMode(mode) {
      speedTrainingMode = mode; // 'ukr_to_eng' або 'eng_to_ukr'
      document.getElementById('speed-training-info').classList.add('hidden');
      document.getElementById('speed-training-quiz').classList.remove('hidden');
      initializeSpeedTraining();
    }

    function initializeSpeedTraining() {
      // Выбираем 60 случайных слов
      speedTrainingWords = allWords.slice();
      // Перемешиваем массив слов
      speedTrainingWords.sort(() => 0.5 - Math.random());
      // Берем первые 60 слов
      speedTrainingWords = speedTrainingWords.slice(0, 60);

      if (speedTrainingWords.length < 60) {
        document.getElementById('speed-training-quiz').classList.add('hidden');
        document.getElementById('speed-training-info').classList.remove('hidden');
        document.getElementById('speed-training-info').innerHTML +=
          '<p style="color: red;">У вас недостатньо слів для тренування. Додайте більше слів до словника.</p>';
        return;
      }

      currentSpeedQuestion = 0;
      speedCorrectAnswers = 0;
      speedTotalAnswers = 0;
      speedTimer = 60;
      updateSpeedTimerDisplay();
      speedTimerInterval = setInterval(updateSpeedTimer, 1000);
      showSpeedQuestion();
    }


    function updateSpeedTimer() {
      speedTimer--;
      updateSpeedTimerDisplay();
      if (speedTimer <= 0) {
        clearInterval(speedTimerInterval);
        finishSpeedTraining();
      }
    }

    function updateSpeedTimerDisplay() {
      const timerElement = document.getElementById('speed-training-timer');
      timerElement.textContent = `Час: ${speedTimer} сек`;
      if (speedTimer <= 10) {
        timerElement.style.color = 'red';
      } else {
        timerElement.style.color = 'black';
      }
    }

    function showSpeedQuestion() {
      if (currentSpeedQuestion >= speedTrainingWords.length) {
        finishSpeedTraining();
        return;
      }
      const questionWord = speedTrainingWords[currentSpeedQuestion];
      let questionText = '';
      let options = [];
      if (speedTrainingMode === 'ukr_to_eng') {
        // Показываем украинское слово, варианты на английском
        questionText = questionWord.translation;
        options = [questionWord.english];
        // Добавляем случайные английские слова
        while (options.length < 4) {
          const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
          if (!options.includes(randomWord.english)) {
            options.push(randomWord.english);
          }
        }
      } else {
        // Показываем английское слово, варианты на украинском
        questionText = questionWord.english;
        options = [questionWord.translation];
        // Добавляем случайные украинские слова
        while (options.length < 4) {
          const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
          if (!options.includes(randomWord.translation)) {
            options.push(randomWord.translation);
          }
        }
      }
      // Перемешиваем варианты
      options.sort(() => 0.5 - Math.random());
      // Отображаем вопрос и варианты
      let questionHTML = `
    <button onclick="playSpeedWordSound()" class="listening-sound-icon"><i class="fas fa-volume-up"></i></button>
    <h3>${questionText}</h3>
    ${options.map(option => `<button onclick="checkSpeedAnswer('${option.replace(/'/g, "\\'")}', this)">${option}</button>`).join('')}
  `;
      document.getElementById('speed-training-question').innerHTML = questionHTML;
    }

    function playSpeedWordSound() {
      const questionWord = speedTrainingWords[currentSpeedQuestion];
      if (speedTrainingMode === 'ukr_to_eng') {
        responsiveVoice.speak(questionWord.translation, "Ukrainian Female");
      } else {
        responsiveVoice.speak(questionWord.english, "UK English Female");
      }
    }

    function checkSpeedAnswer(selectedOption, buttonElement) {
      const questionWord = speedTrainingWords[currentSpeedQuestion];
      let correctOption = '';
      if (speedTrainingMode === 'ukr_to_eng') {
        correctOption = questionWord.english;
      } else {
        correctOption = questionWord.translation;
      }
      speedTotalAnswers++;
      const isCorrect = selectedOption === correctOption;

      // Блокуємо всі кнопки
      const buttons = document.querySelectorAll('#speed-training-question button:not(.listening-sound-icon)');
      buttons.forEach(btn => btn.disabled = true);

      // Підсвічуємо тільки натиснуту кнопку (зелена якщо правильно, червона якщо ні)
      buttons.forEach(btn => {
        if (btn.textContent === selectedOption) {
          btn.classList.add(isCorrect ? 'speed-correct' : 'speed-incorrect');
        }
      });

      // Оновлюємо час та показуємо фідбек
      let timeFeedback = '';
      if (isCorrect) {
        speedCorrectAnswers++;
        speedTimer += 1;
        timeFeedback = '<span class="speed-time-feedback positive">+1</span>';
      } else {
        speedTimer -= 2;
        if (speedTimer < 0) speedTimer = 0;
        timeFeedback = '<span class="speed-time-feedback negative">-2</span>';
      }

      // Оновлюємо таймер з фідбеком
      const timerElement = document.getElementById('speed-training-timer');
      timerElement.innerHTML = `Час: ${speedTimer} сек ${timeFeedback}`;
      timerElement.style.color = speedTimer <= 10 ? 'red' : 'black';

      updateWordStats(questionWord.english, isCorrect);

      // Переходимо до наступного питання через 700мс
      setTimeout(() => {
        currentSpeedQuestion++;
        showSpeedQuestion();
      }, 700);
    }


    function finishSpeedTraining() {
      clearInterval(speedTimerInterval);
      document.getElementById('speed-training-quiz').classList.add('hidden');
      document.getElementById('speed-training-result').classList.remove('hidden');
      let percentage = Math.round((speedCorrectAnswers / speedTotalAnswers) * 100);
      let emojiUrl = '';
      let resultText = '';
      if (percentage <= 40) {
        emojiUrl = 'https://img.icons8.com/emoji/96/000000/sad-emoji.png';
        resultText = 'Не погано, але є місце для покращення.';
      } else if (percentage <= 80) {
        emojiUrl = 'https://img.icons8.com/emoji/96/000000/neutral-emoji.png';
        resultText = 'Добре! Але можна краще.';
      } else {
        emojiUrl = 'https://img.icons8.com/emoji/96/000000/smiling-face-with-sunglasses.png';
        resultText = 'Відмінно! Ви чудово знаєте ці слова!';
      }
      document.getElementById('speed-training-result').innerHTML = `
    <img src="${emojiUrl}" alt="Результат">
    <p>Правильних відповідей: ${speedCorrectAnswers} з ${speedTotalAnswers}</p>
    <p>${resultText}</p>
    <button class="finishSpeedButton" onclick="finishSpeedTrainingSession()">Завершити тренування</button>
  `;
    }

    function finishSpeedTrainingSession() {
      // Сброс переменных тренировки
      speedTrainingWords = [];
      currentSpeedQuestion = 0;
      speedCorrectAnswers = 0;
      speedTotalAnswers = 0;
      speedTimer = 60;
      speedTrainingMode = '';
      clearInterval(speedTimerInterval);
      // Скрываем секции тренировки
      document.getElementById('speed-training-info').classList.remove('hidden');
      document.getElementById('speed-training-quiz').classList.add('hidden');
      document.getElementById('speed-training-result').classList.add('hidden');
      // Возвращаемся на главный экран
      backToAccount();
    }

    // Закрити всі попапи
    function closeAllPopups() {
      closeAllInfoPopups();
      closeSharedWordsPopup();
    }

    // Закрити всі info попапи
    function closeAllInfoPopups() {
      const popups = ['speedInfoPopup', 'constructorInfoPopup', 'infoPopup', 'listeningInfoPopup',
                      'repetitionInfoPopup', 'generatorInfoPopup', 'pictureQuizInfoPopup',
                      'fillBlanksInfoPopup', 'wordInfoPopup'];
      popups.forEach(id => {
        const popup = document.getElementById(id);
        if (popup) popup.classList.remove('show');
      });
      document.querySelector('.overlay').classList.add('hidden');
    }

    function backToAccount() {
  // Закриваємо всі info попапи
  closeAllInfoPopups();

  // Если мы сейчас в режиме тренировки на скорость, сбрасываем его
  if (!document.getElementById('speed-training-section').classList.contains('hidden')) {
    exitSpeedTraining();
  }

  toggleMainTitle();
  document.getElementById('account-screen').classList.remove('hidden');
  document.getElementById('my-words-section').classList.add('hidden');
  document.getElementById('word-base-section').classList.add('hidden');
  document.getElementById('add-word-section').classList.add('hidden');
  document.getElementById('quiz-section').classList.add('hidden');
  document.getElementById('picture-quiz-section').classList.add('hidden');
  document.getElementById('payment-section').classList.add('hidden');
  document.getElementById('listening-training-section').classList.add('hidden');
  document.getElementById('word-constructor-training-section').classList.add('hidden');
  document.getElementById('speed-training-section').classList.add('hidden');
  document.getElementById('generative-text-section').classList.add('hidden');
  document.getElementById('tariffs-section').classList.add('hidden');
  document.getElementById('repetition-training-section').classList.add('hidden');
  document.getElementById('crossword-section').classList.add('hidden');
  document.getElementById('fill-blanks-section').classList.add('hidden');
  document.getElementById('definition-quiz-section').classList.add('hidden');
}

function exitSpeedTraining() {
  // Если таймер запущен, останавливаем его
  if (speedTimerInterval) {
    clearInterval(speedTimerInterval);
    speedTimerInterval = null;
  }
  // Сбрасываем переменные тренировки
  speedTrainingWords = [];
  currentSpeedQuestion = 0;
  speedCorrectAnswers = 0;
  speedTotalAnswers = 0;
  speedTimer = 60;
  speedTrainingMode = '';
  // Скрываем контейнеры с вопросами и результатами
  document.getElementById('speed-training-quiz').classList.add('hidden');
  document.getElementById('speed-training-result').classList.add('hidden');
  // Возвращаем меню выбора режима тренировки
  document.getElementById('speed-training-info').classList.remove('hidden');
}


    function hideMyVocabulatyAndOpenAddWords() {
      backToAccount();
      showWordBase();
    }
    // Ініціалізація Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Перемінні для стану завантаження
    let isLoading = false;
    // Функція для показу оверлея завантаження
    function showLoading() {
      isLoading = true;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }
    // Функція для приховування оверлея завантаження
    function hideLoading() {
      isLoading = false;
      document.getElementById('loading-overlay').classList.add('hidden');
    }
    // Показати форму реєстрації
    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    }
    // Показати форму входу
    function showLogin() {
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }
    // Реєстрація користувача
    async function register() {
      clearErrors();
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      let valid = true;
      if (!email) {
        document.getElementById('register-email-error').textContent = 'Введіть email.';
        valid = false;
      }
      if (!password) {
        document.getElementById('register-password-error').textContent = 'Введіть пароль.';
        valid = false;
      }
      if (!valid) return;

      showLoading();
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        const userId = auth.currentUser.uid;
        const registrationDate = new Date();
        const subscriptionExpiration = new Date();
        subscriptionExpiration.setDate(subscriptionExpiration.getDate() + 3); // 3 дня подписки

        await db.collection('users').doc(userId).set({
          email: email,
          registrationDate: firebase.firestore.Timestamp.fromDate(registrationDate),
          subscriptionExpiration: firebase.firestore.Timestamp.fromDate(subscriptionExpiration),
        });

        updateUI();
      } catch (error) {
        document.getElementById('register-password-error').textContent = error.message;
      } finally {
        hideLoading();
      }
    }

    // Вхід користувача
    async function login() {
      clearErrors();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      let valid = true;
      if (!email) {
        document.getElementById('login-email-error').textContent = 'Введіть email.';
        valid = false;
      }
      if (!password) {
        document.getElementById('login-password-error').textContent = 'Введіть пароль.';
        valid = false;
      }
      if (!valid) return;

      showLoading();
      try {
        await auth.signInWithEmailAndPassword(email, password);
        updateUI();
      } catch (error) {
        document.getElementById('login-password-error').textContent = error.message;
      } finally {
        hideLoading();
      }
    }

    // Вихід користувача
    function logout() {
      auth.signOut().then(() => {
        updateUI();
      });
    }
    // Очистка повідомлень про помилки
    function clearErrors() {
      const errorElements = document.querySelectorAll('.error-message');
      errorElements.forEach(el => el.textContent = '');
    }

    function finishRepetition() {
      // Возвращаемся на главный экран
      backToAccount();
      // Сбрасываем переменные
      repetitionWords = [];
      currentRepetitionQuestion = 0;
      repetitionCorrectAnswers = 0;
      // Сбрасываем UI
      document.getElementById('repetition-quiz-container').classList.remove('hidden');
      document.getElementById('repetition-progress').classList.remove('hidden');
      document.getElementById('repetition-result').classList.add('hidden');
    }

    // Оновлення інтерфейсу
    function updateUI() {
      const user = auth.currentUser;
      const buttonsRightCorner = document.querySelector('.buttons-right-corner');

      if (user) {
        buttonsRightCorner.classList.remove('hidden');
        showLoading();
        // Ховаємо форми входу та реєстрації
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('payment-section').classList.add('hidden');
        // Отримуємо дані користувача
        db.collection('users').doc(user.uid).get()
          .then(doc => {
            const userData = doc.data();
            document.querySelector('.user-email').textContent = userData.email;
            // Перевіряємо підписку
            checkSubscription(userData);
            if (userData.subscriptionExpiration && !userData.lifetime) {
              startSubscriptionTimer(userData.subscriptionExpiration.toDate());
            }
            // Завантажуємо слова одразу після входу
            return fetchWords();
          })
          .then(() => {
            // После полной загрузки интерфейса скрываем прелоадер
            hideLoading();
            document.getElementById('account-screen').classList.remove('hidden');
          })
          .catch(error => {
            console.error('Помилка при оновленні інтерфейсу:', error);
            hideLoading();
            showNotification('Сталася помилка при оновленні інтерфейсу. Спробуйте пізніше.', 'warning');
          });
      } else {
        buttonsRightCorner.classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('account-screen').classList.add('hidden');
        document.getElementById('my-words-section').classList.add('hidden');
        document.getElementById('word-base-section').classList.add('hidden');
        document.getElementById('add-word-section').classList.add('hidden');
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('picture-quiz-section').classList.add('hidden');
        document.getElementById('payment-section').classList.add('hidden');
        document.getElementById('listening-training-section').classList.add('hidden');
        document.getElementById('word-constructor-training-section').classList.add('hidden');
        document.getElementById('speed-training-section').classList.add('hidden');
        document.getElementById('generative-text-section').classList.add('hidden');
        document.getElementById('tariffs-section').classList.add('hidden');
        document.getElementById('repetition-training-section').classList.add('hidden');
        // Если пользователь не залогинен, прелоадер скрываем
        document.getElementById('loading-overlay').classList.add('hidden');
      }
    }

    // Перевірка підписки
    function checkSubscription(userData) {
      // Перевірка на lifetime підписку
      if (userData.lifetime === true) {
        document.getElementById('subscription-info').textContent = 'Підписка: Безкоштовно назавжди ∞';
        return;
      }

      const subscriptionExpiration = userData.subscriptionExpiration.toDate();
      const currentDate = new Date();
      const timeDiff = subscriptionExpiration - currentDate;
      const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
      if (daysLeft > 0) {
        document.getElementById('subscription-info').textContent =
          `Залишилось днів підписки: ${daysLeft}`;
      } else {
        document.getElementById('subscription-info').textContent = 'Підписка закінчилася.';
        document.getElementById('account-screen').classList.add('hidden');
        document.getElementById('payment-section').classList.remove('hidden');
      }
    }
    // Слідкуємо за змінами стану автентифікації
    auth.onAuthStateChanged(user => {
      updateUI();
      decodeLink();
      // Завантажуємо API ключ при авторизації
      if (user) {
        loadOpenAIKey();
      }
      // Ховаємо прелоадер після завантаження
      const preloader = document.getElementById('page-preloader');
      if (preloader) {
        preloader.classList.add('hidden');
      }
    });
    // Показати "Мої слова"
    function showMyWords() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('my-words-section').classList.remove('hidden');
      fetchWords();
    }

    function toggleMainTitle() {
      let titleMain = document.querySelector('.title-main');
      let buttonsCorner = document.querySelector('.buttons-right-corner');
      titleMain.classList.toggle('hidden');
      if (buttonsCorner) buttonsCorner.classList.toggle('hidden');
    }

    function showWordBase() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('word-base-section').classList.remove('hidden');
      document.getElementById('topics-list').classList.remove('hidden');
      document.getElementById('topic-words').classList.add('hidden');
      fetchTopics();
    }
    // Змінні для зберігання слів та пагінації
    let allWords = [];
    let displayedWords = [];
    let wordsPerPage = 75;
    let currentIndex = 0;

    // Pixabay API для картинок
    const PIXABAY_API_KEY = '54291742-73149c2c16aa6fdcab8cb22d4';
    const imageCache = {};

    async function getWordImage(word) {
      if (imageCache[word]) return imageCache[word];
      if (PIXABAY_API_KEY === 'YOUR_PIXABAY_API_KEY') return null;

      try {
        const response = await fetch(`https://pixabay.com/api/?key=${PIXABAY_API_KEY}&q=${encodeURIComponent(word)}&image_type=photo&per_page=3&safesearch=true`);
        const data = await response.json();
        if (data.hits && data.hits.length > 0) {
          imageCache[word] = data.hits[0].previewURL;
          return data.hits[0].previewURL;
        }
      } catch (error) {
        console.log('Помилка завантаження картинки:', error);
      }
      return null;
    }
    // Отримання та відображення слів користувача
    async function fetchWords() {
      try {
        showLoading();
        if (!auth.currentUser) {
          console.error('Користувач не автентифікований.');
          hideLoading();
          showNotification('Ви не автентифіковані. Будь ласка, увійдіть у систему.', 'warning');
          return Promise.reject('User not authenticated');
        }

        const userId = auth.currentUser.uid;
        console.log(`Отримання слів для користувача: ${userId}`);

        const querySnapshot = await db
          .collection('users')
          .doc(userId)
          .collection('words')
          .orderBy('dateAdded', 'desc')
          .get();

        console.log(`Знайдено ${querySnapshot.size} слів.`);
        allWords = [];
        querySnapshot.forEach(doc => {
          const wordData = doc.data();
          allWords.push({
            english: doc.id,
            translation: wordData.translation,
            example: wordData.example || '',
            interactions: wordData.interactions || 0,
            correctAnswers: wordData.correctAnswers || 0,
            dateAdded: wordData.dateAdded,
          });
        });

        console.log('Слова успішно завантажені:', allWords);
        currentIndex = 0;
        displayedWords = [];
        document.getElementById('words').innerHTML = '';
        displayNextWords();
        hideLoading();
        updateSadCatVisibility();
      } catch (error) {
        console.error('Помилка при отриманні слів:', error);
        hideLoading();
        showNotification('Сталася помилка при отриманні слів. Спробуйте пізніше.', 'warning');
      }
    }

    // Відображення наступних слів
    function displayNextWords() {
      const wordsElement = document.getElementById('words');
      const wordsToShow = allWords.slice(currentIndex, currentIndex + wordsPerPage);
      displayedWords = displayedWords.concat(wordsToShow);
      currentIndex += wordsPerPage;

      wordsToShow.forEach(async (word) => {
        const li = document.createElement('li');
        // Добавляем обработчик клика на элемент списка
        li.onclick = () => showWordInfo(word);

        // Иконка озвучивания
        const soundIcon = document.createElement('i');
        soundIcon.classList.add('fas', 'fa-volume-up');
        soundIcon.onclick = (e) => {
          e.stopPropagation(); // Останавливаем всплытие события
          responsiveVoice.speak(word.english, "UK English Female");
        };
        li.appendChild(soundIcon);

        // Информация о слове
        const wordInfo = document.createElement('div');
        wordInfo.innerHTML = `<strong>${word.english}</strong> - ${word.translation}<br><em>${word.example}</em>`;
        li.appendChild(wordInfo);

        // Кнопка удаления
        const deleteBtn = document.createElement('i');
        deleteBtn.classList.add('fas', 'fa-trash');
        deleteBtn.onclick = (e) => {
          e.stopPropagation(); // Останавливаем всплытие события
          deleteWord(word.english, li);
        };
        li.appendChild(deleteBtn);

        wordsElement.appendChild(li);
      });
      document.getElementById('word-count').textContent = `Загальна кількість слів: ${allWords.length}`;
      updateSadCatVisibility();
    }

    async function showWordInfo(word) {
      const interactions = word.interactions || 0;
      const correctAnswers = word.correctAnswers || 0;
      const percentage = interactions > 0 ? Math.round((correctAnswers / interactions) * 100) : 0;

      // Отримуємо картинку слова
      const imgUrl = await getWordImage(word.english);
      const imageHtml = imgUrl ? `<img src="${imgUrl}" alt="${word.english}" style="display: block; margin: 0 auto 15px auto; max-width: 200px; border-radius: 10px;">` : '';

      const popupContent = `
    <div class="popup-content">
      ${imageHtml}
      <h3>Інформація про слово "${word.english}"</h3>
      <p>Кількість взаємодій: ${interactions}</p>
      <p>Правильних відповідей: ${correctAnswers}</p>
      <p>Відсоток правильних відповідей: ${percentage}%</p>
      <button style="margin-top: 20px; width: 100%; padding: 15px; background: #333; color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: 600;" onclick="closePopupWord()">Закрити</button>
    </div>
  `;

      const popup = document.getElementById('wordInfoPopup');
      popup.innerHTML = popupContent;
      document.querySelector('.overlay').classList.remove('hidden');
      popup.classList.add('show');
    }

    function closePopupWord() {
      const popup = document.getElementById('wordInfoPopup');
      if (popup) {
        popup.classList.remove('show');
      }
      document.querySelector('.overlay').classList.add('hidden');
    }

    let currentOptionType = '';
    let currentOptionButton = null;

    function openOptionMenu(type, button) {
      currentOptionType = type;
      currentOptionButton = button;
      const menu = document.getElementById('option-menu');
      const title = document.getElementById('option-menu-title');
      const list = document.getElementById('option-menu-list');
      list.innerHTML = '';

      let options = [];
      const icons = {
        'Пригоди': 'fa-compass',
        'Містика': 'fa-ghost',
        'Романтика': 'fa-heart',
        'Наукова фантастика': 'fa-rocket',
        'Гумор': 'fa-face-laugh',
        'Повсякденне спілкування': 'fa-comments',
        'Легкий': 'fa-seedling',
        'Середній': 'fa-leaf',
        'Складний': 'fa-tree',
        'Короткий (250 символів)': 'fa-minus',
        'Середній (500 символів)': 'fa-bars',
        'Довгий (1200 символів)': 'fa-align-justify'
      };

      if (type === 'text-style') {
        options = ['Пригоди', 'Містика', 'Романтика', 'Наукова фантастика', 'Гумор', 'Повсякденне спілкування'];
      } else if (type === 'text-difficulty') {
        options = ['Легкий', 'Середній', 'Складний'];
      } else if (type === 'text-length') {
        options = ['Короткий (250 символів)', 'Середній (500 символів)', 'Довгий (1200 символів)'];
      }

      options.forEach(option => {
        const li = document.createElement('li');
        const optionButton = document.createElement('button');
        const icon = icons[option] || 'fa-circle';
        optionButton.innerHTML = `<i class="fas ${icon}"></i> ${option}`;
        optionButton.onclick = () => selectOption(option);
        li.appendChild(optionButton);
        list.appendChild(li);
      });

      menu.classList.remove('hidden');
      setTimeout(() => {
        menu.classList.add('show');
      }, 10);
    }

    function closeOptionMenu() {
      const menu = document.getElementById('option-menu');
      menu.classList.remove('show');
      setTimeout(() => {
        menu.classList.add('hidden');
      }, 300);
    }

    // Функція для декодування Base64 з підтримкою UTF-8
    function b64DecodeUnicode(str) {
      // Замінюємо символи URL-безпечного Base64 на стандартні символи Base64
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      // Додаємо padding, якщо необхідно
      while (str.length % 4) {
        str += '=';
      }
      // Декодуємо Base64 в бінарний рядок
      const binary = atob(str);
      // Перетворюємо бінарний рядок у масив байтів
      const bytes = Uint8Array.from(binary, c => c.charCodeAt(0));
      // Декодуємо байти у строку UTF-8
      const decoder = new TextDecoder();
      return decoder.decode(bytes);
    }


    function selectOption(option) {
      const icons = {
        'Пригоди': 'fa-compass',
        'Містика': 'fa-ghost',
        'Романтика': 'fa-heart',
        'Наукова фантастика': 'fa-rocket',
        'Гумор': 'fa-face-laugh',
        'Повсякденне спілкування': 'fa-comments',
        'Легкий': 'fa-seedling',
        'Середній': 'fa-leaf',
        'Складний': 'fa-tree',
        'Короткий (250 символів)': 'fa-minus',
        'Середній (500 символів)': 'fa-bars',
        'Довгий (1200 символів)': 'fa-align-justify'
      };
      if (currentOptionButton) {
        const icon = icons[option] || '';
        currentOptionButton.innerHTML = icon ? `<i class="fas ${icon}"></i> ${option}` : option;
        currentOptionButton.dataset.value = option;
      }
      localStorage.setItem(currentOptionType, option);
      closeOptionMenu();
    }


    function closePopup() {
      const popupOverlay = document.getElementById('popup-overlay');
      if (popupOverlay) {
        popupOverlay.remove();
      }
    }
    // Пошук слова
    document.getElementById('search-input').addEventListener('input', function () {
      const query = this.value.toLowerCase();
      const filteredWords = allWords.filter(word =>
        word.english.toLowerCase().includes(query) || word.translation.toLowerCase().includes(query)
      );
      displayedWords = filteredWords.slice(0, currentIndex);
      displaySearchedWords(filteredWords);
    });

    function displaySearchedWords(words) {
      const wordsElement = document.getElementById('words');
      wordsElement.innerHTML = '';
      words.forEach(async (word) => {
        const li = document.createElement('li');
        // Добавляем обработчик клика на элемент списка
        li.onclick = () => showWordInfo(word);

        // Иконка озвучивания
        const soundIcon = document.createElement('i');
        soundIcon.classList.add('fas', 'fa-volume-up');
        soundIcon.onclick = (e) => {
          e.stopPropagation(); // Останавливаем всплытие события
          responsiveVoice.speak(word.english, "UK English Female");
        };
        li.appendChild(soundIcon);

        // Информация о слове
        const wordInfo = document.createElement('div');
        wordInfo.innerHTML = `<strong>${word.english}</strong> - ${word.translation}<br><em>${word.example}</em>`;
        li.appendChild(wordInfo);

        // Кнопка удаления
        const deleteBtn = document.createElement('i');
        deleteBtn.classList.add('fas', 'fa-trash');
        deleteBtn.onclick = (e) => {
          e.stopPropagation(); // Останавливаем всплытие события
          deleteWord(word.english, li);
        };
        li.appendChild(deleteBtn);

        wordsElement.appendChild(li);
      });
      updateSadCatVisibility();
    }

    // Видалення слова користувача з анімацією
    function deleteWord(word, listItem) {
      const userId = auth.currentUser.uid;
      db.collection('users').doc(userId).collection('words').doc(word).delete()
        .then(() => {
          listItem.classList.add('fade-out');
          listItem.addEventListener('animationend', () => {
            listItem.remove();
            // Оновлення лічильника слів
            allWords = allWords.filter(w => w.english !== word);
            document.getElementById('word-count').textContent =
              `Загальна кількість слів: ${allWords.length}`;
            if (allWords.length === 0) {
              document.getElementById('add-word-from-my-vocabulary').classList.remove(
                'hidden');
            }
          });
        });
      updateSadCatVisibility();
    }
    // Показати "Додати слово"
    function showAddWord() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('add-word-section').classList.remove('hidden');
      document.getElementById('translation-suggestions').innerHTML = '';
    }

    async function addWord() {
      clearErrors();
      const englishWord = document.getElementById('english-word').value.trim();
      const translation = document.getElementById('translation').value.trim();
      const example = document.getElementById('example').value.trim();

      const englishRegex = /^[A-Za-z\s]{1,50}$/;
      let valid = true;
      if (!englishRegex.test(englishWord)) {
        document.getElementById('english-word-error').textContent = 'Введіть коректне англійське слово.';
        valid = false;
      }
      if (!translation) {
        document.getElementById('translation-error').textContent = 'Введіть переклад.';
        valid = false;
      }
      if (!valid) return;

      showLoading();
      try {
        const userId = auth.currentUser.uid;
        const doc = await db.collection('users').doc(userId).collection('words').doc(englishWord).get();
        if (doc.exists) {
          document.getElementById('english-word-error').textContent = 'Це слово вже існує.';
          showNotification(`Слово "${englishWord}" вже є у вашому словнику.`, 'warning');
        } else {
          await db.collection('users').doc(userId).collection('words').doc(englishWord).set({
            translation: translation,
            example: example || '',
            interactions: 0,
            correctAnswers: 0,
            dateAdded: firebase.firestore.Timestamp.now(),
          });

          // Очистка полей
          document.getElementById('english-word').value = '';
          document.getElementById('translation').value = '';
          document.getElementById('example').value = '';
          document.getElementById('translation-suggestions').innerHTML = '';

          // Обновление списка слов
          await fetchWords();
          showNotification(`Слово "${englishWord}" успішно додано.`);
        }
      } catch (error) {
        console.error('Помилка при додаванні слова:', error);
        showNotification('Сталася помилка при додаванні слова. Спробуйте пізніше.', 'warning');
      } finally {
        hideLoading();
      }
    }

    // Функция для открытия попапа
    function showInfoPopup(title, description, algorithm = null) {
      const popup = document.getElementById('infoPopup');
      let html = `
        <p class="training-title-desc">${title}</p>
        <p class="description">${description}</p>
      `;
      if (algorithm) {
        html += `
          <div class="algorithm-block" onclick="toggleAlgorithm(this)">
            <div class="algorithm-header">
              <p>Як підбираються слова</p>
              <i class="fas fa-chevron-down algorithm-chevron"></i>
            </div>
            <ol class="algorithm-content">
              ${algorithm.map(item => `<li>${item}</li>`).join('')}
            </ol>
          </div>
        `;
      }
      html += `<button class="close-button" onclick="closeInfoPopup()">Закрити</button>`;
      popup.innerHTML = html;
      document.querySelector('.overlay').classList.remove('hidden');
      popup.classList.add('show');
    }

    function toggleAlgorithm(element) {
      element.classList.toggle('open');
    }

    function openInfoPopup() {
      showInfoPopup(
        'Тестування',
        'Оберіть правильний переклад слова з 4 варіантів відповідей. Тренування допомагає закріпити знання слів.',
        [
          'Алгоритм обирає 10 слів зі словника.',
          'Спочатку використовуються нові слова (менше 3 взаємодій).',
          'Якщо нових слів недостатньо, додаються слова від складних до простих.',
          'Складність визначається відсотком правильних відповідей.'
        ]
      );
    }

    function closeInfoPopup() {
      const popup = document.getElementById('infoPopup');
      popup.classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }
    // Закрытие попапа при клике вне его содержимого
    window.onclick = function (event) {
      const popup = document.getElementById('infoPopup');
      // Проверяем, был ли клик вне содержимого попапа
      if (event.target === popup) {
        popup.classList.add('hidden');
      }
    }

    function fetchTopics() {
      const topicIcons = {
        'Actions': '🏃',
        'Animals': '🐾',
        'Body Parts': '🦴',
        'Clothing': '👕',
        'Colors': '🎨',
        'Countries': '🌍',
        'Emotions': '😊',
        'Family': '👨‍👩‍👧‍👦',
        'Food': '🍔',
        'Furniture': '🛋️',
        'Jobs': '💼',
        'Nature': '🌿',
        'School': '📚',
        'Sports': '⚽',
        'Technology': '💻',
        'Transport': '🚗',
        'Vegetables': '🥕',
        'Weather': '☀️'
      };

      showLoading();
      db.collection('wordBase').get()
        .then(querySnapshot => {
          const topicsList = document.getElementById('topics-list');
          topicsList.innerHTML = '';
          querySnapshot.forEach(doc => {
            const topicName = doc.id;
            const tile = document.createElement('div');
            tile.classList.add('topic-tile');
            tile.onclick = () => showTopicWords(topicName);
            const icon = topicIcons[topicName] || '📖';
            tile.innerHTML = `<span class="topic-icon">${icon}</span><span class="topic-name">${topicName}</span>`;
            topicsList.appendChild(tile);
          });
          hideLoading();
        })
        .catch(error => {
          console.error('Помилка при отриманні тем:', error);
          hideLoading();
        });
    }
    // Показати слова по темі
    function showTopicWords(topic) {
      console.log(`Выбрана тема: ${topic}`);
      // Скрываем список тем
      document.getElementById('topics-list').classList.add('hidden');
      // Показываем секцию слов темы
      document.getElementById('topic-words').classList.remove('hidden');
      // Устанавливаем название темы
      document.getElementById('topic-title').textContent = topic;
      // Ховаємо кнопку "Назад" (залишаємо тільки "Назад до тем")
      document.getElementById('word-base-back-button').classList.add('hidden');
      // Показываем кнопки "Назад к темам" и "Добавить все слова"
      const titleAndButton = document.querySelector('.title-and-btn');
      titleAndButton.classList.remove('hidden');
      // Показываем оверлей загрузки
      showLoading();
      // Получаем слова из выбранной темы из Firestore
      db.collection('wordBase').doc(topic).collection('words').get()
        .then(querySnapshot => {
          const wordsList = document.getElementById('topic-words-list');
          wordsList.innerHTML = ''; // Очищаем предыдущие слова
          querySnapshot.forEach(doc => {
            const wordData = doc.data();
            const li = document.createElement('li');
            li.classList.add('word-card');
            // Иконка озвучивания
            const soundIcon = document.createElement('i');
            soundIcon.classList.add('fas', 'fa-volume-up');
            soundIcon.onclick = () => {
              responsiveVoice.speak(doc.id, "UK English Female");
            };
            li.appendChild(soundIcon);
            // Информация о слове
            const wordInfo = document.createElement('div');
            wordInfo.innerHTML = `<strong>${doc.id}</strong> - ${wordData.translation}`;
            li.appendChild(wordInfo);
            // Иконка добавления в словарь
            const addIcon = document.createElement('i');
            addIcon.classList.add('fas', 'fa-plus');
            addIcon.style.color = 'black';
            addIcon.style.cursor = 'pointer';
            addIcon.onclick = () => addWordToMyDictionary(doc.id, wordData, li);
            li.appendChild(addIcon);
            wordsList.appendChild(li);
          });
          hideLoading();
        })
        .catch(error => {
          console.error('Ошибка при получении слов темы:', error);
          hideLoading();
          showNotification('Произошла ошибка при загрузке слов темы. Попробуйте позже.', 'warning');
        });
    }

    // Функція для показу сповіщень
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.classList.add('notification');
      if (type === 'warning') {
        notification.classList.add('warning');
      }
      notification.textContent = message;
      document.body.appendChild(notification);
      // Видаляємо повідомлення через 3 секунди
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }


    // Функція для перевірки та обробки поділених слів при завантаженні сторінки
    function checkForSharedWordsOnLoad() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('share')) {
        const encodedWords = urlParams.get('share');
        try {
          // Декодуємо параметр URL
          const decodedParam = decodeURIComponent(encodedWords);
          // Декодуємо Base64 з підтримкою UTF-8
          const wordsJSON = b64DecodeUnicode(decodedParam);
          // Парсимо JSON
          const sharedWords = JSON.parse(wordsJSON);
          // Перевіряємо, чи вже показували попап у поточній сесії
          const popupShown = sessionStorage.getItem('sharedWordsPopupShown');
          if (!popupShown) {
            showSharedWordsPopup(sharedWords);
            // Встановлюємо прапорець, що попап показано
            sessionStorage.setItem('sharedWordsPopupShown', 'true');
          }
        } catch (error) {
          console.error('Помилка при парсингу поділених слів:', error);
          showNotification('Невдала спроба поділитися словами.', 'warning');
        }
      }
    }

    function playWordSound(word) {
      responsiveVoice.speak(word, "UK English Female");
    }
    // Функція для відображення попапу з поділеними словами
    function showSharedWordsPopup(words) {
      const popup = document.getElementById('sharedWordsPopup');
      const wordsContainer = document.getElementById('shared-words-container');
      wordsContainer.innerHTML = ''; // Clear previous content

      words.forEach(word => {
        const wordCard = document.createElement('div');
        wordCard.classList.add('word-card');

        // Sound icon
        const soundIcon = document.createElement('i');
        soundIcon.classList.add('fas', 'fa-volume-up');
        soundIcon.onclick = () => {
          responsiveVoice.speak(word.english, "UK English Female");
        };
        wordCard.appendChild(soundIcon);

        // Word info
        const wordInfo = document.createElement('div');
        wordInfo.innerHTML = `<strong>${word.english}</strong> - ${word.translation}`;
        wordCard.appendChild(wordInfo);

        // Add icon
        const addIcon = document.createElement('i');
        addIcon.classList.add('fas', 'fa-plus');
        addIcon.onclick = () => addWordFromShared(word.english, word.translation, addIcon);
        wordCard.appendChild(addIcon);

        wordsContainer.appendChild(wordCard);
      });

      // Message under the title
      document.getElementById('sharedWordsMessage').textContent =
        'Слова, які вже є у вашому словнику, додані не будуть.';

      // Show the popup and overlay
      popup.classList.remove('hidden');
      document.querySelector('.overlay').classList.remove('hidden');

      // Add animation class
      popup.classList.add('popup-animate');
    }



    // Функція для закриття попапу
    function closeSharedWordsPopup() {
      const popup = document.getElementById('sharedWordsPopup');
      popup.classList.remove('popup-animate');
      popup.classList.add('hidden');
      document.querySelector('.overlay').classList.add('hidden');

      // Remove URL parameters after closing the popup
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    function markStoryAsRead() {
  // Видаляємо збережені дані про історію
  localStorage.removeItem("generatedStoryTitle");
  localStorage.removeItem("generatedStoryText");

  // Ховаємо блок зі згенерованим текстом та кнопками дій
  document.getElementById('generated-story').classList.add('hidden');
  document.getElementById('story-actions').classList.add('hidden');

  // Повертаємо користувачу доступ до налаштувань (стиль, складність, довжина) та кнопки «Сгенерувати»
  document.querySelectorAll('.title-wrapper').forEach(el => el.style.display = 'flex');
  document.querySelectorAll('.option-button').forEach(btn => btn.disabled = false);
  document.querySelector('.generate').disabled = false;
  document.querySelector('.generate').style.display = 'inline-block';
}


    // Функція для додавання окремого слова з попапу
    async function addWordFromShared(english, translation, addIcon) {
      try {
        const userId = auth.currentUser.uid;
        const wordRef = db.collection('users').doc(userId).collection('words').doc(english);
        const doc = await wordRef.get();
        if (doc.exists) {
          // Show message in the popup
          showMessageInPopup(`Слово "${english}" вже є у вашому словнику.`, 'warning');
        } else {
          await wordRef.set({
            translation: translation,
            example: '',
            interactions: 0,
            correctAnswers: 0,
            dateAdded: firebase.firestore.Timestamp.now(),
          });
          // Show success message in the popup
          showMessageInPopup(`Слово "${english}" додано до вашого словника.`);
          // Hide the add icon
          addIcon.style.display = 'none';
        }
      } catch (error) {
        console.error(`Помилка при додаванні слова "${english}":`, error);
        showMessageInPopup('Сталася помилка при додаванні слова. Спробуйте пізніше.', 'warning');
      }
    }



    // Функція для додавання всіх слів з попапу
    async function addAllSharedWords() {
      const wordsList = document.getElementById('shared-words-container');
      const wordCards = wordsList.querySelectorAll('.word-card');

      const wordsToAdd = [];
      wordCards.forEach(card => {
        const english = card.querySelector('strong').textContent;
        const translation = card.querySelector('strong').nextSibling.textContent.trim().split('-')[1].trim();
        const addIcon = card.querySelector('.fa-plus');
        wordsToAdd.push({
          english,
          translation,
          addIcon
        });
      });

      const userId = auth.currentUser.uid;
      let wordsAdded = 0;
      let wordsAlreadyExists = 0;

      try {
        for (const wordObj of wordsToAdd) {
          const wordRef = db.collection('users').doc(userId).collection('words').doc(wordObj.english);
          const doc = await wordRef.get();
          if (!doc.exists) {
            await wordRef.set({
              translation: wordObj.translation,
              example: '',
              interactions: 0,
              correctAnswers: 0,
              dateAdded: firebase.firestore.Timestamp.now(),
            });
            wordsAdded++;
            // Hide the add icon
            wordObj.addIcon.style.display = 'none';
          } else {
            wordsAlreadyExists++;
          }
        }

        // Show summary message inside the popup
        let summaryMessage = '';
        if (wordsAdded > 0) {
          summaryMessage += `Додано ${wordsAdded} нових слів до вашого словника. `;
        }
        if (wordsAlreadyExists > 0) {
          summaryMessage += `Слів, які вже є у словнику: ${wordsAlreadyExists}.`;
        }
        if (summaryMessage === '') {
          summaryMessage = 'Усі слова вже є у вашому словнику.';
        }
        showMessageInPopup(summaryMessage);
      } catch (error) {
        console.error('Помилка при додаванні всіх слів:', error);
        showMessageInPopup('Сталася помилка при додаванні слів. Спробуйте пізніше.', 'warning');
      }
    }

    function showMessageInPopup(message, type = 'success') {
      const popupMessage = document.getElementById('popupMessage');
      popupMessage.textContent = message;
      popupMessage.className = 'popup-message'; // Reset classes
      if (type === 'warning') {
        popupMessage.classList.add('warning');
      }
    }

    function showMessageInCard(card, message, type = 'success') {
      let messageElement = card.querySelector('.message');
      if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.classList.add('message');
        card.appendChild(messageElement);
      }
      messageElement.textContent = message;
      messageElement.className = 'message'; // Reset classes
      messageElement.classList.add(type);
    }

    function showMessageInPopup(message, type = 'success') {
      const popupMessage = document.getElementById('popupMessage');
      popupMessage.textContent = message;
      popupMessage.className = ''; // Reset classes
      popupMessage.classList.add(type);
    }






    // Додавання слова з бази до особистого словника
    async function addWordToMyDictionary(word, wordData, listItem) {
      const userId = auth.currentUser.uid;
      const userWordRef = db.collection('users').doc(userId).collection('words').doc(word);

      try {
        const docSnapshot = await userWordRef.get();
        if (docSnapshot.exists) {
          showNotification(`Слово "${word}" вже є у вашому словнику.`, 'warning');
        } else {
          await userWordRef.set({
            translation: wordData.translation,
            example: wordData.example || '',
            interactions: 0,
            correctAnswers: 0,
            dateAdded: firebase.firestore.Timestamp.now(),
          });
          showNotification(`Слово "${word}" додано до вашого словника.`);

          // Добавляем анимацию
          listItem.classList.add('added-word');
          listItem.addEventListener('animationend', () => {
            listItem.classList.remove('added-word');
          });
        }
      } catch (error) {
        console.error(`Помилка при додаванні слова "${word}":`, error);
        showNotification('Сталася помилка при додаванні слова. Спробуйте пізніше.', 'warning');
      }
    }

    async function addAllWordsFromTopic(topic) {
  const addAllBtn = document.getElementById('addAllButton');
  // Зберігаємо початковий вміст кнопки
  const originalContent = addAllBtn.innerHTML;
  // Встановлюємо HTML з прелоадером (можна задати inline-стилі або використовувати окремий CSS клас)
  addAllBtn.innerHTML = '<div style="width:20px;height:20px;border:2px solid #000;border-top:2px solid white;border-radius:50%;animation: spin 1s linear infinite;margin:0 auto;"></div>';
  
  // (Опційно) можна відключити кнопку, щоб уникнути повторних кліків
  addAllBtn.disabled = true;
  
  const userId = auth.currentUser.uid;
  showLoading();
  try {
    const topicRef = db.collection('wordBase').doc(topic);
    const wordsSnapshot = await topicRef.collection('words').get();
    const batch = db.batch();
    let wordsAdded = 0;

    for (const wordDoc of wordsSnapshot.docs) {
      const wordData = wordDoc.data();
      const userWordRef = db.collection('users').doc(userId).collection('words').doc(wordDoc.id);
      const docSnapshot = await userWordRef.get();
      if (!docSnapshot.exists) {
        batch.set(userWordRef, {
          translation: wordData.translation,
          example: wordData.example || '',
          interactions: 0,
          correctAnswers: 0,
          dateAdded: firebase.firestore.Timestamp.now(),
        });
        wordsAdded++;
      }
    }

    if (wordsAdded > 0) {
      await batch.commit();
      showNotification(`Нові слова з цієї теми додано до вашого словника.`);
    } else {
      showNotification(`Усі слова з цієї теми вже є у вашому словнику.`, 'warning');
    }
  } catch (error) {
    console.error('Помилка додавання слів з теми:', error);
    showNotification('Сталася помилка при додаванні слів. Спробуйте пізніше.', 'warning');
  } finally {
    // Повертаємо початковий вміст кнопки і включаємо її
    addAllBtn.innerHTML = originalContent;
    addAllBtn.disabled = false;
    hideLoading();
  }
  updateSadCatVisibility();
}

function copyStory() {
  const title = document.getElementById('story-title').innerText;
  const text = document.getElementById('story-text').innerText;
  const fullText = title + "\n" + text;
  navigator.clipboard.writeText(fullText).then(() => {
    const copyBtn = document.getElementById('copy-story-btn');
    copyBtn.style.backgroundColor = '#4CAF50';
    copyBtn.classList.add('copy-animation');
    showNotification('Скопійовано!', 'success');
    setTimeout(() => {
      copyBtn.style.backgroundColor = '';
      copyBtn.classList.remove('copy-animation');
    }, 2000);
  }).catch(err => {
    console.error('Помилка копіювання:', err);
    showNotification('Помилка копіювання', 'error');
  });
}


    function openSpeedInfoPopup() {
      showInfoPopup(
        'Опис тренування:',
        'Вам дається 60 секунд. За кожну правильну відповідь +1 секунда. За кожну неправильну -2 секунди. Мінімальна кількість слів для тренування: 60.',
        [
          'Алгоритм обирає 10 слів.',
          'Початково використовуються нові слова.',
          'Якщо нових слів недостатньо, додаються слова від складних до простих. Складність визначається відсотком правильних відповідей в попередніх тестах'
        ]
      );
    }

    function closeSpeedInfoPopup() {
      document.getElementById('speedInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }


    // Додати всі слова з теми до словника
    function addAllWords() {
      const userId = auth.currentUser.uid;
      showLoading();
      db.collection('wordBase').get()
        .then(querySnapshot => {
          const batch = db.batch();
          querySnapshot.forEach(topicDoc => {
            topicDoc.ref.collection('words').get()
              .then(wordsSnapshot => {
                wordsSnapshot.forEach(wordDoc => {
                  const wordData = wordDoc.data();
                  const userWordRef = db.collection('users').doc(userId)
                    .collection('words').doc(wordDoc
                      .id);
                  batch.set(userWordRef, {
                    translation: wordData.translation,
                    example: wordData.example || '',
                    interactions: 0,
                    correctAnswers: 0
                  });
                });
              });
          });
          return batch.commit();
        })
        .then(() => {
          const successMessage = document.getElementById('success-message');
          successMessage.textContent = `Всі слова додано до вашого словника.`;
          setTimeout(() => {
            successMessage.textContent = '';
          }, 3000);
          hideLoading();
        })
        .catch(error => {
          console.error('Помилка додавання всіх слів:', error);
          hideLoading();
        });
      updateSadCatVisibility();
    }

    function openGenerativeTextInfoPopup() {
      document.getElementById('generativeTextInfoPopup').classList.remove('hidden');
    }

    function closeGenerativeTextInfoPopup() {
      document.getElementById('generativeTextInfoPopup').classList.add('hidden');
    }

    // Назад до списку тем
    function backToTopics() {
  console.log('Нажата кнопка "Назад до тем"');
  // Показываем список тем
  document.getElementById('topics-list').classList.remove('hidden');
  console.log('Показана секция тем');
  // Скрываем секцию слов темы
  document.getElementById('topic-words').classList.add('hidden');
  console.log('Скрыта секция слов темы');
  // Показуємо кнопку "Назад"
  document.getElementById('word-base-back-button').classList.remove('hidden');
  
  // Очищаем список слов
  document.getElementById('topic-words-list').innerHTML = '';
  console.log('Очищен список слов');
  // Очищаем название темы
  document.getElementById('topic-title').textContent = '';
  // Очищаем сообщения об успехе
  document.getElementById('success-message').textContent = '';
}
    // Показати тарифні плани
    function showTariffs() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('payment-section').classList.add('hidden');
      document.getElementById('tariffs-section').classList.remove('hidden');
    }
    // Придбати підписку
    function purchaseSubscription(days) {
      const userId = auth.currentUser.uid;
      const currentDate = new Date();
      const newExpiration = new Date(currentDate);
      newExpiration.setDate(newExpiration.getDate() + days);
      db.collection('users').doc(userId).update({
          subscriptionExpiration: firebase.firestore.Timestamp.fromDate(newExpiration)
        })
        .then(() => {
          alert('Підписку оновлено!');
          updateUI();
        })
        .catch(error => {
          console.error('Помилка оновлення підписки:', error);
          hideLoading();
        });
    }
    // Почати тренування знань
    function startQuiz() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      initializeQuiz();
    }

    function openConstructorInfoPopup() {
      showInfoPopup(
        'Опис тренування:',
        'Складіть слово з наданих літер. Використовуйте всі літери, щоб отримати правильне слово. Ви можете прослухати вимову слова, натиснувши на іконку звуку.',
        [
          'Алгоритм обирає 10 слів.',
          'Початково використовуються нові слова.',
          'Якщо нових слів недостатньо, додаються слова від складних до простих. Складність визначається відсотком правильних відповідей в попередніх тестах'
        ]
      );
    }

    function closeConstructorInfoPopup() {
      document.getElementById('constructorInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }

    // Ініціалізація тренування
    function initializeQuiz() {
      showLoading();
      const userId = auth.currentUser.uid;
      db.collection('users').doc(userId).collection('words').get()
        .then(querySnapshot => {
          if (querySnapshot.size < 10) {
            document.getElementById('quiz-container').innerHTML =
              '<p>У вас недостатньо слів для тренування. Додайте більше слів до словника.</p>';
            hideLoading();
            return;
          }
          let wordsArray = [];
          querySnapshot.forEach(doc => {
            const wordData = doc.data();
            wordsArray.push({
              english: doc.id,
              translation: wordData.translation,
              interactions: wordData.interactions || 0,
              correctAnswers: wordData.correctAnswers || 0
            });
          });
          // Розділення слів на нові та вже взаємодіяли
          const newWords = wordsArray.filter(word => word.interactions <= 3);
          const interactedWords = wordsArray.filter(word => word.interactions > 3);
          // Сортування взаємодіяних слів від найскладніших до найпростіших
          interactedWords.sort((a, b) => {
            const aRatio = a.correctAnswers / a.interactions;
            const bRatio = b.correctAnswers / b.interactions;
            return aRatio - bRatio; // Менше співвідношення означає складніше слово
          });
          // Об'єднання масивів
          const sortedWords = [...newWords, ...interactedWords];
          // Вибір перших 10 слів
          quizWords = sortedWords.slice(0, 10);
          currentQuestion = 0;
          correctAnswers = 0;
          showQuestion();
          hideLoading();
        });
    }


    // Змінні для тренування
    let quizWords = [];
    let currentQuestion = 0;
    let correctAnswers = 0;

    function showQuestion() {
      if (currentQuestion >= quizWords.length) {
        // Тренування завершено
        showQuizResult();
        return;
      }
      const questionWord = quizWords[currentQuestion];
      const options = [questionWord.translation];
      // Додаємо випадкові переклади
      while (options.length < 4) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        if (!options.includes(randomWord.translation)) {
          options.push(randomWord.translation);
        }
      }
      // Перемішуємо варіанти
      options.sort(() => 0.5 - Math.random());
      // Оновлюємо прогрес бар
      const progressPercent = ((currentQuestion) / quizWords.length) * 100;
      document.getElementById('quiz-progress-bar').style.width = `${progressPercent}%`;
      // Обновляем номер вопроса
      document.getElementById('quiz-question-number').textContent = `${currentQuestion + 1}/${quizWords.length}`;
      // Відображаємо питання
      document.getElementById('quiz-container').innerHTML = `
    <h3>${questionWord.english}</h3>
    ${options.map(option => `<button class="check-word" onclick="checkAnswer('${option.replace(/'/g, "\\'")}')">${option}</button>`).join('')}
  `;
    }

    function showQuizResult() {
      const quizContainer = document.getElementById('quiz-container');
      const quizProgress = document.getElementById('quiz-progress');
      const quizResult = document.getElementById('quiz-result');
      const quizEmoji = document.getElementById('quiz-emoji'); // Элемент <i>
      const quizResultText = document.getElementById('quiz-result-text');
      // Скрываем контейнер и прогресс
      quizContainer.classList.add('hidden');
      quizProgress.classList.add('hidden');
      // Показываем результат
      quizResult.classList.remove('hidden');
      let iconClasses = '';
      let resultText = '';
      if (correctAnswers <= 4) {
        // Плохой результат
        iconClasses = 'fas fa-sad-tear text-red-500'; // Пример: грустный смайлик
        resultText = 'Не погано, але є місце для покращення.';
      } else if (correctAnswers <= 7) {
        // Средний результат
        iconClasses = 'fas fa-meh text-yellow-500'; // Пример: нейтральный смайлик
        resultText = 'Добре! Але можна краще.';
      } else {
        // Отличный результат
        iconClasses = 'fas fa-grin-stars text-green-500'; // Пример: улыбающийся с солнцезащитными очками
        resultText = 'Відмінно! Ви чудово знаєте ці слова!';
      }
      // Удаляем все предыдущие классы и добавляем новые
      quizEmoji.className = ''; // Очищаем все классы
      quizEmoji.classList.add(...iconClasses.split(' '));
      // Обновляем текст результата
      quizResultText.textContent = `Правильних відповідей: ${correctAnswers} з ${quizWords.length}`;
    }
    // Перевірка відповіді
    function checkAnswer(selectedOption) {
      const questionWord = quizWords[currentQuestion];
      const buttons = document.querySelectorAll('#quiz-container button');
      buttons.forEach(button => {
        if (button.textContent === questionWord.translation) {
          button.classList.add('correct');
        } else if (button.textContent === selectedOption) {
          button.classList.add('incorrect');
        }
        button.disabled = true;
      });

      const correct = selectedOption === questionWord.translation;
      if (correct) {
        correctAnswers++;
      }

      // Обновляем статистику слова и дату последнего взаимодействия
      updateWordStats(questionWord.english, correct);

      // Обновляем прогресс-бар
      const progressPercent = ((currentQuestion + 1) / quizWords.length) * 100;
      document.getElementById('quiz-progress-bar').style.width = `${progressPercent}%`;

      // Переходим к следующему вопросу через 1 секунду
      setTimeout(() => {
        currentQuestion++;
        showQuestion();
      }, 1000);
    }

    function openListeningInfoPopup() {
      showInfoPopup(
        'Опис тренування:',
        'Прослухайте слово та введіть його правильно. Ви можете прослухати слово повторно, натиснувши на іконку звуку.',
        [
          'Алгоритм обирає 10 слів.',
          'Початково використовуються нові слова.',
          'Якщо нових слів недостатньо, додаються слова від складних до простих. Складність визначається відсотком правильних відповідей в попередніх тестах'
        ]
      );
    }

    function closeListeningInfoPopup() {
      document.getElementById('listeningInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }
    let isPlayingStory = false;
    let isPausedStory = false;
    let currentSentenceIndex = 0;
    let originalStoryHtml = '';
    let sentenceSpans = [];

    function playStory() {
      const playBtn = document.getElementById('play-story-btn');
      const storyTextElement = document.getElementById('story-text');

      // Если играет - поставить на паузу
      if (isPlayingStory) {
        responsiveVoice.cancel();
        isPlayingStory = false;
        isPausedStory = true;
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        return;
      }

      // Если на паузе - показать выбор
      if (isPausedStory && currentSentenceIndex > 0) {
        showStoryResumeOptions();
        return;
      }

      startStoryPlayback();
    }

    function showStoryResumeOptions() {
      const popup = document.getElementById('infoPopup');
      popup.innerHTML = `
        <p class="training-title-desc">Продовжити прослуховування?</p>
        <p class="description">Виберіть дію:</p>
        <button class="close-button" style="margin-bottom: 10px; background: #4CAF50;" onclick="resumeStoryPlayback()">
          <i class="fas fa-play"></i> Продовжити
        </button>
        <button class="close-button" style="margin-bottom: 10px; background: #2196F3;" onclick="restartStoryPlayback()">
          <i class="fas fa-redo"></i> Спочатку
        </button>
        <button class="close-button" onclick="stopStoryPlayback()">
          <i class="fas fa-stop"></i> Зупинити
        </button>
      `;
      document.querySelector('.overlay').classList.remove('hidden');
      popup.classList.add('show');
    }

    function resumeStoryPlayback() {
      closeInfoPopup();
      const playBtn = document.getElementById('play-story-btn');
      isPlayingStory = true;
      isPausedStory = false;
      playBtn.innerHTML = '<i class="fas fa-pause"></i>';
      playSentence();
    }

    function restartStoryPlayback() {
      closeInfoPopup();
      currentSentenceIndex = 0;
      isPausedStory = false;
      startStoryPlayback();
    }

    function stopStoryPlayback() {
      closeInfoPopup();
      const playBtn = document.getElementById('play-story-btn');
      responsiveVoice.cancel();
      isPlayingStory = false;
      isPausedStory = false;
      currentSentenceIndex = 0;
      playBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
      sentenceSpans.forEach(span => span.classList.remove('highlight-sentence'));
    }

    function startStoryPlayback() {
      const playBtn = document.getElementById('play-story-btn');
      const storyTextElement = document.getElementById('story-text');

      // Сохраняем оригинальный HTML и оборачиваем предложения
      if (!storyTextElement.querySelector('.sentence-span')) {
        originalStoryHtml = storyTextElement.innerHTML;
        wrapSentencesInSpans(storyTextElement);
      }

      sentenceSpans = Array.from(storyTextElement.querySelectorAll('.sentence-span'));

      if (sentenceSpans.length === 0) {
        responsiveVoice.speak(storyTextElement.innerText, "UK English Female");
        return;
      }

      isPlayingStory = true;
      isPausedStory = false;
      playBtn.innerHTML = '<i class="fas fa-pause"></i>';

      playSentence();
    }

    function playSentence() {
      if (!isPlayingStory || currentSentenceIndex >= sentenceSpans.length) {
        // Закончили
        isPlayingStory = false;
        const playBtn = document.getElementById('play-story-btn');
        playBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        sentenceSpans.forEach(span => span.classList.remove('highlight-sentence'));
        return;
      }

      // Убираем предыдущее выделение
      sentenceSpans.forEach(span => span.classList.remove('highlight-sentence'));

      // Выделяем текущее предложение
      const currentSpan = sentenceSpans[currentSentenceIndex];
      currentSpan.classList.add('highlight-sentence');

      // Прокручиваем к текущему предложению
      currentSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });

      const sentence = currentSpan.innerText;

      responsiveVoice.speak(sentence, "UK English Female", {
        onend: function() {
          currentSentenceIndex++;
          playSentence();
        },
        onerror: function() {
          isPlayingStory = false;
          const playBtn = document.getElementById('play-story-btn');
          playBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
          sentenceSpans.forEach(span => span.classList.remove('highlight-sentence'));
        }
      });
    }

    function wrapSentencesInSpans(element) {
      const html = element.innerHTML;
      // Разбиваем по предложениям, сохраняя HTML теги
      // Ищем точки, восклицательные и вопросительные знаки, после которых пробел или конец
      const wrapped = html.replace(/([^.!?]*(?:<[^>]+>[^.!?]*)*[.!?]+)\s*/g, (match, sentence) => {
        return `<span class="sentence-span">${sentence}</span> `;
      });
      element.innerHTML = wrapped;
    }

let storyIsEnglish = true; // Відстежуємо, чи зараз історія англійською

function highlightUserWordsInTranslation(text, originalHtml) {
  if (!allWords || allWords.length === 0) return text;

  // Знаходимо які англійські слова були виділені в оригіналі
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = originalHtml || '';
  const highlightedEnglish = Array.from(tempDiv.querySelectorAll('.highlight'))
    .map(el => el.textContent.toLowerCase().trim());

  if (highlightedEnglish.length === 0) return text;

  // Знаходимо українські переклади тільки для виділених англійських слів
  const translations = allWords
    .filter(w => highlightedEnglish.includes(w.english.toLowerCase()))
    .map(w => w.translation)
    .filter(t => t && t.length >= 2)
    .sort((a, b) => b.length - a.length);

  let result = text;
  const highlighted = new Set();

  translations.forEach(translation => {
    if (translation.length < 3) return;

    const escaped = translation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const endings = '(?:а|у|ом|ою|і|ів|ами|ях|ий|ого|ому|им|ій|ої|ій|ою|их|ими|е|є|ення|ість|ти|ть|в|ла|ло|ли)?';

    const regex = new RegExp(`(?<![а-яіїєґА-ЯІЇЄҐ'])(${escaped}${endings})(?![а-яіїєґА-ЯІЇЄҐ'])`, 'gi');

    result = result.replace(regex, (match, word) => {
      if (word.length < 3) return match;
      if (highlighted.has(word.toLowerCase())) return match;
      highlighted.add(word.toLowerCase());
      return `<span class="highlight">${word}</span>`;
    });
  });

  return result;
}

async function translateStory() {
  const storyTitleElement = document.getElementById('story-title');
  const storyTextElement = document.getElementById('story-text');
  const translateBtn = document.getElementById('translate-story-btn');

  // Якщо історія в оригіналі (англійською), тоді перекладаємо на українську
  if (storyIsEnglish) {
    // Зберігаємо оригінальний текст (чистий, без HTML)
    if (!storyTitleElement.dataset.originalTitle) {
      storyTitleElement.dataset.originalTitle = storyTitleElement.innerText;
      storyTextElement.dataset.originalText = storyTextElement.innerText;
      storyTextElement.dataset.originalHtml = storyTextElement.innerHTML;
    }

    // Перевіряємо чи є збережений переклад в localStorage
    const savedTranslatedTitle = localStorage.getItem('translatedStoryTitle');
    const savedTranslatedText = localStorage.getItem('translatedStoryText');
    const savedOriginalText = localStorage.getItem('originalStoryText');

    // Якщо є збережений переклад для цього тексту - використовуємо його
    if (savedTranslatedText && savedOriginalText === storyTextElement.dataset.originalText) {
      storyTitleElement.innerText = savedTranslatedTitle;
      storyTextElement.innerHTML = savedTranslatedText;
      storyIsEnglish = false;
      return;
    }

    // Показуємо індикатор завантаження
    translateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    translateBtn.disabled = true;

    try {
      // Знаходимо виділені англійські слова в оригіналі
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = storyTextElement.dataset.originalHtml || '';
      const highlightedWords = Array.from(tempDiv.querySelectorAll('.highlight'))
        .map(el => el.textContent.trim());

      // Переклад заголовка
      const translatedTitle = await translateText(
        storyTitleElement.dataset.originalTitle,
        'en',
        'uk'
      );
      // Переклад тексту з виділенням слів
      const translatedText = await translateText(
        storyTextElement.dataset.originalText,
        'en',
        'uk',
        highlightedWords
      );

      // Перевіряємо чи переклад відрізняється від оригіналу
      if (translatedText !== storyTextElement.dataset.originalText) {
        storyTitleElement.innerText = translatedTitle;
        storyTextElement.innerHTML = translatedText;
        storyIsEnglish = false;

        // Зберігаємо переклад в localStorage
        localStorage.setItem('translatedStoryTitle', translatedTitle);
        localStorage.setItem('translatedStoryText', translatedText);
        localStorage.setItem('originalStoryText', storyTextElement.dataset.originalText);
      }
    } catch (error) {
      console.error('Помилка перекладу історії:', error);
      showNotification('Сервіс перекладу недоступний', 'error');
    } finally {
      translateBtn.innerHTML = '<i class="fas fa-language"></i>';
      translateBtn.disabled = false;
    }

  } else {
    // Повертаємося до оригіналу (англ.) з виділеними словами
    storyTitleElement.innerText = storyTitleElement.dataset.originalTitle || storyTitleElement.innerText;
    storyTextElement.innerHTML = storyTextElement.dataset.originalHtml || storyTextElement.innerHTML;
    storyIsEnglish = true;
  }
}



    // Отримання рекомендацій перекладу
    function getTranslationSuggestions(word) {
      if (!word) return;
      const apiKey = 'YOUR_TRANSLATION_API_KEY';
      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|uk`;
      axios.get(url)
        .then(response => {
          const suggestions = response.data.matches.slice(0, 3).map(match => match.translation);
          displayTranslationSuggestions(suggestions);
        })
        .catch(error => {
          console.error('Помилка отримання перекладу:', error);
        });
    }
    // Відображення рекомендацій перекладу
    function displayTranslationSuggestions(translations) {
      const suggestionsContainer = document.getElementById('translation-suggestions');
      suggestionsContainer.innerHTML = '';
      translations.forEach(translation => {
        const suggestion = document.createElement('div');
        suggestion.classList.add('suggestion');
        suggestion.textContent = translation;
        suggestion.onclick = () => {
          document.getElementById('translation').value = translation;
          suggestionsContainer.innerHTML = '';
        };
        suggestionsContainer.appendChild(suggestion);
      });
    }
    // Показати тренування на слух
    function startListeningTraining() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('listening-training-section').classList.remove('hidden');
      initializeListeningTraining();
    }
    // Ініціалізація тренування на слух
    function initializeListeningTraining() {
      showLoading();
      const userId = auth.currentUser.uid;
      db.collection('users').doc(userId).collection('words').get()
        .then(querySnapshot => {
          if (querySnapshot.size < 10) {
            document.getElementById('listening-quiz-container').innerHTML =
              '<p>У вас недостатньо слів для тренування. Додайте більше слів до словника.</p>';
            hideLoading();
            return;
          }
          let wordsArray = [];
          querySnapshot.forEach(doc => {
            const wordData = doc.data();
            wordsArray.push({
              english: doc.id,
              translation: wordData.translation,
              interactions: wordData.interactions || 0,
              correctAnswers: wordData.correctAnswers || 0
            });
          });
          // Розділення слів на нові та взаємодіяні
          const newWords = wordsArray.filter(word => word.interactions === 0);
          const interactedWords = wordsArray.filter(word => word.interactions > 0);
          // Сортування взаємодіяних слів від найскладніших до найпростіших
          interactedWords.sort((a, b) => {
            const aRatio = a.correctAnswers / a.interactions;
            const bRatio = b.correctAnswers / b.interactions;
            return aRatio - bRatio;
          });
          // Об'єднання масивів
          const sortedWords = [...newWords, ...interactedWords];
          listeningWords = sortedWords.slice(0, 10);
          currentListeningQuestion = 0;
          listeningCorrectAnswers = 0;
          showListeningQuestion();
          hideLoading();
        });
    }

    // Змінні для тренування на слух
    let listeningWords = [];
    let currentListeningQuestion = 0;
    let listeningCorrectAnswers = 0;

    function showListeningQuestion() {
      if (currentListeningQuestion >= listeningWords.length) {
        showListeningResult();
        return;
      }
      const questionWord = listeningWords[currentListeningQuestion];
      // Обновляем прогресс-бар
      const progressPercent = ((currentListeningQuestion) / listeningWords.length) * 100;
      document.getElementById('listening-progress-bar').style.width = `${progressPercent}%`;
      const container = document.getElementById('listening-quiz-container');
      // Добавляем класс для анимации появления
      container.classList.add('fade-in');
      // Удаляем класс после завершения анимации
      setTimeout(() => {
        container.classList.remove('fade-in');
      }, 500);
      // Отображаем контент
      container.innerHTML = `
    <button onclick="responsiveVoice.speak('${questionWord.english}', 'UK English Female')" class="listening-sound-icon"><i class="fas fa-volume-up"></i></button>
    <input type="text" id="listening-answer" placeholder="Введіть слово...">
    <button class="check-button" onclick="checkListeningAnswer('${questionWord.english}')">Перевірити</button>
    <button class="skip-button" onclick="skipListeningQuestion()">Пропустити</button>
    <div id="listening-feedback" class="listening-feedback hidden"></div>
  `;
    }
    // Перевірка відповіді в тренуванні на слух
    function checkListeningAnswer(correctWord) {
      const userAnswer = document.getElementById('listening-answer').value.trim().toLowerCase();
      const feedback = document.getElementById('listening-feedback');
      const isCorrect = userAnswer === correctWord.toLowerCase();

      if (isCorrect) {
        listeningCorrectAnswers++;
        feedback.textContent = 'Правильно!';
        feedback.style.color = '#2ecc71'; // Зеленый
      } else {
        feedback.textContent = `Неправильно! Правильне слово: ${correctWord}`;
        feedback.style.color = '#e74c3c'; // Красный
      }
      feedback.classList.remove('hidden');

      // Обновляем статистику слова
      updateWordStats(correctWord, isCorrect);

      // Переходим к следующему вопросу через 1.5 секунды
      setTimeout(() => {
        currentListeningQuestion++;
        showListeningQuestion();
      }, 1500);
    }

    function openRepetitionInfoPopup() {
      showInfoPopup(
        'Повторення',
        'Тренування для повторення слів, які ви давно не практикували. Допомагає не забути вивчене.',
        [
          'Обираються тільки слова, які ви вже практикували раніше.',
          'Слова сортуються за датою останньої взаємодії.',
          'Перші 10 слів - ті, які найдовше не повторювались.',
          'Це допомагає підтримувати знання всіх слів на рівні.'
        ]
      );
    }

    function openGeneratorInfoPopup() {
      showInfoPopup(
        'Генеративний текст',
        'AI генерує унікальні історії з використанням слів з вашого словника. Практикуйте читання та розуміння в контексті.',
        [
          'Кількість слів залежить від довжини: Короткий - 5, Середній - 7, Довгий - 10 слів.',
          'Слова обираються випадково з вашого словника.',
          'AI створює історію у вибраному жанрі та складності.',
          'Ваші слова виділяються кольором у тексті.',
          'Можна прослухати історію та перекласти українською.'
        ]
      );
    }

    function closeRepetitionInfoPopup() {
      document.getElementById('repetitionInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }

    function closeGeneratorInfoPopup() {
      document.getElementById('generatorInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }

    function skipListeningQuestion() {
      currentListeningQuestion++;
      showListeningQuestion();
    }
    // Показати тренування конструктор слова
    function startWordConstructorTraining() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('word-constructor-training-section').classList.remove('hidden');
      initializeWordConstructorTraining();
      document.getElementById('constructor-progress').classList.remove('hidden');
      document.getElementById('word-constructor-quiz-container').classList.remove('hidden');
    }
    // Ініціалізація тренування конструктор слова
    function initializeWordConstructorTraining() {
      showLoading();
      const userId = auth.currentUser.uid;
      db.collection('users').doc(userId).collection('words').get()
        .then(querySnapshot => {
          if (querySnapshot.size < 10) {
            document.getElementById('word-constructor-quiz-container').innerHTML =
              '<p>У вас недостатньо слів для тренування. Додайте більше слів до словника.</p>';
            hideLoading();
            return;
          }
          let wordsArray = [];
          querySnapshot.forEach(doc => {
            const wordData = doc.data();
            wordsArray.push({
              english: doc.id,
              translation: wordData.translation,
              interactions: wordData.interactions || 0,
              correctAnswers: wordData.correctAnswers || 0
            });
          });
          // Розділення слів на нові та взаємодіяні
          const newWords = wordsArray.filter(word => word.interactions === 0);
          const interactedWords = wordsArray.filter(word => word.interactions > 0);
          // Сортування взаємодіяних слів від найскладніших до найпростіших
          interactedWords.sort((a, b) => {
            const aRatio = a.correctAnswers / a.interactions;
            const bRatio = b.correctAnswers / b.interactions;
            return aRatio - bRatio;
          });
          // Об'єднання масивів
          const sortedWords = [...newWords, ...interactedWords];
          constructorWords = sortedWords.slice(0, 10);
          currentConstructorQuestion = 0;
          constructorCorrectAnswers = 0;
          showConstructorQuestion();
          hideLoading();
        })
        .catch(error => {
          console.error('Помилка ініціалізації конструктора:', error);
          hideLoading();
        });
    }

    // Змінні для тренування конструктор слова
    let constructorWords = [];
    let currentConstructorQuestion = 0;
    let constructorCorrectAnswers = 0;

    function showConstructorQuestion() {
      if (currentConstructorQuestion >= constructorWords.length) {
        showConstructorResult();
        return;
      }
      const questionWord = constructorWords[currentConstructorQuestion];
      const letters = getUniqueLetters(questionWord.english);
      // Сброс переменных
      constructedWord = '';
      usedLetters = {};
      // Обновление прогресс-бара
      const progressPercent = ((currentConstructorQuestion) / constructorWords.length) * 100;
      document.getElementById('constructor-progress-bar').style.width = `${progressPercent}%`;
      const container = document.getElementById('word-constructor-quiz-container');
      // Анимация
      container.classList.remove('fade-in');
      container.classList.add('fade-out');
      setTimeout(() => {
        // Обновляем контент после анимации
        container.innerHTML = `
      <div class="sound-icon-container">
        <button onclick="responsiveVoice.speak('${questionWord.english}', 'UK English Female')" class="listening-sound-icon">
          <i class="fas fa-volume-up"></i>
        </button>
      </div>
      <div class="input-block-custom" style="display: flex; justify-content: center; margin-top: 10px;">
        <input type="text" id="constructor-answer" placeholder="Соберіть слово..." readonly>
        <button class="delete-constructor-button" onclick="deleteLastLetter()">
          <i class="fas fa-backspace"></i>
        </button>
      </div>
      <div class="constructor-letter-buttons" id="letter-buttons">
        ${generateLetterButtonsHTML(letters)}
      </div>
      <button class="check-button" onclick="submitConstructorAnswer('${questionWord.english}')">Перевірити</button>
      <button class="skip-button" onclick="skipConstructor()">Пропустити</button>
      <div id="constructor-feedback" class="listening-feedback hidden"></div>
    `;
        // Добавляем класс для анимации появления
        container.classList.remove('fade-out');
        container.classList.add('fade-in');
        // Автоматическое озвучивание слова
        responsiveVoice.speak(questionWord.english, 'UK English Female');
      }, 500); // Задержка должна совпадать с длительностью анимации в CSS
    }

    function generateLetterButtonsHTML(letters) {
      let letterButtonsHTML = '';
      letters.forEach(letterObj => {
        const displayText = letterObj.letter;
        letterButtonsHTML +=
          `<button class="unique-letter-button" data-letter="${letterObj.letter}" data-count="${letterObj.count}" data-initial-count="${letterObj.count}" onclick="addLetterToConstructor('${letterObj.letter}')">${displayText}</button>`;
      });
      return letterButtonsHTML;
    }
    // Замените функцию getShuffledLetters на getUniqueLetters
    function getUniqueLetters(word) {
      const letterCounts = {};
      word.toLowerCase().split('').forEach(letter => {
        letterCounts[letter] = (letterCounts[letter] || 0) + 1;
      });
      let letters = [];
      for (const [letter, count] of Object.entries(letterCounts)) {
        letters.push({
          letter: letter,
          count: count
        });
      }
      // Перемешиваем буквы
      for (let i = letters.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [letters[i], letters[j]] = [letters[j], letters[i]];
      }
      return letters;
    }
    // Змінні для відстеження створеного слова
    let constructedWord = '';
    let usedLetters = {};

    function addLetterToConstructor(letter) {
      const letterButton = document.querySelector(`button[data-letter='${letter}']`);
      let remainingCount = parseInt(letterButton.getAttribute('data-count'));
      if (remainingCount <= 0) return;
      constructedWord += letter;
      document.getElementById('constructor-answer').value = constructedWord;
      // Уменьшение количества оставшихся букв
      remainingCount--;
      letterButton.setAttribute('data-count', remainingCount);
      // Обновление текста кнопки
      const displayText = remainingCount > 1 ? `${letter} (${remainingCount})` : letter;
      letterButton.textContent = displayText;
      // Отключение кнопки, если букв больше нет
      if (remainingCount === 0) {
        letterButton.disabled = true;
      }
    }
    // Функція для отримання кількості певної букви в слові
    function getLetterCount(letter) {
      const currentWord = constructorWords[currentConstructorQuestion].english.toLowerCase();
      return currentWord.split(letter).length - 1;
    }

    function submitConstructorAnswer(correctWord) {
      const userAnswer = document.getElementById('constructor-answer').value.trim().toLowerCase();
      const feedback = document.getElementById('constructor-feedback');
      if (userAnswer === correctWord.toLowerCase()) {
        constructorCorrectAnswers++;
        updateWordStats(correctWord, true);
        feedback.classList.remove('not-correct-label');
        feedback.classList.add('correct-label');
        feedback.textContent = 'Правильно!';
        feedback.classList.remove('hidden');
        // Переход к следующему слову через 1.5 секунды
        setTimeout(() => {
          currentConstructorQuestion++;
          showConstructorQuestion();
        }, 1500);
      } else {
        updateWordStats(correctWord, false);
        feedback.classList.remove('correct-label');
        feedback.classList.add('not-correct-label');
        feedback.textContent = `Неправильно! спробуйте ще раз.`;
        feedback.classList.remove('hidden');
        // Сброс введенного слова и кнопок букв
        constructedWord = '';
        document.getElementById('constructor-answer').value = constructedWord;
        resetLetterButtons();
      }
    }

    function resetLetterButtons() {
      const letterButtons = document.querySelectorAll('.unique-letter-button');
      letterButtons.forEach(button => {
        const initialCount = parseInt(button.getAttribute('data-initial-count'));
        button.setAttribute('data-count', initialCount);
        const letter = button.getAttribute('data-letter');
        const displayText = letter;
        button.textContent = displayText;
        button.disabled = false;
      });
    }

    function skipConstructor() {
      currentConstructorQuestion++;
      showConstructorQuestion();
    }

    async function updateWordStats(word, correct) {
      const userId = auth.currentUser.uid;
      const wordRef = db.collection('users').doc(userId).collection('words').doc(word);

      try {
        const doc = await wordRef.get();
        if (doc.exists) {
          const wordData = doc.data();
          const interactions = (wordData.interactions || 0) + 1;
          const correctAnswersCount = correct ?
            (wordData.correctAnswers || 0) + 1 :
            (wordData.correctAnswers || 0);
          await wordRef.update({
            interactions: interactions,
            correctAnswers: correctAnswersCount,
            lastInteractionDate: firebase.firestore.Timestamp.now(), // Добавлено
          });
        }
      } catch (error) {
        console.error('Помилка оновлення статистики слова:', error);
      }
    }



    function finishQuiz() {
      // Перехід на головну сторінку
      backToAccount();
      // Скидання прогресу та результатів
      document.getElementById('quiz-result').classList.add('hidden');
      document.getElementById('quiz-container').classList.remove('hidden');
      document.getElementById('quiz-progress').classList.remove('hidden');
      correctAnswers = 0;
      currentQuestion = 0;
      initializeQuiz();
    }

    // ============ Тренування по картинках ============
    let pictureQuizWords = [];
    let currentPictureQuestion = 0;
    let pictureCorrectAnswers = 0;

    function startPictureQuiz() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('picture-quiz-section').classList.remove('hidden');
      initializePictureQuiz();
    }

    function openPictureQuizInfoPopup() {
      showInfoPopup(
        'Картинки',
        'У цьому тренуванні ви бачите картинку і маєте обрати правильне англійське слово з 4 варіантів.',
        [
          'Алгоритм обирає 10 слів зі словника.',
          'Спочатку використовуються нові слова (менше 3 взаємодій).',
          'Якщо нових слів недостатньо, додаються слова від складних до простих.',
          'Для кожного слова завантажується відповідна картинка.'
        ]
      );
    }

    function closePictureQuizInfoPopup() {
      document.getElementById('pictureQuizInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }

    async function initializePictureQuiz() {
      showLoading();
      const userId = auth.currentUser.uid;

      try {
        const querySnapshot = await db.collection('users').doc(userId).collection('words').get();

        if (querySnapshot.size < 10) {
          document.getElementById('picture-quiz-container').innerHTML =
            '<p>У вас недостатньо слів для тренування. Додайте більше слів до словника.</p>';
          hideLoading();
          return;
        }

        let wordsArray = [];
        querySnapshot.forEach(doc => {
          const wordData = doc.data();
          wordsArray.push({
            english: doc.id,
            translation: wordData.translation,
            interactions: wordData.interactions || 0,
            correctAnswers: wordData.correctAnswers || 0
          });
        });

        // Сортування слів (нові + складні)
        const newWords = wordsArray.filter(word => word.interactions <= 3);
        const interactedWords = wordsArray.filter(word => word.interactions > 3);
        interactedWords.sort((a, b) => {
          const aRatio = a.correctAnswers / a.interactions;
          const bRatio = b.correctAnswers / b.interactions;
          return aRatio - bRatio;
        });

        const sortedWords = [...newWords, ...interactedWords];
        pictureQuizWords = sortedWords.slice(0, 10);
        currentPictureQuestion = 0;
        pictureCorrectAnswers = 0;

        // Попереднє завантаження картинок
        await preloadPictureQuizImages();

        showPictureQuestion();
        hideLoading();
      } catch (error) {
        console.error('Помилка ініціалізації тренування:', error);
        hideLoading();
      }
    }

    async function preloadPictureQuizImages() {
      const promises = pictureQuizWords.map(word => getWordImage(word.english));
      await Promise.all(promises);
    }

    async function showPictureQuestion() {
      if (currentPictureQuestion >= pictureQuizWords.length) {
        showPictureQuizResult();
        return;
      }

      const questionWord = pictureQuizWords[currentPictureQuestion];

      // Отримуємо картинку
      const imageUrl = await getWordImage(questionWord.english);
      const imgElement = document.getElementById('picture-quiz-image');

      if (imageUrl) {
        imgElement.src = imageUrl;
        imgElement.style.display = 'block';
      } else {
        // Якщо картинки немає, показуємо placeholder
        imgElement.src = 'https://via.placeholder.com/280x200?text=' + encodeURIComponent(questionWord.english);
        imgElement.style.display = 'block';
      }

      // Генеруємо 4 варіанти відповіді (англійські слова)
      const options = [questionWord.english];
      while (options.length < 4) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        if (!options.includes(randomWord.english)) {
          options.push(randomWord.english);
        }
      }

      // Перемішуємо варіанти
      options.sort(() => 0.5 - Math.random());

      // Оновлюємо прогрес бар
      const progressPercent = (currentPictureQuestion / pictureQuizWords.length) * 100;
      document.getElementById('picture-quiz-progress-bar').style.width = `${progressPercent}%`;
      document.getElementById('picture-quiz-question-number').textContent =
        `${currentPictureQuestion + 1}/${pictureQuizWords.length}`;

      // Відображаємо варіанти
      const optionsContainer = document.getElementById('picture-quiz-options');
      optionsContainer.innerHTML = options.map(option =>
        `<button class="check-word" onclick="checkPictureAnswer('${option.replace(/'/g, "\\'")}')">${option}</button>`
      ).join('');
    }

    async function checkPictureAnswer(selectedAnswer) {
      const questionWord = pictureQuizWords[currentPictureQuestion];
      const isCorrect = selectedAnswer === questionWord.english;

      // Візуальний feedback
      const buttons = document.querySelectorAll('#picture-quiz-options button');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === questionWord.english) {
          btn.classList.add('correct');
        } else if (btn.textContent === selectedAnswer && !isCorrect) {
          btn.classList.add('incorrect');
        }
      });

      // Озвучуємо правильне слово
      responsiveVoice.speak(questionWord.english, "UK English Female");

      if (isCorrect) {
        pictureCorrectAnswers++;
      }

      // Оновлюємо статистику слова
      updateWordStats(questionWord.english, isCorrect);

      // Переходимо до наступного питання через 1 секунду
      setTimeout(async () => {
        currentPictureQuestion++;
        await showPictureQuestion();
      }, 1000);
    }

    function showPictureQuizResult() {
      const container = document.getElementById('picture-quiz-container');
      const progress = document.getElementById('picture-quiz-progress');
      const result = document.getElementById('picture-quiz-result');
      const emoji = document.getElementById('picture-quiz-emoji');
      const resultText = document.getElementById('picture-quiz-result-text');

      container.classList.add('hidden');
      progress.classList.add('hidden');
      result.classList.remove('hidden');

      let iconClasses = '';
      let text = '';

      if (pictureCorrectAnswers <= 4) {
        iconClasses = 'fas fa-sad-tear';
        text = 'Не погано, але є місце для покращення.';
      } else if (pictureCorrectAnswers <= 7) {
        iconClasses = 'fas fa-meh';
        text = 'Добре! Але можна краще.';
      } else {
        iconClasses = 'fas fa-grin-stars';
        text = 'Відмінно! Ви чудово знаєте ці слова!';
      }

      emoji.className = '';
      emoji.classList.add(...iconClasses.split(' '));
      resultText.textContent = `Ви відповіли правильно на ${pictureCorrectAnswers} з ${pictureQuizWords.length} питань. ${text}`;
    }

    async function skipPictureQuestion() {
      // Показуємо правильну відповідь перед пропуском
      const questionWord = pictureQuizWords[currentPictureQuestion];
      const buttons = document.querySelectorAll('#picture-quiz-options button');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === questionWord.english) {
          btn.classList.add('correct');
        }
      });

      // Озвучуємо слово
      responsiveVoice.speak(questionWord.english, "UK English Female");

      // Переходимо до наступного питання через 1 секунду
      setTimeout(async () => {
        currentPictureQuestion++;
        await showPictureQuestion();
      }, 1000);
    }

    function finishPictureQuiz() {
      backToAccount();
      document.getElementById('picture-quiz-result').classList.add('hidden');
      document.getElementById('picture-quiz-container').classList.remove('hidden');
      document.getElementById('picture-quiz-progress').classList.remove('hidden');
      pictureCorrectAnswers = 0;
      currentPictureQuestion = 0;
    }
    // ============ Кінець тренування по картинках ============

    // ============ Кросворд ============
    let crosswordWords = [];
    let crosswordGrid = [];
    let crosswordSize = 15;
    let placedWords = [];

    function startCrossword() {
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('crossword-section').classList.remove('hidden');
      generateNewCrossword();
    }

    async function generateNewCrossword() {
      showLoading();
      const userId = auth.currentUser.uid;

      try {
        const querySnapshot = await db.collection('users').doc(userId).collection('words').get();

        if (querySnapshot.size < 5) {
          document.getElementById('crossword-grid').innerHTML =
            '<p style="text-align:center;padding:20px;">Потрібно мінімум 5 слів у словнику для кросворда.</p>';
          hideLoading();
          return;
        }

        let wordsArray = [];
        querySnapshot.forEach(doc => {
          const wordData = doc.data();
          const english = doc.id.toUpperCase();
          // Фільтруємо слова - тільки букви, без пробілів
          if (/^[A-Z]+$/.test(english) && english.length >= 3 && english.length <= 10) {
            wordsArray.push({
              english: english,
              translation: wordData.translation
            });
          }
        });

        if (wordsArray.length < 5) {
          document.getElementById('crossword-grid').innerHTML =
            '<p style="text-align:center;padding:20px;">Недостатньо підходящих слів для кросворда.</p>';
          hideLoading();
          return;
        }

        // Перемішуємо та обираємо слова (8 на мобільному, 10 на десктопі)
        wordsArray.sort(() => 0.5 - Math.random());
        const isMobile = window.innerWidth < 768;
        const wordCount = isMobile ? 8 : 10;
        crosswordWords = wordsArray.slice(0, Math.min(wordCount, wordsArray.length));

        // Сортуємо по довжині (довші спочатку)
        crosswordWords.sort((a, b) => b.english.length - a.english.length);

        // Генеруємо кросворд
        generateCrosswordGrid();
        renderCrossword();
        hideLoading();
      } catch (error) {
        console.error('Помилка генерації кросворда:', error);
        hideLoading();
      }
    }

    function generateCrosswordGrid() {
      // Ініціалізуємо порожню сітку
      crosswordGrid = [];
      for (let i = 0; i < crosswordSize; i++) {
        crosswordGrid.push(new Array(crosswordSize).fill(null));
      }
      placedWords = [];

      // Розміщуємо перше слово по горизонталі в центрі
      const firstWord = crosswordWords[0];
      const startRow = Math.floor(crosswordSize / 2);
      const startCol = Math.floor((crosswordSize - firstWord.english.length) / 2);

      placeWord(firstWord, startRow, startCol, 'across');

      // Намагаємось розмістити інші слова
      for (let i = 1; i < crosswordWords.length; i++) {
        const word = crosswordWords[i];
        let placed = false;

        // Шукаємо перетин з уже розміщеними словами
        for (let p = 0; p < placedWords.length && !placed; p++) {
          const placedWord = placedWords[p];

          for (let wi = 0; wi < word.english.length && !placed; wi++) {
            for (let pi = 0; pi < placedWord.english.length && !placed; pi++) {
              if (word.english[wi] === placedWord.english[pi]) {
                // Знайшли спільну літеру
                let newRow, newCol, direction;

                if (placedWord.direction === 'across') {
                  // Розміщуємо нове слово вертикально
                  newRow = placedWord.row - wi;
                  newCol = placedWord.col + pi;
                  direction = 'down';
                } else {
                  // Розміщуємо нове слово горизонтально
                  newRow = placedWord.row + pi;
                  newCol = placedWord.col - wi;
                  direction = 'across';
                }

                if (canPlaceWord(word, newRow, newCol, direction)) {
                  placeWord(word, newRow, newCol, direction);
                  placed = true;
                }
              }
            }
          }
        }
      }
    }

    function canPlaceWord(word, row, col, direction) {
      const len = word.english.length;

      // Перевіряємо межі
      if (row < 0 || col < 0) return false;
      if (direction === 'across' && col + len > crosswordSize) return false;
      if (direction === 'down' && row + len > crosswordSize) return false;

      // Перевіряємо кожну клітинку
      for (let i = 0; i < len; i++) {
        const r = direction === 'down' ? row + i : row;
        const c = direction === 'across' ? col + i : col;
        const letter = word.english[i];

        const cell = crosswordGrid[r][c];

        if (cell !== null && cell !== letter) {
          return false; // Конфлікт літер
        }

        // Перевіряємо сусідні клітинки (щоб слова не торкались боками)
        if (cell === null) {
          if (direction === 'across') {
            // Перевіряємо клітинки зверху і знизу
            if (r > 0 && crosswordGrid[r-1][c] !== null && crosswordGrid[r-1][c] !== letter) {
              // Дозволяємо тільки якщо це перетин
              let isIntersection = false;
              for (const pw of placedWords) {
                if (pw.direction === 'down') {
                  const pwEndRow = pw.row + pw.english.length - 1;
                  if (c === pw.col && r >= pw.row && r <= pwEndRow) {
                    isIntersection = true;
                    break;
                  }
                }
              }
              if (!isIntersection) return false;
            }
            if (r < crosswordSize - 1 && crosswordGrid[r+1][c] !== null && crosswordGrid[r+1][c] !== letter) {
              let isIntersection = false;
              for (const pw of placedWords) {
                if (pw.direction === 'down') {
                  const pwEndRow = pw.row + pw.english.length - 1;
                  if (c === pw.col && r >= pw.row && r <= pwEndRow) {
                    isIntersection = true;
                    break;
                  }
                }
              }
              if (!isIntersection) return false;
            }
          } else {
            // Перевіряємо клітинки зліва і справа
            if (c > 0 && crosswordGrid[r][c-1] !== null && crosswordGrid[r][c-1] !== letter) {
              let isIntersection = false;
              for (const pw of placedWords) {
                if (pw.direction === 'across') {
                  const pwEndCol = pw.col + pw.english.length - 1;
                  if (r === pw.row && c >= pw.col && c <= pwEndCol) {
                    isIntersection = true;
                    break;
                  }
                }
              }
              if (!isIntersection) return false;
            }
            if (c < crosswordSize - 1 && crosswordGrid[r][c+1] !== null && crosswordGrid[r][c+1] !== letter) {
              let isIntersection = false;
              for (const pw of placedWords) {
                if (pw.direction === 'across') {
                  const pwEndCol = pw.col + pw.english.length - 1;
                  if (r === pw.row && c >= pw.col && c <= pwEndCol) {
                    isIntersection = true;
                    break;
                  }
                }
              }
              if (!isIntersection) return false;
            }
          }
        }
      }

      // Перевіряємо початок і кінець слова
      if (direction === 'across') {
        if (col > 0 && crosswordGrid[row][col - 1] !== null) return false;
        if (col + len < crosswordSize && crosswordGrid[row][col + len] !== null) return false;
      } else {
        if (row > 0 && crosswordGrid[row - 1][col] !== null) return false;
        if (row + len < crosswordSize && crosswordGrid[row + len][col] !== null) return false;
      }

      return true;
    }

    function placeWord(word, row, col, direction) {
      for (let i = 0; i < word.english.length; i++) {
        const r = direction === 'down' ? row + i : row;
        const c = direction === 'across' ? col + i : col;
        crosswordGrid[r][c] = word.english[i];
      }

      placedWords.push({
        ...word,
        row: row,
        col: col,
        direction: direction,
        number: placedWords.length + 1
      });
    }

    function renderCrossword() {
      // Знаходимо межі кросворда
      let minRow = crosswordSize, maxRow = 0, minCol = crosswordSize, maxCol = 0;
      for (let r = 0; r < crosswordSize; r++) {
        for (let c = 0; c < crosswordSize; c++) {
          if (crosswordGrid[r][c] !== null) {
            minRow = Math.min(minRow, r);
            maxRow = Math.max(maxRow, r);
            minCol = Math.min(minCol, c);
            maxCol = Math.max(maxCol, c);
          }
        }
      }

      // Додаємо відступ
      minRow = Math.max(0, minRow - 1);
      maxRow = Math.min(crosswordSize - 1, maxRow + 1);
      minCol = Math.max(0, minCol - 1);
      maxCol = Math.min(crosswordSize - 1, maxCol + 1);

      // Створюємо номери для клітинок
      const cellNumbers = {};
      placedWords.forEach((word, index) => {
        const key = `${word.row}-${word.col}`;
        if (!cellNumbers[key]) {
          cellNumbers[key] = index + 1;
        }
      });

      // Рендеримо сітку
      const gridContainer = document.getElementById('crossword-grid');
      let html = '<table>';

      for (let r = minRow; r <= maxRow; r++) {
        html += '<tr>';
        for (let c = minCol; c <= maxCol; c++) {
          const cell = crosswordGrid[r][c];
          const key = `${r}-${c}`;
          const number = cellNumbers[key] || '';

          if (cell !== null) {
            html += `<td class="crossword-cell">
              ${number ? `<span class="cell-number">${number}</span>` : ''}
              <input type="text" maxlength="1" data-row="${r}" data-col="${c}"
                     onkeyup="handleCrosswordInput(event, this)"
                     autocomplete="off" autocorrect="off" autocapitalize="off">
            </td>`;
          } else {
            html += '<td class="crossword-cell empty"></td>';
          }
        }
        html += '</tr>';
      }
      html += '</table>';
      gridContainer.innerHTML = html;

      // Рендеримо підказки
      const acrossClues = document.getElementById('across-clues');
      const downClues = document.getElementById('down-clues');

      let acrossHtml = '';
      let downHtml = '';

      placedWords.forEach((word, index) => {
        const clue = `<li><strong>${index + 1}.</strong> ${word.translation}</li>`;
        if (word.direction === 'across') {
          acrossHtml += clue;
        } else {
          downHtml += clue;
        }
      });

      acrossClues.innerHTML = acrossHtml || '<li>Немає слів</li>';
      downClues.innerHTML = downHtml || '<li>Немає слів</li>';
    }

    function handleCrosswordInput(event, input) {
      // Перетворюємо на велику літеру
      input.value = input.value.toUpperCase();

      // Переходимо до наступної клітинки при введенні
      if (input.value && event.key !== 'Backspace') {
        const inputs = document.querySelectorAll('.crossword-cell input');
        const inputsArray = Array.from(inputs);
        const currentIndex = inputsArray.indexOf(input);

        if (currentIndex < inputsArray.length - 1) {
          inputsArray[currentIndex + 1].focus();
        }
      }

      // Переходимо до попередньої клітинки при Backspace
      if (event.key === 'Backspace' && !input.value) {
        const inputs = document.querySelectorAll('.crossword-cell input');
        const inputsArray = Array.from(inputs);
        const currentIndex = inputsArray.indexOf(input);

        if (currentIndex > 0) {
          inputsArray[currentIndex - 1].focus();
        }
      }
    }

    function checkCrossword() {
      const inputs = document.querySelectorAll('.crossword-cell input');
      let allCorrect = true;
      let allFilled = true;

      inputs.forEach(input => {
        const row = parseInt(input.dataset.row);
        const col = parseInt(input.dataset.col);
        const correctLetter = crosswordGrid[row][col];
        const userLetter = input.value.toUpperCase();

        // Скидаємо попередні класи
        input.classList.remove('correct', 'incorrect');

        if (!userLetter) {
          allFilled = false;
        } else if (userLetter === correctLetter) {
          input.classList.add('correct');
        } else {
          input.classList.add('incorrect');
          allCorrect = false;
        }
      });

      if (!allFilled) {
        alert('Заповніть всі клітинки!');
      } else if (allCorrect) {
        alert('Вітаємо! Кросворд розгадано правильно! 🎉');
      } else {
        alert('Є помилки. Неправильні літери позначено червоним.');
      }
    }
    // ============ Кінець кросворда ============

    function updateSadCatVisibility() {
      if (allWords.length === 0) {
        document.getElementById('add-word-from-my-vocabulary').classList.remove('hidden');
      } else {
        document.getElementById('add-word-from-my-vocabulary').classList.add('hidden');
      }
    }

    function showListeningResult() {
      const listeningContainer = document.getElementById('listening-quiz-container');
      listeningContainer.innerHTML = `
    <div class="quiz-result">
      ${listeningCorrectFeedback()}
      <button onclick="finishListening()">Завершити тренування</button>
    </div>
  `;
    }

    function listeningCorrectFeedback() {
      if (listeningCorrectAnswers <= 4) {
        return `<img src="https://img.icons8.com/emoji/96/000000/sad-emoji.png" alt="Сумний емодзі"><p>Не погано, але є місце для покращення.</p>`;
      } else if (listeningCorrectAnswers <= 7) {
        return `<img src="https://img.icons8.com/emoji/96/000000/neutral-emoji.png" alt="Нейтральний емодзі"><p>Добре! Але можна краще.</p>`;
      } else {
        return `<img src="https://img.icons8.com/emoji/96/000000/smiling-face-with-sunglasses.png" alt="Щасливий емодзі"><p>Відмінно! Ви чудово знаєте ці слова.</p>`;
      }
    }

    function finishListening() {
      backToAccount();
      // Скидання результатів слухання
      listeningCorrectAnswers = 0;
      currentListeningQuestion = 0;
      initializeListeningTraining();
    }

    function deleteLastLetter() {
      if (constructedWord.length === 0) return;
      const lastLetter = constructedWord.slice(-1);
      constructedWord = constructedWord.slice(0, -1);
      document.getElementById('constructor-answer').value = constructedWord;
      // Увеличение количества доступных букв
      const letterButton = document.querySelector(`button[data-letter='${lastLetter}']`);
      let remainingCount = parseInt(letterButton.getAttribute('data-count')) + 1;
      const initialCount = parseInt(letterButton.getAttribute('data-initial-count'));
      if (remainingCount <= initialCount) {
        letterButton.setAttribute('data-count', remainingCount);
        // Обновление текста кнопки
        const displayText = remainingCount > 1 ? `${lastLetter} (${remainingCount})` : lastLetter;
        letterButton.textContent = displayText;
        // Включение кнопки
        letterButton.disabled = false;
      }
    }

    function showConstructorResult() {
      const constructorContainer = document.getElementById('word-constructor-quiz-container');
      const constructorProgress = document.getElementById('constructor-progress');
      const constructorResult = `
    <div class="constructor-quiz-result">
      ${constructorCorrectFeedback()}
      <button class="finish-button" onclick="finishConstructor()">Завершити тренування</button>
    </div>
  `;
      constructorContainer.innerHTML = constructorResult;
      constructorProgress.classList.add('hidden');
    }

    function constructorCorrectFeedback() {
      if (constructorCorrectAnswers <= 4) {
        return `<img src="https://img.icons8.com/emoji/96/000000/sad-emoji.png" alt="Сумний емодзі"><p>Не погано, але є місце для покращення.</p>`;
      } else if (constructorCorrectAnswers <= 7) {
        return `<img src="https://img.icons8.com/emoji/96/000000/neutral-emoji.png" alt="Нейтральний емодзі"><p>Добре! Але можна краще.</p>`;
      } else {
        return `<img src="https://img.icons8.com/emoji/96/000000/smiling-face-with-sunglasses.png" alt="Щасливий емодзі"><p>Відмінно! Ви чудово створюєте слова.</p>`;
      }
    }

    function finishConstructor() {
      // Скрываем результаты и показываем главный экран
      document.getElementById('constructor-quiz-result').classList.add('hidden');
      document.getElementById('word-constructor-quiz-container').classList.add('hidden');
      document.getElementById('constructor-progress').classList.add('hidden');
      // Сброс результатов
      constructorCorrectAnswers = 0;
      currentConstructorQuestion = 0;
      backToAccount();
    }
    // Оновлення залишку днів підписки в реальному часі
    function startSubscriptionTimer(subscriptionExpiration) {
      function updateDaysLeft() {
        const currentDate = new Date();
        const timeDiff = subscriptionExpiration - currentDate;
        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        if (daysLeft > 0) {
          document.getElementById('subscription-info').textContent =
            `Залишилось днів підписки: ${daysLeft}`;
        } else {
          clearInterval(timer);
          document.getElementById('account-screen').classList.add('hidden');
          document.getElementById('payment-section').classList.remove('hidden');
        }
      }
      updateDaysLeft(); // Початкове оновлення
      const timer = setInterval(updateDaysLeft, 24 * 60 * 60 * 1000); // Оновлення щодня
    }
    // Функція для показу секції Генеративний текст
    function startGenerativeTextTraining() {
  toggleMainTitle();
  fetchWords(); // Додано цей рядок для завантаження слів
  document.getElementById('account-screen').classList.add('hidden');
  document.getElementById('generative-text-section').classList.remove('hidden');
  document.getElementById('generated-story').classList.add('hidden');
  document.getElementById('story-text').textContent = '';
  document.getElementById('story-title').textContent = '';

  // Загружаем сохраненные настройки из localStorage
  const textStyleButton = document.querySelector('.option-button[onclick*="text-style"]');
  const textDifficultyButton = document.querySelector('.option-button[onclick*="text-difficulty"]');
  const textLengthButton = document.querySelector('.option-button[onclick*="text-length"]');

  const optionIcons = {
    'Пригоди': 'fa-compass',
    'Містика': 'fa-ghost',
    'Романтика': 'fa-heart',
    'Наукова фантастика': 'fa-rocket',
    'Гумор': 'fa-face-laugh',
    'Повсякденне спілкування': 'fa-comments',
    'Легкий': 'fa-seedling',
    'Середній': 'fa-leaf',
    'Складний': 'fa-tree',
    'Короткий (250 символів)': 'fa-minus',
    'Середній (500 символів)': 'fa-bars',
    'Довгий (1200 символів)': 'fa-align-justify'
  };

  const savedStyle = localStorage.getItem('text-style');
  const savedDifficulty = localStorage.getItem('text-difficulty');
  const savedLength = localStorage.getItem('text-length');

  if (savedStyle) {
    const icon = optionIcons[savedStyle] || '';
    textStyleButton.innerHTML = icon ? `<i class="fas ${icon}"></i> ${savedStyle}` : savedStyle;
    textStyleButton.dataset.value = savedStyle;
  }
  if (savedDifficulty) {
    const icon = optionIcons[savedDifficulty] || '';
    textDifficultyButton.innerHTML = icon ? `<i class="fas ${icon}"></i> ${savedDifficulty}` : savedDifficulty;
    textDifficultyButton.dataset.value = savedDifficulty;
  }
  if (savedLength) {
    const icon = optionIcons[savedLength] || '';
    textLengthButton.innerHTML = icon ? `<i class="fas ${icon}"></i> ${savedLength}` : savedLength;
    textLengthButton.dataset.value = savedLength;
  }

  // Проверяем наличие сохранённой истории в Local Storage
  const storedTitle = localStorage.getItem("generatedStoryTitle");
  const storedText = localStorage.getItem("generatedStoryText");

  if (storedTitle && storedText) {
    // Вставляем данные в элементы
    document.getElementById('story-title').innerHTML = storedTitle;
    document.getElementById('story-text').innerHTML = storedText;

    // Показываем блок с историей
    document.getElementById('generated-story').classList.remove('hidden');
    document.getElementById('story-actions').classList.remove('hidden'); // Отображаем кнопки
    document.querySelector('.generate').disabled = true; // Отключаем кнопку генерации
    document.querySelector('.generate').style.display = 'none'; // Прячем кнопку генерации

    // Скрываем конфигурацию
    document.querySelectorAll('.title-wrapper').forEach(el => el.style.display = 'none');
  } else {
    // Если данных нет, показываем конфигурацию
    document.querySelectorAll('.title-wrapper').forEach(el => el.style.display = 'flex');
    document.querySelector('.generate').disabled = false;
    document.querySelector('.generate').style.display = 'inline-block';
    console.log("Сохранённой истории в Local Storage нет.");
  }
}
async function generateStory() {
  const textStyleButton = document.querySelector('.option-button[onclick*="text-style"]');
  const textDifficultyButton = document.querySelector('.option-button[onclick*="text-difficulty"]');
  const textLengthButton = document.querySelector('.option-button[onclick*="text-length"]');

  const selectedStyle = textStyleButton.dataset.value;
  const selectedDifficulty = textDifficultyButton.dataset.value;
  const selectedLength = textLengthButton.dataset.value;

  if (!selectedStyle || !selectedDifficulty || !selectedLength) {
    showNotification('Будь ласка, заповніть всі налаштування.', 'warning');
    return;
  }

  if (allWords.length === 0) {
    showNotification('У вашому словнику немає слів для генерації історії.', 'warning');
    return;
  }

  let wordCount, maxTokens;
  let targetChars = 250;
  if (selectedLength.includes('Короткий')) {
    wordCount = 5;
    maxTokens = 150;
    targetChars = 250;
  } else if (selectedLength.includes('Середній')) {
    wordCount = 7;
    maxTokens = 250;
    targetChars = 500;
  } else if (selectedLength.includes('Довгий')) {
    wordCount = 10;
    maxTokens = 500;
    targetChars = 1200;
  } else {
    showNotification('Невідомий формат довжини тексту.', 'warning');
    return;
  }

  const selectedWords = getEnglishWords(allWords, wordCount);
  if (selectedWords.length < wordCount) {
    showNotification('Не вдалося вибрати достатню кількість слів для генерації.', 'warning');
    return;
  }
  const wordList = selectedWords.join(', ');

  const promptText = `Generate a narrative story in English, in the style of "${selectedStyle}", with "${selectedDifficulty}" difficulty, approximately ${targetChars} characters long, incorporating the following words: ${wordList}. Also, generate a short title for the story. The output must be valid HTML, structured exactly as follows:
  <div class="generative-text">
    <h3>[Title of the story]</h3>
    <p>
      [Narrative text here, with each of the specified words wrapped in <span class="highlight">...</span> tags.]
    </p>
  </div>
  Ensure that:
  1. The entire output is enclosed within the <div class="generative-text">...</div> block.
  2. Inside the <div>, there is one <h3> element containing the title, and one <p> element containing the narrative.
  3. Each occurrence of the specified words in the narrative is wrapped in a <span class="highlight">...</span> tag.
  4. No additional HTML elements or text are included outside of the specified structure.
  5. The HTML is properly formatted and valid.
  6. The story text (without HTML tags) should be approximately ${targetChars} characters long.`;

  // Показываем прелоадер
  document.querySelector('.generate .spinner').classList.remove('hidden');
  document.querySelector('.generate span').classList.add('hidden');
  document.getElementById('generated-story').classList.add('hidden');
  document.getElementById('story-text').textContent = '';
  document.getElementById('story-title').textContent = '';

  const url = 'https://api.openai.com/v1/chat/completions';
  const options = {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${openaiApiKey}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      messages: [{ role: 'user', content: promptText }],
      model: 'gpt-4o-mini',
      temperature: 0.9,
      max_tokens: maxTokens,
    }),
  };

  try {
    const response = await fetch(url, options);
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP error! статус: ${response.status}, повідомлення: ${errorText || 'Не відома помилка'}`);
    }
    const result = await response.json();
    let storyHTML = 'Немає згенерованого тексту.';
    if (result.choices && result.choices[0] && result.choices[0].message && result.choices[0].message.content) {
      storyHTML = result.choices[0].message.content;
    }

    // Парсинг HTML для отримання заголовка та історії
    const parser = new DOMParser();
    const doc = parser.parseFromString(storyHTML, 'text/html');
    const div = doc.querySelector('.generative-text');
    if (div) {
      const titleElement = div.querySelector('h3');
      const storyElement = div.querySelector('p');
      if (titleElement && storyElement) {
        document.getElementById('story-title').innerHTML = titleElement.innerHTML;
        document.getElementById('story-text').innerHTML = storyElement.innerHTML;
      } else {
        document.getElementById('story-text').innerHTML = 'Невдала генерація тексту.';
      }
    } else {
      document.getElementById('story-text').innerHTML = 'Невдала генерація тексту.';
    }

    // Скрываем прелоадер, показываем блок з історією
    document.querySelector('.generate .spinner').classList.add('hidden');
    document.querySelector('.generate span').classList.remove('hidden');
    document.getElementById('generated-story').classList.remove('hidden');

    // Деактивуємо кнопки конфігурації та генерації
    document.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);
    document.querySelector('.generate').disabled = true;
    document.querySelector('.generate').style.display = 'none';

    // Зберігаємо історію в Local Storage
    localStorage.setItem("generatedStoryTitle", document.getElementById('story-title').innerHTML);
    localStorage.setItem("generatedStoryText", document.getElementById('story-text').innerHTML);

    // Ховаємо блоки конфігурації (наприклад, блоки з класом "title-wrapper")
    document.querySelectorAll('.title-wrapper').forEach(el => el.style.display = 'none');

    // Відображаємо блок дій (копіювання, озвучення, переклад, прочитано)
    document.getElementById('story-actions').classList.remove('hidden');

  } catch (error) {
    console.error('Помилка при генерації історії:', error);
    document.querySelector('.generate .spinner').classList.add('hidden');
    document.querySelector('.generate span').classList.remove('hidden');
    showNotification('Сталася помилка при генерації історії. Спробуйте пізніше.', 'warning');
  }
}


    async function translateText(text, sourceLang, targetLang, wordsToHighlight = []) {
      const langNames = {
        'en': 'English',
        'uk': 'Ukrainian'
      };
      const sourceName = langNames[sourceLang] || sourceLang;
      const targetName = langNames[targetLang] || targetLang;

      const url = 'https://api.openai.com/v1/chat/completions';

      let systemPrompt = `You are a translator. Translate the following text from ${sourceName} to ${targetName}.`;

      if (wordsToHighlight.length > 0) {
        systemPrompt += ` The following English words are important and their Ukrainian translations should be wrapped in <span class="highlight">...</span> tags: ${wordsToHighlight.join(', ')}. Return the translated text with these highlight tags.`;
      } else {
        systemPrompt += ` Return only the translation, nothing else.`;
      }

      try {
        const response = await axios.post(url, {
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: systemPrompt
            },
            {
              role: 'user',
              content: text
            }
          ],
          temperature: 0.3
        }, {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openaiApiKey}`,
          },
          timeout: 30000
        });

        if (response.data?.choices?.[0]?.message?.content) {
          return response.data.choices[0].message.content.trim();
        }
        throw new Error('Invalid response from OpenAI');
      } catch (error) {
        console.error('OpenAI translation failed:', error);
        throw error;
      }
    }

    // ============ Вставте пропущене слово ============
    let fillBlanksMode = ''; // 'ukrainian' або 'english'
    let fillBlanksData = []; // Масив об'єктів {sentence, word, translation}
    let selectedWord = null; // Поточне вибране слово

    function startFillBlanksTraining() {
      closeAllInfoPopups();
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('fill-blanks-section').classList.remove('hidden');
      resetFillBlanksTraining();
    }

    function resetFillBlanksTraining() {
      fillBlanksMode = '';
      fillBlanksData = [];
      selectedWord = null;
      document.getElementById('fill-blanks-mode-selection').classList.remove('hidden');
      document.getElementById('fill-blanks-training').classList.add('hidden');
      document.getElementById('fill-blanks-loader').classList.add('hidden');
      document.getElementById('fill-blanks-result').classList.add('hidden');
    }

    function openFillBlanksInfoPopup() {
      showInfoPopup(
        'Вставте слово',
        'Заповніть пропуски в реченнях правильними словами. AI генерує речення з вашими словами.',
        [
          'Алгоритм обирає 10 слів зі словника.',
          'Спочатку використовуються нові слова (менше 3 взаємодій).',
          'Якщо нових слів недостатньо, додаються слова від складних до простих.',
          'Складність визначається відсотком правильних відповідей.'
        ]
      );
    }

    function closeFillBlanksInfoPopup() {
      document.getElementById('fillBlanksInfoPopup').classList.remove('show');
      document.querySelector('.overlay').classList.add('hidden');
    }

    async function selectFillBlanksMode(mode) {
      fillBlanksMode = mode;
      document.getElementById('fill-blanks-mode-selection').classList.add('hidden');
      document.getElementById('fill-blanks-loader').classList.remove('hidden');

      try {
        await generateFillBlanksSentences();
      } catch (error) {
        console.error('Помилка генерації речень:', error);
        const errorMsg = error.message || 'Невідома помилка';
        showNotification(`Помилка: ${errorMsg}. Спробуйте ще раз.`, 'warning');
        resetFillBlanksTraining();
      }
    }

    async function generateFillBlanksSentences() {
      const userId = auth.currentUser.uid;
      const querySnapshot = await db.collection('users').doc(userId).collection('words').get();

      if (querySnapshot.size < 10) {
        showNotification('Потрібно мінімум 10 слів у словнику для цього тренування.', 'warning');
        resetFillBlanksTraining();
        return;
      }

      let wordsArray = [];
      querySnapshot.forEach(doc => {
        const wordData = doc.data();
        wordsArray.push({
          english: doc.id,
          translation: wordData.translation,
          interactions: wordData.interactions || 0,
          correctAnswers: wordData.correctAnswers || 0
        });
      });

      // Розділення слів на нові та вже взаємодіяли (як у Тестуванні)
      const newWords = wordsArray.filter(word => word.interactions <= 3);
      const interactedWords = wordsArray.filter(word => word.interactions > 3);

      // Сортування взаємодіяних слів від найскладніших до найпростіших
      interactedWords.sort((a, b) => {
        const aRatio = a.correctAnswers / a.interactions;
        const bRatio = b.correctAnswers / b.interactions;
        return aRatio - bRatio;
      });

      // Об'єднання: спочатку нові, потім складні
      const sortedWords = [...newWords, ...interactedWords];
      const selectedWords = sortedWords.slice(0, 10);

      // Формуємо промпт для AI
      const wordPairs = selectedWords.map(w => `${w.english} (${w.translation})`).join(', ');

      let promptText;
      if (fillBlanksMode === 'ukrainian') {
        promptText = `Generate 10 sentences in Ukrainian where each sentence uses one of these English words: ${wordPairs}.
The English word should be naturally incorporated into the Ukrainian sentence and will be the blank.
Return ONLY a valid JSON array with exactly 10 objects in this format:
[
  {"sentence": "Ukrainian sentence with ___ for blank", "word": "english_word", "translation": "ukrainian_translation"},
  ...
]
Replace the English word position with "___" (three underscores) in the sentence.
Example: If word is "apple" (яблуко), sentence could be "Я з'їв смачне ___ на сніданок."
Make sentences diverse and interesting. Return ONLY the JSON array, no other text.`;
      } else {
        promptText = `Generate 10 sentences in English where each sentence has one missing word from this list: ${wordPairs}.
Return ONLY a valid JSON array with exactly 10 objects in this format:
[
  {"sentence": "English sentence with ___ for blank", "word": "english_word", "translation": "ukrainian_translation"},
  ...
]
Replace the missing word position with "___" (three underscores) in the sentence.
Example: If word is "apple", sentence could be "I ate a delicious ___ for breakfast."
Make sentences diverse and interesting. Return ONLY the JSON array, no other text.`;
      }

      const url = 'https://api.openai.com/v1/chat/completions';
      const options = {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${openaiApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [{ role: 'user', content: promptText }],
          model: 'gpt-4o-mini',
          temperature: 0.7,
          max_tokens: 2000,
        }),
      };

      console.log('Sending request to AI...');
      const response = await fetch(url, options);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Error:', response.status, errorText);
        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
      }

      const result = await response.json();
      console.log('AI Response:', result);

      let content = result.choices?.[0]?.message?.content || '';

      if (!content) {
        console.error('Empty content from AI');
        throw new Error('AI повернув порожню відповідь');
      }

      // Очищуємо відповідь від можливих markdown блоків
      content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      console.log('Cleaned content:', content);

      try {
        fillBlanksData = JSON.parse(content);
        if (!Array.isArray(fillBlanksData) || fillBlanksData.length === 0) {
          throw new Error('Invalid response format');
        }
        console.log('Parsed data:', fillBlanksData);
      } catch (e) {
        console.error('Parse error:', e, 'Content:', content);
        throw new Error('Не вдалося розпізнати відповідь AI');
      }

      // Показуємо тренування
      document.getElementById('fill-blanks-loader').classList.add('hidden');
      document.getElementById('fill-blanks-training').classList.remove('hidden');
      renderFillBlanksTraining();
    }

    function renderFillBlanksTraining() {
      // Рендеримо банк слів
      const wordBank = document.getElementById('fill-blanks-word-bank');
      const shuffledWords = [...fillBlanksData].sort(() => 0.5 - Math.random());

      wordBank.innerHTML = shuffledWords.map(item =>
        `<div class="fill-blanks-word" data-word="${item.word}" onclick="selectFillBlanksWord(this)">${item.word}</div>`
      ).join('');

      // Рендеримо речення
      const sentencesContainer = document.getElementById('fill-blanks-sentences');
      sentencesContainer.innerHTML = fillBlanksData.map((item, index) => {
        const sentenceHtml = item.sentence.replace('___',
          `<span class="fill-blank" data-answer="${item.word}" data-index="${index}" onclick="clickFillBlank(this)"></span>`
        );
        return `
          <div class="fill-blanks-sentence">
            <span class="sentence-number">${index + 1}</span>
            ${sentenceHtml}
          </div>
        `;
      }).join('');
    }

    function selectFillBlanksWord(element) {
      const word = element.dataset.word;

      // Якщо слово вже використане, ігноруємо
      if (element.classList.contains('used')) return;

      // Знімаємо виділення з попереднього слова
      document.querySelectorAll('.fill-blanks-word.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // Якщо клікнули на те ж саме слово - знімаємо виділення
      if (selectedWord === word) {
        selectedWord = null;
        return;
      }

      // Виділяємо нове слово
      element.classList.add('selected');
      selectedWord = word;

      // Активуємо всі порожні пропуски
      document.querySelectorAll('.fill-blank:not(.filled)').forEach(blank => {
        blank.classList.add('active');
      });
    }

    function clickFillBlank(element) {
      // Якщо пропуск вже заповнений - видаляємо слово
      if (element.classList.contains('filled')) {
        const wordInBlank = element.dataset.currentWord;
        element.innerHTML = '';
        element.classList.remove('filled');
        element.dataset.currentWord = '';

        // Повертаємо слово в банк
        const wordElement = document.querySelector(`.fill-blanks-word[data-word="${wordInBlank}"]`);
        if (wordElement) {
          wordElement.classList.remove('used');
        }
        return;
      }

      // Якщо слово не вибране - нічого не робимо
      if (!selectedWord) return;

      // Вставляємо слово з анімацією
      element.innerHTML = `<span class="blank-word">${selectedWord}</span><span class="remove-word">×</span>`;
      element.classList.add('filled', 'animating');
      element.dataset.currentWord = selectedWord;

      // Позначаємо слово як використане
      const wordElement = document.querySelector(`.fill-blanks-word[data-word="${selectedWord}"]`);
      if (wordElement) {
        wordElement.classList.remove('selected');
        wordElement.classList.add('used');
      }

      // Знімаємо активний стан з пропусків
      document.querySelectorAll('.fill-blank.active').forEach(blank => {
        blank.classList.remove('active');
      });

      // Скидаємо вибране слово
      selectedWord = null;

      // Прибираємо клас анімації після завершення
      setTimeout(() => {
        element.classList.remove('animating');
      }, 400);
    }

    function checkFillBlanksAnswers() {
      let correctCount = 0;
      const blanks = document.querySelectorAll('.fill-blank');

      blanks.forEach(blank => {
        const answer = blank.dataset.answer;
        const userAnswer = blank.dataset.currentWord || '';

        blank.classList.remove('correct', 'incorrect');

        if (userAnswer.toLowerCase() === answer.toLowerCase()) {
          blank.classList.add('correct');
          correctCount++;
        } else {
          blank.classList.add('incorrect');
          // Показуємо правильну відповідь
          if (!blank.classList.contains('filled')) {
            blank.innerHTML = `<span class="blank-word" style="color:#ef4444">${answer}</span>`;
            blank.classList.add('filled');
          }
        }
      });

      // Оновлюємо статистику слів
      fillBlanksData.forEach(item => {
        const blank = document.querySelector(`.fill-blank[data-answer="${item.word}"]`);
        const isCorrect = blank && blank.classList.contains('correct');
        updateWordStats(item.word, isCorrect);
      });

      // Показуємо результат через невелику затримку
      setTimeout(() => {
        showFillBlanksResult(correctCount);
      }, 1500);
    }

    function showFillBlanksResult(correctCount) {
      document.getElementById('fill-blanks-training').classList.add('hidden');
      document.getElementById('fill-blanks-result').classList.remove('hidden');

      const total = fillBlanksData.length;
      const emoji = document.getElementById('fill-blanks-emoji');
      const resultText = document.getElementById('fill-blanks-result-text');

      let iconClasses = '';
      let text = '';

      if (correctCount <= 4) {
        iconClasses = 'fas fa-sad-tear';
        text = 'Не погано, але є куди рости!';
      } else if (correctCount <= 7) {
        iconClasses = 'fas fa-meh';
        text = 'Добрий результат! Продовжуйте практикуватись.';
      } else {
        iconClasses = 'fas fa-grin-stars';
        text = 'Чудово! Ви відмінно знаєте ці слова!';
      }

      emoji.className = iconClasses;
      resultText.textContent = `Правильних відповідей: ${correctCount} з ${total}. ${text}`;
    }

    function finishFillBlanks() {
      document.getElementById('fill-blanks-section').classList.add('hidden');
      document.getElementById('account-screen').classList.remove('hidden');
      toggleMainTitle();
      resetFillBlanksTraining();
    }

    // ============ Вгадай слово (Definition Quiz) ============
    let definitionQuizMode = '';
    let definitionQuizData = [];
    let currentDefinitionQuestion = 0;
    let definitionCorrectAnswers = 0;

    function startDefinitionQuiz() {
      closeAllInfoPopups();
      toggleMainTitle();
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('definition-quiz-section').classList.remove('hidden');
      resetDefinitionQuiz();
    }

    function resetDefinitionQuiz() {
      definitionQuizMode = '';
      definitionQuizData = [];
      currentDefinitionQuestion = 0;
      definitionCorrectAnswers = 0;
      document.getElementById('definition-quiz-mode-selection').classList.remove('hidden');
      document.getElementById('definition-quiz-training').classList.add('hidden');
      document.getElementById('definition-quiz-loader').classList.add('hidden');
      document.getElementById('definition-quiz-result').classList.add('hidden');
      document.getElementById('definition-quiz-progress').classList.add('hidden');
    }

    function openDefinitionQuizInfoPopup() {
      showInfoPopup(
        'Опис тренування:',
        'Вгадайте слово за його поясненням. Пояснення описує слово без згадування самого слова.',
        [
          'Спочатку обираються нові слова (з якими було ≤3 взаємодій).',
          'Потім додаються складні слова (з найнижчим % правильних відповідей).',
          'Алгоритм обирає до 10 слів для тренування.',
          'AI генерує короткі пояснення для кожного слова.',
          'Ви обираєте правильне слово з 4 варіантів.'
        ]
      );
    }

    async function selectDefinitionQuizMode(mode) {
      definitionQuizMode = mode;
      document.getElementById('definition-quiz-mode-selection').classList.add('hidden');
      document.getElementById('definition-quiz-loader').classList.remove('hidden');

      try {
        await generateDefinitions();
      } catch (error) {
        console.error('Помилка генерації пояснень:', error);
        showNotification(`Помилка: ${error.message || 'Невідома помилка'}. Спробуйте ще раз.`, 'warning');
        resetDefinitionQuiz();
      }
    }

    async function generateDefinitions() {
      // Перевіряємо чи завантажений API ключ
      if (!openaiApiKey) {
        await loadOpenAIKey();
        if (!openaiApiKey) {
          showNotification('API ключ не знайдено. Перевірте налаштування.', 'warning');
          resetDefinitionQuiz();
          return;
        }
      }

      const userId = auth.currentUser.uid;
      const querySnapshot = await db.collection('users').doc(userId).collection('words').get();

      if (querySnapshot.size < 10) {
        showNotification('Потрібно мінімум 10 слів у словнику для цього тренування.', 'warning');
        resetDefinitionQuiz();
        return;
      }

      let wordsArray = [];
      querySnapshot.forEach(doc => {
        const wordData = doc.data();
        wordsArray.push({
          english: doc.id,
          translation: wordData.translation,
          interactions: wordData.interactions || 0,
          correctAnswers: wordData.correctAnswers || 0
        });
      });

      // Розділення слів на нові та вже взаємодіяли (як у Тестуванні)
      const newWords = wordsArray.filter(word => word.interactions <= 3);
      const interactedWords = wordsArray.filter(word => word.interactions > 3);

      // Сортування взаємодіяних слів від найскладніших до найпростіших
      interactedWords.sort((a, b) => {
        const aRatio = a.correctAnswers / a.interactions;
        const bRatio = b.correctAnswers / b.interactions;
        return aRatio - bRatio;
      });

      // Об'єднання: спочатку нові, потім складні
      const sortedWords = [...newWords, ...interactedWords];
      const selectedWords = sortedWords.slice(0, 10);
      const allWordsForOptions = wordsArray.slice(0, 40); // Для варіантів відповідей

      const wordList = selectedWords.map(w => `${w.english} (${w.translation})`).join(', ');

      let promptText;
      if (definitionQuizMode === 'english') {
        promptText = `Generate short definitions in English for these words: ${wordList}.
Each definition should explain the word WITHOUT using the word itself or its direct translation.
Keep definitions short (1 sentence, max 15 words).
Return ONLY a valid JSON array:
[
  {"word": "english_word", "translation": "ukrainian_translation", "definition": "short definition in English"},
  ...
]
Return ONLY the JSON array, no other text.`;
      } else {
        promptText = `Generate short definitions in Ukrainian for these words: ${wordList}.
Each definition should explain the word WITHOUT using the word itself or its English equivalent.
Keep definitions short (1 sentence, max 15 words).
Return ONLY a valid JSON array:
[
  {"word": "english_word", "translation": "ukrainian_translation", "definition": "short definition in Ukrainian"},
  ...
]
Return ONLY the JSON array, no other text.`;
      }

      console.log('API key before fetch:', openaiApiKey ? 'Key exists, length: ' + openaiApiKey.length + ', starts with: ' + openaiApiKey.substring(0, 10) : 'NULL');

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${openaiApiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'You are a helpful assistant that generates word definitions. Return only valid JSON.' },
            { role: 'user', content: promptText }
          ],
          temperature: 0.7,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      let content = data.choices[0].message.content.trim();

      // Очищуємо від markdown
      content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

      try {
        definitionQuizData = JSON.parse(content);
        if (!Array.isArray(definitionQuizData) || definitionQuizData.length === 0) {
          throw new Error('Invalid response format');
        }

        // Додаємо варіанти відповідей для кожного питання
        definitionQuizData.forEach(item => {
          const otherWords = allWordsForOptions.filter(w => w.english !== item.word);
          const shuffledOthers = otherWords.sort(() => 0.5 - Math.random()).slice(0, 3);
          const options = [
            { word: item.word, translation: item.translation, correct: true },
            ...shuffledOthers.map(w => ({ word: w.english, translation: w.translation, correct: false }))
          ];
          item.options = options.sort(() => 0.5 - Math.random());
        });

      } catch (e) {
        console.error('Parse error:', e, 'Content:', content);
        throw new Error('Не вдалося розпізнати відповідь AI');
      }

      document.getElementById('definition-quiz-loader').classList.add('hidden');
      document.getElementById('definition-quiz-training').classList.remove('hidden');
      document.getElementById('definition-quiz-progress').classList.remove('hidden');
      showDefinitionQuestion();
    }

    function showDefinitionQuestion() {
      if (currentDefinitionQuestion >= definitionQuizData.length) {
        showDefinitionQuizResult();
        return;
      }

      const item = definitionQuizData[currentDefinitionQuestion];
      const definitionBox = document.getElementById('definition-quiz-definition');
      const optionsContainer = document.getElementById('definition-quiz-options');

      definitionBox.innerHTML = `<i class="fas fa-quote-left" style="opacity: 0.5; margin-right: 10px;"></i>${item.definition}`;

      optionsContainer.innerHTML = item.options.map((opt, idx) =>
        `<button onclick="selectDefinitionAnswer(this, ${opt.correct}, ${idx})">${opt.word}</button>`
      ).join('');

      updateDefinitionProgress();
    }

    function selectDefinitionAnswer(button, isCorrect, optionIndex) {
      const buttons = document.querySelectorAll('#definition-quiz-options button');
      buttons.forEach(btn => btn.disabled = true);

      const currentItem = definitionQuizData[currentDefinitionQuestion];
      const selectedWord = currentItem.options[optionIndex].word;

      if (isCorrect) {
        button.classList.add('correct');
        definitionCorrectAnswers++;
      } else {
        button.classList.add('wrong');
        // Показуємо правильну відповідь
        buttons.forEach(btn => {
          if (btn.textContent.startsWith(currentItem.word)) {
            btn.classList.add('correct');
          }
        });
      }

      // Оновлюємо статистику слова
      updateWordStats(currentItem.word, isCorrect);

      setTimeout(() => {
        currentDefinitionQuestion++;
        showDefinitionQuestion();
      }, 1200);
    }

    function updateDefinitionProgress() {
      const progress = ((currentDefinitionQuestion) / definitionQuizData.length) * 100;
      document.getElementById('definition-quiz-progress-bar').style.width = `${progress}%`;
      document.getElementById('definition-quiz-question-number').textContent =
        `${currentDefinitionQuestion + 1} / ${definitionQuizData.length}`;
    }

    function showDefinitionQuizResult() {
      document.getElementById('definition-quiz-training').classList.add('hidden');
      document.getElementById('definition-quiz-progress').classList.add('hidden');
      document.getElementById('definition-quiz-result').classList.remove('hidden');

      const percentage = (definitionCorrectAnswers / definitionQuizData.length) * 100;
      const emoji = document.getElementById('definition-quiz-emoji');
      const resultText = document.getElementById('definition-quiz-result-text');

      let iconClasses, text;
      if (percentage >= 90) {
        iconClasses = 'fas fa-trophy';
        emoji.style.color = '#FFD700';
        text = 'Чудово! Ви відмінно знаєте слова!';
      } else if (percentage >= 70) {
        iconClasses = 'fas fa-smile';
        emoji.style.color = '#4CAF50';
        text = 'Добре! Продовжуйте в тому ж дусі!';
      } else if (percentage >= 50) {
        iconClasses = 'fas fa-meh';
        emoji.style.color = '#FF9800';
        text = 'Непогано, але є над чим працювати.';
      } else {
        iconClasses = 'fas fa-frown';
        emoji.style.color = '#F44336';
        text = 'Потрібно більше практики!';
      }

      emoji.className = iconClasses;
      resultText.textContent = `Правильних відповідей: ${definitionCorrectAnswers} з ${definitionQuizData.length}. ${text}`;
    }

    function finishDefinitionQuiz() {
      document.getElementById('definition-quiz-section').classList.add('hidden');
      document.getElementById('account-screen').classList.remove('hidden');
      toggleMainTitle();
      resetDefinitionQuiz();
    }

    function getEnglishWords(words, count) {
      const englishWords = words.map(wordObj => wordObj.english);
      const shuffled = englishWords.sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    // Функція для розкодування посилання та виведення масивів у консоль
    function decodeLink() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('adding_words')) {
        const encodedWords = urlParams.get('adding_words');
        try {
          // Decode and parse the words (format: 'eng1=ukr1;eng2=ukr2;...')
          const decodedParam = decodeURIComponent(encodedWords);
          const pairs = decodedParam.split(';');
          let sharedWords = [];
          pairs.forEach(pair => {
            const [eng, ukr] = pair.split('=');
            sharedWords.push({
              english: eng,
              translation: ukr
            });
          });

          // Check if the user is logged in
          if (auth.currentUser) {
            // Show popup with shared words
            showSharedWordsPopup(sharedWords);
          } else {
            // If not logged in, prompt the user to log in
            showNotification('Будь ласка, увійдіть у систему, щоб додати слова.', 'warning');
          }
        } catch (error) {
          console.error('Помилка при парсингу слів з посилання:', error);
          showNotification('Невірний формат поділених слів.', 'warning');
        }
      }
    }

    // Call decodeLink after authentication state is determined
    let decodeLinkCalled = false;
    auth.onAuthStateChanged(user => {
      updateUI();
      if (!decodeLinkCalled) {
        decodeLink();
        decodeLinkCalled = true;
      }
    });

    function loadUserProgress() {
      let dateAdded = null;
      let reportDate = new Date();
      const userId = auth.currentUser.uid;

      db.collection("users").doc(userId).collection("words").get()
        .then(snapshot => {
          let newWords = 0;
          let goodKnowledge = 0;
          let averageKnowledge = 0;
          let poorKnowledge = 0;

          snapshot.forEach(doc => {
            const word = doc.data();
            const iterations = word.interactions || 0;
            const correctAnswers = word.correctAnswers || 0;
            const accuracy = iterations > 0 ? (correctAnswers / iterations) * 100 : 0;

            // Выбираем диапазон дат
            if (!dateAdded || word.dateAdded.toDate() < dateAdded) {
              dateAdded = word.dateAdded.toDate();
            }

            // Считаем статистику
            if (iterations < 3) {
              newWords++;
            } else if (iterations >= 3 && accuracy > 90) {
              goodKnowledge++;
            } else if (iterations >= 3 && accuracy >= 60 && accuracy <= 90) {
              averageKnowledge++;
            } else if (iterations >= 3 && accuracy < 60) {
              poorKnowledge++;
            }
          });

          // Вставляем значения в плитки
          document.getElementById("newWords").innerText = newWords;
          document.getElementById("goodKnowledge").innerText = goodKnowledge;
          document.getElementById("averageKnowledge").innerText = averageKnowledge;
          document.getElementById("poorKnowledge").innerText = poorKnowledge;

          // Вставляем диапазон дат
          document.getElementById("dateRange").innerText =
            `Звіт за період: ${dateAdded.toLocaleDateString()} - ${reportDate.toLocaleDateString()}`;

          // Открываем попап
          document.getElementById("progressPopup").classList.remove("hidden");
        })
        .catch(error => {
          console.error("Ошибка при загрузке данных пользователя:", error);
        });
    }

    // Показ информации при клике на карточку
    function showInfo(type) {
      const info = {
        newWords: {
          title: "Нові слова",
          icon: "fas fa-star",
          description: "Слова, які мають менш ніж 3 взаємодії. Це слова, які ви нещодавно додали і ще не практикували достатньо."
        },
        goodKnowledge: {
          title: "Гарні знання",
          icon: "fas fa-trophy",
          description: "Слова з понад 90% правильних відповідей. Ви відмінно знаєте ці слова!"
        },
        averageKnowledge: {
          title: "Середні знання",
          icon: "fas fa-book-open",
          description: "Слова з 60-90% правильних відповідей. Потрібно ще трохи практики."
        },
        poorKnowledge: {
          title: "Погані знання",
          icon: "fas fa-redo",
          description: "Слова з менш ніж 60% правильних відповідей. Рекомендуємо більше практикувати ці слова."
        }
      };
      const data = info[type];
      showInfoPopup(data.title, data.description);
    }

    // Показ інформації про "Мої слова"
    function showMyWordsInfo() {
      showInfoPopup(
        'Мої слова',
        'Натисніть на будь-яке слово, щоб побачити детальну статистику: кількість взаємодій, відсоток правильних відповідей та приклад використання.'
      );
    }

    // Показ інформації про прогрес
    function showProgressInfo() {
      showInfoPopup(
        'Про звіт',
        'Цей звіт показує вашу статистику за останній тиждень. Натисніть на будь-яку картку, щоб дізнатися більше про категорію.'
      );
    }

    // Закриття попапу прогресу
    function closeProgressPopup() {
      document.getElementById("progressPopup").classList.add("hidden");
    }
  </script>
</body>

</html>